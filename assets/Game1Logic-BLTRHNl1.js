import{G as c,a as m}from"./Game1LogicSchema-SHqVCG07.js";import{B as p,a as g}from"./BaseDispatcher-CXAw-hAN.js";const d={INITIALIZE:{execute(n,t){n.applyConfig(t),n.setInitialized(!0)}},MOVEMENT:{execute(n,t){n.setMovement(t.vx,t.vy)}},TAKE_DAMAGE:{execute(n,t){const i=t.amount??15;n.modifyHp(-i)}}};class y extends p{dispatcher;hero={x:0,y:0,vx:0,vy:0,hp:100};rocks=[];currentFrame=0;lastHitFrame=0;wasMouseDown=!1;constructor(){super(c.REVISION),this.dispatcher=new g(this,d,"Game1")}applyConfig(t){if(this.config=t,this.hero.hp=t.initialHP,this.hero.x=t.heroStartX,this.hero.y=t.heroStartY,this.rocks.length===0)for(let i=0;i<t.spawnCount;i++)this.spawnRock()}setMovement(t,i){t!==void 0&&(this.hero.vx=t),i!==void 0&&(this.hero.vy=i)}modifyHp(t){this.hero.hp=Math.max(0,Math.min(100,this.hero.hp+t)),t<0&&this.triggerHitCooldown()}triggerHitCooldown(){this.lastHitFrame=this.currentFrame}destroy(){super.destroy(),this.rocks=[]}getSnapshot(){return{hero:{...this.hero},rocks:[...this.rocks],lastHitFrame:this.lastHitFrame,currentFrame:this.currentFrame,config:this.config}}loadSnapshot(t){t&&(this.config=t.config,this.hero=t.hero,this.rocks=t.rocks,this.lastHitFrame=t.lastHitFrame,this.currentFrame=t.currentFrame??0,this.isInitialized=!0)}onUpdate(t,i,e,h){if(!this.config)return;this.currentFrame=e;const s=this.inputState.actions,o=this.config.moveSpeed;let a=0,r=0;if(s.includes("MOVE_UP")&&(r=-o),s.includes("MOVE_DOWN")&&(r=o),s.includes("MOVE_LEFT")&&(a=-o),s.includes("MOVE_RIGHT")&&(a=o),this.setMovement(a,r),this.inputState.isMouseDown&&!this.wasMouseDown){const f=this.inputState.mouseX*this.config.width,u=this.inputState.mouseY*this.config.height;this.spawnRock(f,u)}this.wasMouseDown=this.inputState.isMouseDown,this.currentFrame-this.lastHitFrame>120&&this.hero.hp<100&&(this.hero.hp=Math.min(100,this.hero.hp+(this.hero.hp<25?.3:.1))),this.hero.x=Math.max(0,Math.min(this.config.width,this.hero.x+this.hero.vx)),this.hero.y=Math.max(0,Math.min(this.config.height,this.hero.y+this.hero.vy)),this.processRocks(e),this.syncToSAB(t,e,h)}spawnRock(t,i){if(!this.config)return;const e=this.sharedViews.get("rocks");if(!e)return;const h=Math.floor(e.length/m.STRIDE);if(this.rocks.length>=h){const s=e.length+1e3*m.STRIDE;this._resizeRequested!==s&&(console.log(`[Game1Logic] Requesting Resize. Current: ${e.length}, New: ${s}`),self.postMessage({type:"REQUEST_RESIZE",payload:{bufferName:"rocks",newSize:s}}),this._resizeRequested=s);return}this._resizeRequested=0,this.rocks.push({x:t??Math.random()*this.config.width,y:i??Math.random()*this.config.height,vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8,seed:Math.random()*1e3})}processRocks(t){if(this.config)for(let i=this.rocks.length-1;i>=0;i--){const e=this.rocks[i];e.x+=e.vx,e.y+=e.vy;let h=!1;(e.x<=0||e.x>=this.config.width)&&(e.vx*=-1,h=!0),(e.y<=0||e.y>=this.config.height)&&(e.vy*=-1,h=!0);const s=e.x-this.hero.x,o=e.y-this.hero.y;s*s+o*o<1600&&(e.vx*=-1.1,e.vy*=-1.1,this.modifyHp(-.2),h=!0,self.postMessage({type:"EVENT",name:"EXPLOSION_REQ"})),h&&Math.random()>.8&&this.spawnRock()}}syncToSAB(t,i,e){const h=this.sharedViews.get("main"),s=this.sharedViews.get("rocks");h&&(h[c.HERO_HP]=this.hero.hp,h[c.HERO_X]=this.hero.x,h[c.HERO_Y]=this.hero.y,h[c.ENTITY_COUNT]=this.rocks.length),s&&this.rocks.forEach((o,a)=>{const r=a*m.STRIDE;r+2<s.length&&(s[r]=o.x,s[r+1]=o.y,s[r+2]=o.seed)})}}export{y as Game1Logic};
//# sourceMappingURL=Game1Logic-BLTRHNl1.js.map
