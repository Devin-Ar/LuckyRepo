{"version":3,"file":"CampaignManager-BzEj4yem.js","sources":["../../src/core/managers/CampaignManager.ts"],"sourcesContent":["// src/core/managers/CampaignManager.ts\r\nimport { SharedSession } from \"../session/SharedSession\";\r\nimport { CampaignRegistry } from \"../registry/CampaignRegistry\";\r\nimport { StateManager } from \"./StateManager\";\r\nimport { ICampaignDefinition } from \"../interfaces/ICampaign\";\r\nimport { StateRegistry } from \"../registry/StateRegistry\";\r\nimport { FeatureEnum } from \"../../features/FeatureEnum\";\r\n\r\nexport class CampaignManager {\r\n    private static instance: CampaignManager;\r\n\r\n    private constructor() {\r\n    }\r\n\r\n    public static getInstance(): CampaignManager {\r\n        if (!CampaignManager.instance) {\r\n            CampaignManager.instance = new CampaignManager();\r\n        }\r\n        return CampaignManager.instance;\r\n    }\r\n\r\n    public startCampaign(campaignId: string) {\r\n        const def = CampaignRegistry.get(campaignId);\r\n        if (!def) {\r\n            console.error(`[CampaignManager] Could not find campaign: ${campaignId}`);\r\n            return;\r\n        }\r\n\r\n        console.log(`[CampaignManager] Starting Campaign: ${campaignId}`);\r\n\r\n        const session = SharedSession.getInstance();\r\n\r\n        session.clearSavableKeys();\r\n\r\n        session.set('campaign_id', campaignId);\r\n        session.set('campaign_step_index', 0);\r\n\r\n        this.loadCurrentStep(def, 0);\r\n    }\r\n\r\n    public completeCurrentStep() {\r\n        const session = SharedSession.getInstance();\r\n        const campaignId = session.get<string>('campaign_id');\r\n        let index = session.get<number>('campaign_step_index');\r\n\r\n        if (!campaignId || index === undefined) {\r\n            this.quitCampaign();\r\n            return;\r\n        }\r\n\r\n        const def = CampaignRegistry.get(campaignId);\r\n        if (!def) return;\r\n\r\n        index++;\r\n        session.set('campaign_step_index', index);\r\n\r\n        if (index >= def.steps.length) {\r\n            this.quitCampaign();\r\n        } else {\r\n            this.loadCurrentStep(def, index);\r\n        }\r\n    }\r\n\r\n    public retryCurrentStep() {\r\n        const session = SharedSession.getInstance();\r\n        const campaignId = session.get<string>('campaign_id');\r\n        const index = session.get<number>('campaign_step_index');\r\n\r\n        if (!campaignId || index === undefined) return;\r\n\r\n        const def = CampaignRegistry.get(campaignId);\r\n        if (!def) return;\r\n\r\n        console.log(`[CampaignManager] Retrying step ${index}`);\r\n        session.clearSavableKeys();\r\n\r\n        session.set('campaign_id', campaignId);\r\n        session.set('campaign_step_index', index);\r\n\r\n        this.loadCurrentStep(def, index);\r\n    }\r\n\r\n    public failCurrentStep(context?: any) {\r\n        const session = SharedSession.getInstance();\r\n        const campaignId = session.get<string>('campaign_id');\r\n        const index = session.get<number>('campaign_step_index');\r\n\r\n        if (!campaignId) {\r\n            console.error(\"No active campaign to fail.\");\r\n            this.quitCampaign();\r\n            return;\r\n        }\r\n\r\n        const def = CampaignRegistry.get(campaignId);\r\n        const step = def?.steps[index ?? -1];\r\n        const factory = step?.failFactory || def?.failFactory;\r\n\r\n        if (factory) {\r\n            console.log(`[CampaignManager] Campaign Failed. Loading Fail State.`);\r\n            const failState = factory(context);\r\n            StateManager.getInstance().replace(failState);\r\n        } else {\r\n            console.warn(\"No failFactory defined for this campaign. Quitting.\");\r\n            this.quitCampaign();\r\n        }\r\n    }\r\n\r\n    public quitCampaign() {\r\n        const session = SharedSession.getInstance();\r\n        session.clearSavableKeys();\r\n        session.set('campaign_id', null);\r\n        session.set('campaign_step_index', 0);\r\n\r\n        console.log(\"[CampaignManager] Quitting to Menu.\");\r\n        StateManager.getInstance().replace(StateRegistry.create(FeatureEnum.DEV_MENU));\r\n    }\r\n\r\n    private loadCurrentStep(def: ICampaignDefinition, index: number) {\r\n        const step = def.steps[index];\r\n        console.log(`[CampaignManager] Loading Step ${index}: ${step.name}`);\r\n\r\n        const nextState = StateRegistry.createFromPreset(step.stateId, step.presetLabel);\r\n\r\n        StateManager.getInstance().replace(nextState, step.loadingConfig);\r\n    }\r\n}"],"names":["CampaignManager","campaignId","def","CampaignRegistry","session","SharedSession","index","context","factory","failState","StateManager","StateRegistry","FeatureEnum","step","nextState"],"mappings":"oEAQO,MAAMA,CAAgB,CACzB,OAAe,SAEP,aAAc,CACtB,CAEA,OAAc,aAA+B,CACzC,OAAKA,EAAgB,WACjBA,EAAgB,SAAW,IAAIA,GAE5BA,EAAgB,QAC3B,CAEO,cAAcC,EAAoB,CACrC,MAAMC,EAAMC,EAAiB,IAAIF,CAAU,EAC3C,GAAI,CAACC,EAAK,CACN,QAAQ,MAAM,8CAA8CD,CAAU,EAAE,EACxE,MACJ,CAEA,QAAQ,IAAI,wCAAwCA,CAAU,EAAE,EAEhE,MAAMG,EAAUC,EAAc,YAAA,EAE9BD,EAAQ,iBAAA,EAERA,EAAQ,IAAI,cAAeH,CAAU,EACrCG,EAAQ,IAAI,sBAAuB,CAAC,EAEpC,KAAK,gBAAgBF,EAAK,CAAC,CAC/B,CAEO,qBAAsB,CACzB,MAAME,EAAUC,EAAc,YAAA,EACxBJ,EAAaG,EAAQ,IAAY,aAAa,EACpD,IAAIE,EAAQF,EAAQ,IAAY,qBAAqB,EAErD,GAAI,CAACH,GAAcK,IAAU,OAAW,CACpC,KAAK,aAAA,EACL,MACJ,CAEA,MAAMJ,EAAMC,EAAiB,IAAIF,CAAU,EACtCC,IAELI,IACAF,EAAQ,IAAI,sBAAuBE,CAAK,EAEpCA,GAASJ,EAAI,MAAM,OACnB,KAAK,aAAA,EAEL,KAAK,gBAAgBA,EAAKI,CAAK,EAEvC,CAEO,kBAAmB,CACtB,MAAMF,EAAUC,EAAc,YAAA,EACxBJ,EAAaG,EAAQ,IAAY,aAAa,EAC9CE,EAAQF,EAAQ,IAAY,qBAAqB,EAEvD,GAAI,CAACH,GAAcK,IAAU,OAAW,OAExC,MAAMJ,EAAMC,EAAiB,IAAIF,CAAU,EACtCC,IAEL,QAAQ,IAAI,mCAAmCI,CAAK,EAAE,EACtDF,EAAQ,iBAAA,EAERA,EAAQ,IAAI,cAAeH,CAAU,EACrCG,EAAQ,IAAI,sBAAuBE,CAAK,EAExC,KAAK,gBAAgBJ,EAAKI,CAAK,EACnC,CAEO,gBAAgBC,EAAe,CAClC,MAAMH,EAAUC,EAAc,YAAA,EACxBJ,EAAaG,EAAQ,IAAY,aAAa,EAC9CE,EAAQF,EAAQ,IAAY,qBAAqB,EAEvD,GAAI,CAACH,EAAY,CACb,QAAQ,MAAM,6BAA6B,EAC3C,KAAK,aAAA,EACL,MACJ,CAEA,MAAMC,EAAMC,EAAiB,IAAIF,CAAU,EAErCO,EADON,GAAK,MAAMI,GAAS,EAAE,GACb,aAAeJ,GAAK,YAE1C,GAAIM,EAAS,CACT,QAAQ,IAAI,wDAAwD,EACpE,MAAMC,EAAYD,EAAQD,CAAO,EACjCG,EAAa,YAAA,EAAc,QAAQD,CAAS,CAChD,MACI,QAAQ,KAAK,qDAAqD,EAClE,KAAK,aAAA,CAEb,CAEO,cAAe,CAClB,MAAML,EAAUC,EAAc,YAAA,EAC9BD,EAAQ,iBAAA,EACRA,EAAQ,IAAI,cAAe,IAAI,EAC/BA,EAAQ,IAAI,sBAAuB,CAAC,EAEpC,QAAQ,IAAI,qCAAqC,EACjDM,EAAa,cAAc,QAAQC,EAAc,OAAOC,EAAY,QAAQ,CAAC,CACjF,CAEQ,gBAAgBV,EAA0BI,EAAe,CAC7D,MAAMO,EAAOX,EAAI,MAAMI,CAAK,EAC5B,QAAQ,IAAI,kCAAkCA,CAAK,KAAKO,EAAK,IAAI,EAAE,EAEnE,MAAMC,EAAYH,EAAc,iBAAiBE,EAAK,QAASA,EAAK,WAAW,EAE/EH,EAAa,YAAA,EAAc,QAAQI,EAAWD,EAAK,aAAa,CACpE,CACJ"}