import{h as d,N as a,V as r,f as h,R as g,A as n,b as c,I as m}from"./index-BGo7J5MW.js";import{S as f}from"./SaveManager-XrfGKQJ3.js";const u={hp:"global_hp",energy:"global_energy"};class v extends d{constructor(e=!1){super(),this.forceReset=e,this.isRendering=!1,this.isUpdating=!1}vm;controller;instanceId="";isLoadedFromSave=!1;async init(){if(this.isInitialized){this.isUpdating=!0,this.isRendering=!0;return}const e=a.getInstance(),t=r.getInstance(),s=h.getInstance();e.activeStateName===this.name&&(this.isLoadedFromSave=!0),this.instanceId=e.prepareForState(this.name),e.setupBuffers(this.logicSchema,this.forceReset),t.prepareForState(this.name),t.setupBuffers(e.getBuffers(),this.viewSchema);try{await this.internalLoadResources()}catch(i){console.warn(`[${this.name}] Resource load warning:`,i)}this.initMVC(),e.createState(this.name),t.createState(this.name),await this.internalPostInit(e,s),s.unlock(),this.isInitialized=!0,this.isUpdating=!0,this.isRendering=!0}update(e,t){this.isUpdating&&(this.controller&&this.controller.update(),this.vm&&this.vm.update&&this.vm.update())}getView(){return g.createElement(this.viewComponent,{key:this.instanceId,vm:this.vm,controller:this.controller})}destroy(){const e=h.getInstance(),t=a.getInstance(),s=r.getInstance();this.isUpdating=!1,this.isRendering=!1,this.isInitialized=!1,this.syncGlobalsToSession(e),n.getInstance().stopAllByState(this.name),n.getInstance().uncacheByState(this.name),c.getInstance().uncacheByState(this.name),this.controller&&this.controller.destroy(),this.onBeforeDestroy(e,t),t.terminateState(this.name,this.instanceId),s.terminateState(this.name),m.getInstance().reset()}async onCustomLoadResources(){}onBeforeDestroy(e,t){}async internalLoadResources(){const e=this.getConfig();e.manifestPath&&await Promise.all([c.getInstance().loadManifest(e.manifestPath,this.name),n.getInstance().loadManifest(e.manifestPath,this.name)]),await this.onCustomLoadResources()}async internalPostInit(e,t){const s=this.getConfig();if(this.isLoadedFromSave)e.isInitialized=!0;else if(this.forceReset)t.clearSavableKeys(),e.sendInput(this.name,"INITIALIZE",s);else{const i=this.getSessionOverrides(t),l={...s,...i};e.sendInput(this.name,"INITIALIZE",l)}this.vm&&this.vm.notify&&this.vm.notify(),s.bgmKey&&n.getInstance().play(s.bgmKey)}syncGlobalsToSession(e){this.vm&&Object.entries(u).forEach(([t,s])=>{t in this.vm&&e.set(s,this.vm[t])})}}class w{constructor(e,t){this.vm=e,this.stateName=t,this.workers=a.getInstance(),window.addEventListener("keydown",this.handleKeyDown),this.workers.logic.addEventListener("message",this.handleWorkerMessage),this.captureInitialState()}workers;QUICK_SAVE_KEY="quick_save";update(){this.vm.update()}destroy(){window.removeEventListener("keydown",this.handleKeyDown),this.workers.logic.removeEventListener("message",this.handleWorkerMessage),this.onInternalDestroy()}send(e,t={}){this.workers.sendInput(this.stateName,e,t)}onInternalDestroy(){}captureInitialState(){setTimeout(async()=>{await f.getInstance().performSave(this.QUICK_SAVE_KEY,this.stateName)},200)}handleWorkerMessage=e=>{const{type:t,name:s,payload:i}=e.data;t==="EVENT"&&this.onWorkerEvent(s,i)};handleKeyDown=e=>{this.onKeyDown(e)}}class y{listeners=[];_sharedViews;constructor(){this._sharedViews=r.getInstance().sharedViews}get sharedView(){const e=this._sharedViews.get("main")||this._sharedViews.values().next().value;return e||new Float32Array(0)}getBuffer(e){return this._sharedViews.get(e)}setBuffers(e){this._sharedViews=e}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}update(){this.notify()}notify(){for(let e=0;e<this.listeners.length;e++)this.listeners[e]()}}export{w as B,u as G,y as a,v as b};
//# sourceMappingURL=BasePresenter-CoqhTtZO.js.map
