{"version":3,"file":"Game1Logic-BLTRHNl1.js","sources":["../src/features/Game1/logic/Game1Commands.ts","../src/features/Game1/logic/Game1Logic.ts"],"sourcesContent":["// src/features/Game1/logic/Game1Commands.ts\r\nimport {ICommand} from '../../../core/interfaces/ICommand';\r\nimport {Game1Config} from '../model/Game1Config';\r\n\r\nexport const Game1Commands: Record<string, ICommand> = {\r\n    INITIALIZE: {\r\n        execute(logic, payload: Game1Config) {\r\n            logic.applyConfig(payload);\r\n            logic.setInitialized(true);\r\n        }\r\n    },\r\n    MOVEMENT: {\r\n        execute(logic, payload) {\r\n            logic.setMovement(payload.vx, payload.vy);\r\n        }\r\n    },\r\n    TAKE_DAMAGE: {\r\n        execute(logic, payload) {\r\n            const damage = payload.amount ?? 15;\r\n            logic.modifyHp(-damage);\r\n        }\r\n    }\r\n};","// src/features/Game1/logic/Game1Logic.ts\r\nimport {Game1MainSchema, Game1RocksSchema} from '../model/Game1LogicSchema';\r\nimport {BaseLogic} from '../../../core/templates/BaseLogic';\r\nimport {BaseDispatcher} from '../../../core/templates/BaseDispatcher';\r\nimport {Game1Commands} from './Game1Commands';\r\nimport {Game1Config} from '../model/Game1Config';\r\n\r\ninterface Rock {\r\n    x: number;\r\n    y: number;\r\n    vx: number;\r\n    vy: number;\r\n    seed: number;\r\n}\r\n\r\nexport class Game1Logic extends BaseLogic<Game1Config> {\r\n    protected dispatcher: BaseDispatcher<Game1Logic>;\r\n    private hero = {x: 0, y: 0, vx: 0, vy: 0, hp: 100};\r\n    private rocks: Rock[] = [];\r\n    private currentFrame: number = 0;\r\n    private lastHitFrame: number = 0;\r\n\r\n    private wasMouseDown: boolean = false;\r\n\r\n    constructor() {\r\n        super(Game1MainSchema.REVISION);\r\n        this.dispatcher = new BaseDispatcher(this, Game1Commands, \"Game1\");\r\n    }\r\n\r\n    public applyConfig(config: Game1Config): void {\r\n        this.config = config;\r\n        this.hero.hp = config.initialHP;\r\n        this.hero.x = config.heroStartX;\r\n        this.hero.y = config.heroStartY;\r\n\r\n        if (this.rocks.length === 0) {\r\n            for (let i = 0; i < config.spawnCount; i++) this.spawnRock();\r\n        }\r\n    }\r\n\r\n    public setMovement(vx?: number, vy?: number): void {\r\n        if (vx !== undefined) this.hero.vx = vx;\r\n        if (vy !== undefined) this.hero.vy = vy;\r\n    }\r\n\r\n    public modifyHp(amount: number): void {\r\n        this.hero.hp = Math.max(0, Math.min(100, this.hero.hp + amount));\r\n        if (amount < 0) this.triggerHitCooldown();\r\n    }\r\n\r\n    public triggerHitCooldown(): void {\r\n        this.lastHitFrame = this.currentFrame;\r\n    }\r\n\r\n    public override destroy(): void {\r\n        super.destroy();\r\n        this.rocks = [];\r\n    }\r\n\r\n    public override getSnapshot(): any {\r\n        return {\r\n            hero: {...this.hero},\r\n            rocks: [...this.rocks],\r\n            lastHitFrame: this.lastHitFrame,\r\n            currentFrame: this.currentFrame,\r\n            config: this.config\r\n        };\r\n    }\r\n\r\n    public override loadSnapshot(data: any): void {\r\n        if (!data) return;\r\n        this.config = data.config;\r\n        this.hero = data.hero;\r\n        this.rocks = data.rocks;\r\n        this.lastHitFrame = data.lastHitFrame;\r\n        this.currentFrame = data.currentFrame ?? 0;\r\n        this.isInitialized = true;\r\n    }\r\n\r\n    protected onUpdate(sharedView: Float32Array, intView: Int32Array, frameCount: number, fps: number): void {\r\n        if (!this.config) return;\r\n        this.currentFrame = frameCount;\r\n\r\n        const actions = this.inputState.actions;\r\n        const moveSpeed = this.config.moveSpeed;\r\n\r\n        let targetVx = 0;\r\n        let targetVy = 0;\r\n\r\n        if (actions.includes('MOVE_UP')) targetVy = -moveSpeed;\r\n        if (actions.includes('MOVE_DOWN')) targetVy = moveSpeed;\r\n        if (actions.includes('MOVE_LEFT')) targetVx = -moveSpeed;\r\n        if (actions.includes('MOVE_RIGHT')) targetVx = moveSpeed;\r\n\r\n        this.setMovement(targetVx, targetVy);\r\n\r\n        if (this.inputState.isMouseDown && !this.wasMouseDown) {\r\n            const worldMouseX = this.inputState.mouseX * this.config.width;\r\n            const worldMouseY = this.inputState.mouseY * this.config.height;\r\n\r\n            this.spawnRock(worldMouseX, worldMouseY);\r\n        }\r\n        this.wasMouseDown = this.inputState.isMouseDown;\r\n\r\n        if (this.currentFrame - this.lastHitFrame > 120 && this.hero.hp < 100) {\r\n            this.hero.hp = Math.min(100, this.hero.hp + (this.hero.hp < 25 ? 0.3 : 0.1));\r\n        }\r\n\r\n        this.hero.x = Math.max(0, Math.min(this.config.width, this.hero.x + this.hero.vx));\r\n        this.hero.y = Math.max(0, Math.min(this.config.height, this.hero.y + this.hero.vy));\r\n\r\n        this.processRocks(frameCount);\r\n        this.syncToSAB(sharedView, frameCount, fps);\r\n    }\r\n\r\n    private spawnRock(x?: number, y?: number): void {\r\n        if (!this.config) return;\r\n\r\n        const rocksView = this.sharedViews.get('rocks');\r\n        if (!rocksView) return;\r\n\r\n        const currentCapacity = Math.floor(rocksView.length / Game1RocksSchema.STRIDE);\r\n\r\n        if (this.rocks.length >= currentCapacity) {\r\n            const newSize = rocksView.length + (1000 * Game1RocksSchema.STRIDE); // Expand by ~1000 rocks\r\n\r\n            if ((this as any)._resizeRequested !== newSize) {\r\n                console.log(`[Game1Logic] Requesting Resize. Current: ${rocksView.length}, New: ${newSize}`);\r\n                self.postMessage({\r\n                    type: 'REQUEST_RESIZE',\r\n                    payload: { bufferName: 'rocks', newSize: newSize }\r\n                });\r\n                (this as any)._resizeRequested = newSize;\r\n            }\r\n            return;\r\n        }\r\n\r\n        (this as any)._resizeRequested = 0;\r\n\r\n        this.rocks.push({\r\n            x: x ?? Math.random() * this.config.width,\r\n            y: y ?? Math.random() * this.config.height,\r\n            vx: (Math.random() - 0.5) * 8,\r\n            vy: (Math.random() - 0.5) * 8,\r\n            seed: Math.random() * 1000\r\n        });\r\n    }\r\n\r\n    private processRocks(frameCount: number): void {\r\n        if (!this.config) return;\r\n        for (let i = this.rocks.length - 1; i >= 0; i--) {\r\n            const r = this.rocks[i];\r\n            r.x += r.vx;\r\n            r.y += r.vy;\r\n            let hit = false;\r\n\r\n            if (r.x <= 0 || r.x >= this.config.width) {\r\n                r.vx *= -1;\r\n                hit = true;\r\n            }\r\n            if (r.y <= 0 || r.y >= this.config.height) {\r\n                r.vy *= -1;\r\n                hit = true;\r\n            }\r\n\r\n            const dx = r.x - this.hero.x;\r\n            const dy = r.y - this.hero.y;\r\n            if (dx * dx + dy * dy < 1600) {\r\n                r.vx *= -1.1;\r\n                r.vy *= -1.1;\r\n                this.modifyHp(-0.2);\r\n                hit = true;\r\n                self.postMessage({type: 'EVENT', name: 'EXPLOSION_REQ'});\r\n            }\r\n            if (hit && Math.random() > 0.8) this.spawnRock();\r\n        }\r\n    }\r\n\r\n    private syncToSAB(sharedView: Float32Array, frameCount: number, fps: number): void {\r\n        const mainView = this.sharedViews.get('main');\r\n        const rocksView = this.sharedViews.get('rocks');\r\n\r\n        if (mainView) {\r\n            mainView[Game1MainSchema.HERO_HP] = this.hero.hp;\r\n            mainView[Game1MainSchema.HERO_X] = this.hero.x;\r\n            mainView[Game1MainSchema.HERO_Y] = this.hero.y;\r\n            mainView[Game1MainSchema.ENTITY_COUNT] = this.rocks.length;\r\n        }\r\n\r\n        if (rocksView) {\r\n            this.rocks.forEach((r, i) => {\r\n                const base = i * Game1RocksSchema.STRIDE;\r\n                if (base + 2 < rocksView.length) {\r\n                    rocksView[base] = r.x;\r\n                    rocksView[base + 1] = r.y;\r\n                    rocksView[base + 2] = r.seed;\r\n                }\r\n            });\r\n        }\r\n    }\r\n}"],"names":["Game1Commands","logic","payload","damage","Game1Logic","BaseLogic","Game1MainSchema","BaseDispatcher","config","vx","vy","amount","data","sharedView","intView","frameCount","fps","actions","moveSpeed","targetVx","targetVy","worldMouseX","worldMouseY","x","y","rocksView","currentCapacity","Game1RocksSchema","newSize","r","hit","dx","dy","mainView","i","base"],"mappings":"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"}