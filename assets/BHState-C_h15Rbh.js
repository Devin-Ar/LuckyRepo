import{B as Y,a as F,b as K,G as U}from"./BasePresenter-45XUz4Hx.js";import{F as g,S,a as p,B as x,I as N,A as J,r as l,j as i,k as M,b as z,c as $,l as Q}from"./index-CeLuIhmo.js";import{C as H}from"./CampaignManager-D4yI8sdC.js";import{S as Z}from"./SaveManager-CKTDV0Pf.js";import{m as d}from"./module-DrzdPB3r.js";import{G as ee}from"./GameSprite-uxNaMgiy.js";class te extends Y{isDead=!1;hasExited=!1;constructor(r){super(r,g.BH_GAME)}takeDamage(){this.send("TAKE_DAMAGE",{amount:15})}async jumpToGame2(){const r=await S.create(g.GAME_2,{reset:!1});await p.getInstance().replace(r)}async loadLevel(r){const t=await S.create(g.BH_GAME,{reset:!1,level:r});await p.getInstance().replace(t)}async resetLevel(){await Z.getInstance().performLoad(this.QUICK_SAVE_KEY);const r=this.vm.currentLevel||x.Level1,t=await S.create(g.BH_GAME,{reset:!1,level:r});await p.getInstance().replace(t)}onKeyDown(r){N.getInstance().isKeyAction(r.key,"PAUSE")&&this.openPauseMenu()}onWorkerEvent(r){r==="EXPLOSION_REQ"&&J.getInstance().play("sfx_explosion"),r==="PLAYER_DEAD"&&!this.isDead&&(this.isDead=!0,this.handlePlayerDeath()),r==="EXIT_DOOR_ENTERED"&&!this.hasExited&&(this.hasExited=!0,this.handleExitDoor())}handlePlayerDeath(){H.getInstance().failCurrentStep()}handleExitDoor(){H.getInstance().completeCurrentStep()}async openPauseMenu(){const r=p.getInstance();if(r.getCurrentStateName()===this.stateName){const t=await S.create(g.PAUSE_MENU);await r.push(t)}}}const f={HERO_X:0,HERO_Y:1,HERO_ROTATION:2,HERO_SCALE:3,HERO_HP_DISPLAY:4,HERO_FRAME:5,ACTIVE_ROCK_COUNT:8,CURRENT_WAVE:9,TOTAL_WAVES:12,WAVE_STATE:13,WAVE_DELAY_TIMER:14,EXIT_DOOR_ACTIVE:15,EXIT_DOOR_X:16,EXIT_DOOR_Y:17,CURRENT_LEVEL:18,ROCKS_START_INDEX:20,ROCK_STRIDE:6,PPROJ_START_INDEX:200,PPROJ_STRIDE:2,EPROJ_START_INDEX:300,EPROJ_STRIDE:2,BUFFER_SIZE:4096},re=["IDLE","DELAY","ACTIVE","CLEARED","ALL_CLEARED"];class ne extends F{get pos(){return{x:this.sharedView[f.HERO_X]||0,y:this.sharedView[f.HERO_Y]||0}}get hp(){return this.sharedView[f.HERO_HP_DISPLAY]||0}get entityCount(){return Math.floor(this.sharedView[f.ACTIVE_ROCK_COUNT]||0)}get projCount(){return Math.floor(this.sharedView[f.PPROJ_START_INDEX-1]||0)}get projEnemyCount(){return Math.floor(this.sharedView[f.EPROJ_START_INDEX-1]||0)}get currentWave(){return Math.floor(this.sharedView[f.CURRENT_WAVE]||0)}get totalWaves(){return Math.floor(this.sharedView[f.TOTAL_WAVES]||0)}get waveState(){const r=Math.floor(this.sharedView[f.WAVE_STATE]||0);return re[r]||"IDLE"}get waveDelayTimer(){return Math.floor(this.sharedView[f.WAVE_DELAY_TIMER]||0)}get isRoomCleared(){return this.waveState==="ALL_CLEARED"&&this.entityCount===0}get exitDoorActive(){return(this.sharedView[f.EXIT_DOOR_ACTIVE]||0)===1}get exitDoorX(){return this.sharedView[f.EXIT_DOOR_X]||0}get exitDoorY(){return this.sharedView[f.EXIT_DOOR_Y]||0}get currentLevelIndex(){return Math.floor(this.sharedView[f.CURRENT_LEVEL]||0)}get heroVisuals(){return{x:this.sharedView[f.HERO_X]||0,y:this.sharedView[f.HERO_Y]||0,rotation:this.sharedView[f.HERO_ROTATION]||0,scale:this.sharedView[f.HERO_SCALE]||1,currentFrame:this.sharedView[f.HERO_FRAME]||0}}getRockViewData(r){const t=f.ROCKS_START_INDEX+r*f.ROCK_STRIDE;return{x:this.sharedView[t]||0,y:this.sharedView[t+1]||0,rotation:this.sharedView[t+2]||0}}getRockAttackData(r){const t=f.ROCKS_START_INDEX+r*f.ROCK_STRIDE;return{primedMode:this.sharedView[t+3]||0,endX:this.sharedView[t+4]||0,endY:this.sharedView[t+5]||0}}getPlayerProjData(r){const t=f.PPROJ_START_INDEX+r*f.PPROJ_STRIDE;return{x:this.sharedView[t]||0,y:this.sharedView[t+1]||0}}getEnemyProjData(r){const t=f.EPROJ_START_INDEX+r*f.EPROJ_STRIDE;return{x:this.sharedView[t]||0,y:this.sharedView[t+1]||0}}}const se=({w:n,h:r})=>{const t=d.useApp();return l.useEffect(()=>{t?.renderer&&(t.renderer.resize(n,r),t.view instanceof HTMLCanvasElement&&(t.view.width=n,t.view.height=r))},[t,n,r]),null},oe=({paused:n,w:r,h:t})=>{const u=l.useRef(null),o=l.useRef(0);return l.useEffect(()=>{u.current?.clear().beginFill(16777215).drawRect(0,0,r,t).endFill()},[r,t]),d.useTick(a=>{if(!u.current||n)return;o.current+=Math.PI/60*a;const s=(Math.sin(o.current)+1)/2,e=Math.round(26+s*4),c=Math.round(26+s*54),h=Math.round(46+s*104);u.current.tint=(e<<16)+(c<<8)+h}),i.jsx(d.Graphics,{ref:u})},ie=({vm:n,paused:r})=>{const t=l.useRef(null),u=l.useRef([]),o=z.getInstance();return l.useEffect(()=>()=>{u.current.forEach(a=>{a&&!a.destroyed&&a.destroy()}),u.current=[]},[]),d.useTick(()=>{if(!t.current)return;const a=n.entityCount,s=u.current;if(a>s.length)for(let e=s.length;e<a;e++){const c=o.getTexture("static_rock");if(c){const h=new $(c);h.anchor.set(.5),h.scale.set(.8),t.current.addChild(h),s.push(h)}}else if(a<s.length)for(let e=s.length-1;e>=a;e--){const c=s.pop();c&&(t.current.removeChild(c),c.destroy())}for(let e=0;e<a;e++){const c=s[e],h=n.getRockViewData(e);if(!h||r){c&&(c.visible=!1);continue}c.visible=!0,c.x=h.x,c.y=h.y,c.rotation=h.rotation}}),i.jsx(d.Container,{ref:t})},ae=({vm:n,paused:r})=>{const t=l.useRef(null),u=l.useRef([]);return l.useEffect(()=>()=>{u.current.forEach(o=>{o&&!o.destroyed&&o.destroy()}),u.current=[]},[]),d.useTick(()=>{if(!t.current)return;const o=n.entityCount,a=u.current;if(o>a.length)for(let s=a.length;s<o;s++){const e=new M;e.visible=!1,t.current.addChild(e),a.push(e)}else if(o<a.length)for(let s=a.length-1;s>=o;s--){const e=a.pop();e&&(t.current.removeChild(e),e.destroy())}for(let s=0;s<o;s++){const e=a[s],c=n.getRockAttackData(s),h=n.getRockViewData(s);if(!c||r){e&&(e.visible=!1);continue}c.primedMode===1?(e.visible=!0,e.clear(),e.lineStyle(30,16711680),e.moveTo(h.x,h.y),e.lineTo(c.endX,c.endY)):e.visible=!1}}),i.jsx(d.Container,{ref:t})},ce=({vm:n,paused:r})=>{const t=l.useRef(null),u=l.useRef([]);return l.useEffect(()=>()=>{u.current.forEach(o=>{o&&!o.destroyed&&o.destroy()}),u.current=[]},[]),d.useTick(()=>{if(!t.current)return;const o=n.projCount,a=u.current;if(o>a.length)for(let s=a.length;s<o;s++){const e=new M;e.visible=!1,t.current.addChild(e),a.push(e)}else if(o<a.length)for(let s=a.length-1;s>=o;s--){const e=a.pop();e&&(t.current.removeChild(e),e.destroy())}for(let s=0;s<o;s++){const e=a[s],c=n.getPlayerProjData(s);if(!c||r){e&&(e.visible=!1);continue}e.visible=!0,e.clear(),e.lineStyle(10,65280),e.drawRect(c.x,c.y,20,20)}}),i.jsx(d.Container,{ref:t})},le=({vm:n,paused:r})=>{const t=l.useRef(null),u=l.useRef([]);return l.useEffect(()=>()=>{u.current.forEach(o=>{o&&!o.destroyed&&o.destroy()}),u.current=[]},[]),d.useTick(()=>{if(!t.current)return;const o=n.projEnemyCount,a=u.current;if(o>a.length)for(let s=a.length;s<o;s++){const e=new M;e.visible=!1,t.current.addChild(e),a.push(e)}else if(o<a.length)for(let s=a.length-1;s>=o;s--){const e=a.pop();e&&(t.current.removeChild(e),e.destroy())}for(let s=0;s<o;s++){const e=a[s],c=n.getEnemyProjData(s);if(!c||r){e&&(e.visible=!1);continue}e.visible=!0,e.clear(),e.lineStyle(10,16711680),e.drawRect(c.x,c.y,20,20)}}),i.jsx(d.Container,{ref:t})},ue=({vm:n,paused:r,width:t,height:u,scale:o,heroPos:a,hp:s})=>{const e=l.useRef(null),[c,h]=l.useState(n.heroVisuals);return d.useTick(()=>{const E=n.heroVisuals;e.current&&(e.current.x=E.x,e.current.y=E.y,e.current.rotation=E.rotation,e.current.scale.set(E.scale),a.current.x=E.x,a.current.y=E.y,h(E))}),i.jsxs(i.Fragment,{children:[i.jsx(se,{w:t,h:u}),i.jsx(oe,{paused:r,w:t,h:u}),i.jsxs(d.Container,{scale:o,children:[i.jsx(ce,{vm:n,paused:r}),i.jsx(le,{vm:n,paused:r}),i.jsx(ae,{vm:n,paused:r}),i.jsx(ie,{vm:n,paused:r}),i.jsx(d.Container,{ref:e,children:i.jsx(ee,{sheetName:"hero_sheet",animationName:"idle",x:0,y:0,scale:1,anchor:.5,currentFrame:c.currentFrame})})]})]})},fe=({hp:n,rockCount:r,currentWave:t,totalWaves:u,waveState:o,waveDelayTimer:a,isRoomCleared:s,exitDoorActive:e,exitDoorX:c,exitDoorY:h,gameWidth:E,gameHeight:_,shieldBarRef:A,shieldTextRef:C,damageBtnRef:D,onDamage:w,onJumpToG2:I,onLevel1:O,onLevel2:b,onLevel3:L,onResetG1:V})=>{const R={padding:"0.6cqw 1cqw",cursor:"pointer",color:"#fff",border:"none",borderRadius:"0.4cqw",fontWeight:"bold",fontFamily:"monospace",fontSize:"0.8cqw",pointerEvents:"auto",textAlign:"center"},m=()=>s?"ROOM CLEARED!":o==="DELAY"?`NEXT WAVE IN ${Math.ceil(a/60)}s`:o==="ACTIVE"?`ENEMIES: ${r}`:o==="CLEARED"?"WAVE CLEARED!":"STANDBY",T=()=>s?"#f1c40f":o==="DELAY"?"#e67e22":o==="ACTIVE"?"#e74c3c":o==="CLEARED"?"#2ecc71":"#888";return i.jsxs("div",{style:{position:"absolute",inset:0,pointerEvents:"none",containerType:"size"},children:[i.jsxs("div",{style:{position:"absolute",top:"5cqh",left:"50%",transform:"translateX(-50%)",width:"35cqw"},children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",color:"#fff",marginBottom:"0.5cqh",fontWeight:"bold",fontFamily:"monospace",fontSize:"1.2cqw"},children:[i.jsx("span",{children:"SHIELD ENERGY"}),i.jsxs("span",{ref:C,children:[Math.round(n),"%"]})]}),i.jsx("div",{style:{width:"100%",height:"2cqh",backgroundColor:"#222",borderRadius:"1cqw",border:"0.2cqw solid #fff",overflow:"hidden"},children:i.jsx("div",{ref:A,style:{width:`${Math.max(0,n)}%`,height:"100%",backgroundColor:n<30?"#c0392b":"#27ae60"}})})]}),i.jsxs("div",{style:{position:"absolute",top:"3cqh",right:"3cqw",color:"#fff",fontFamily:"monospace",textAlign:"right",fontSize:"1.2cqw"},children:[i.jsxs("div",{style:{color:T(),fontSize:"1.4cqw",fontWeight:"bold",marginBottom:"0.5cqh"},children:["WAVE ",t+1," / ",u]}),i.jsx("div",{style:{color:T(),fontSize:"1cqw"},children:m()}),i.jsxs("div",{style:{color:"#888",fontSize:"0.8cqw",marginTop:"0.3cqh"},children:["ENEMIES_ACTIVE: ",r]})]}),s&&i.jsxs("div",{style:{position:"absolute",top:"40%",left:"50%",transform:"translate(-50%, -50%)",color:"#f1c40f",fontFamily:"monospace",fontSize:"3cqw",fontWeight:"bold",textShadow:"0 0 20px rgba(241, 196, 60, 0.6)",textAlign:"center",letterSpacing:"0.3cqw"},children:["ALL WAVES CLEARED",i.jsx("div",{style:{fontSize:"1.2cqw",color:"#fff",marginTop:"1cqh"},children:"PROCEED TO EXIT"})]}),e&&E>0&&_>0&&i.jsx("div",{style:{position:"absolute",left:`${c/E*100}%`,top:`${h/_*100}%`,transform:"translate(-50%, -50%)",width:"6.25%",height:"11.1%",border:"3px solid #f1c40f",backgroundColor:"rgba(241, 196, 60, 0.25)",boxShadow:"0 0 20px rgba(241, 196, 60, 0.5), inset 0 0 15px rgba(241, 196, 60, 0.3)",display:"flex",alignItems:"center",justifyContent:"center",animation:"exitDoorPulse 1.5s ease-in-out infinite"},children:i.jsx("span",{style:{color:"#f1c40f",fontFamily:"monospace",fontWeight:"bold",fontSize:"0.9cqw",textShadow:"0 0 8px rgba(241, 196, 60, 0.8)"},children:"EXIT"})}),e&&i.jsx("style",{children:`
                    @keyframes exitDoorPulse {
                        0%, 100% { box-shadow: 0 0 20px rgba(241, 196, 60, 0.5), inset 0 0 15px rgba(241, 196, 60, 0.3); }
                        50% { box-shadow: 0 0 35px rgba(241, 196, 60, 0.8), inset 0 0 25px rgba(241, 196, 60, 0.5); }
                    }
                `}),o==="DELAY"&&a>0&&i.jsxs("div",{style:{position:"absolute",top:"35%",left:"50%",transform:"translate(-50%, -50%)",color:"#e67e22",fontFamily:"monospace",fontSize:"2cqw",fontWeight:"bold",textShadow:"0 0 15px rgba(230, 126, 34, 0.5)",textAlign:"center",opacity:.9},children:["WAVE ",t+1," INCOMING",i.jsx("div",{style:{fontSize:"4cqw",color:"#fff",marginTop:"0.5cqh"},children:Math.ceil(a/60)})]}),i.jsxs("div",{style:{position:"absolute",top:"3cqh",left:"3cqw",display:"flex",flexDirection:"column",gap:"1cqh"},children:[i.jsx("button",{ref:D,onClick:w,style:{...R,background:"#333",border:"0.1cqw solid #fff"},children:"TAKE DAMAGE (-15)"}),i.jsxs("div",{style:{display:"flex",gap:"0.5cqw"},children:[i.jsx("button",{onClick:O,style:{...R,background:"#408240",flex:1},children:"LVL 1"}),i.jsx("button",{onClick:b,style:{...R,background:"#C29F19",flex:1},children:"LVL 2"}),i.jsx("button",{onClick:L,style:{...R,background:"#C21919",flex:1},children:"LVL 3"})]}),i.jsx("button",{onClick:I,style:{...R,background:"#2980b9"},children:"Go to Game 2"}),i.jsx("div",{style:{display:"flex",gap:"0.5cqw"},children:i.jsx("button",{onClick:V,style:{...R,background:"#c0392b",flex:1},children:"Quick Load"})})]})]})},he=({vm:n,controller:r,width:t=960,height:u=540})=>{const[o,a]=l.useState(n.hp),[s,e]=l.useState(n.entityCount),[c,h]=l.useState(!1),[E,_]=l.useState(n.currentWave),[A,C]=l.useState(n.totalWaves),[D,w]=l.useState(n.waveState),[I,O]=l.useState(n.waveDelayTimer),[b,L]=l.useState(n.isRoomCleared),[V,R]=l.useState(n.exitDoorActive),[m,T]=l.useState(n.exitDoorX),[X,W]=l.useState(n.exitDoorY),j=l.useRef(null),P=l.useRef(null),q=l.useRef(null),v=l.useRef({x:n.pos.x,y:n.pos.y});l.useEffect(()=>{const G=n.subscribe(()=>{const k=p.getInstance().getActiveState()?.name!=="BHGame";c!==k&&h(k);const y=n.hp;v.current.x=n.pos.x,v.current.y=n.pos.y,j.current&&(j.current.style.width=`${Math.max(0,y)}%`),P.current&&(P.current.innerText=`${Math.round(y)}%`),Math.abs(o-y)>1&&a(y),s!==n.entityCount&&e(n.entityCount),_(n.currentWave),C(n.totalWaves),w(n.waveState),O(n.waveDelayTimer),L(n.isRoomCleared),R(n.exitDoorActive),T(n.exitDoorX),W(n.exitDoorY)});return()=>G()},[n,o,s,c]);const B=l.useMemo(()=>t/960,[t]);return i.jsxs("div",{style:{position:"absolute",inset:0,background:"#000",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:[i.jsx("div",{style:{position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:i.jsx(d.Stage,{width:t,height:u,options:{backgroundColor:0,antialias:!0,resolution:1,autoDensity:!1},style:{display:"block",width:"100%",height:"100%",objectFit:"contain",imageRendering:"pixelated"},children:i.jsx(ue,{vm:n,paused:c,width:t,height:u,scale:B,heroPos:v,hp:o})},`stage-${t}-${u}`)}),i.jsx(fe,{hp:o,rockCount:s,currentWave:E,totalWaves:A,waveState:D,waveDelayTimer:I,isRoomCleared:b,exitDoorActive:V,exitDoorX:m,exitDoorY:X,gameWidth:t,gameHeight:u,shieldBarRef:j,shieldTextRef:P,damageBtnRef:q,onDamage:()=>r.takeDamage(),onJumpToG2:()=>r.jumpToGame2(),onLevel1:()=>r.loadLevel(x.Level1),onLevel2:()=>r.loadLevel(x.Level2),onLevel3:()=>r.loadLevel(x.Level3),onResetG1:()=>r.resetLevel()})]})},de={HERO_HP:0,HERO_X:1,HERO_Y:2,TICK_COUNT:3,FRAME_COUNT:4,FPS:5,REVISION:6,LAST_HIT_FRAME:7,ENTITY_COUNT:8,CURRENT_WAVE:9,TOTAL_WAVES:12,WAVE_STATE:13,WAVE_DELAY_TIMER:14,EXIT_DOOR_ACTIVE:15,EXIT_DOOR_X:16,EXIT_DOOR_Y:17,CURRENT_LEVEL:18,ROCKS_START_INDEX:20,PPROJ_START_INDEX:200,PPROJ_STRIDE:2,EPROJ_START_INDEX:300,EPROJ_STRIDE:2,ROCK_STRIDE:6,MAX_ROCKS:1e3,BUFFER_SIZE:4096};class Se extends K{name=g.BH_GAME;logicSchema=de;viewSchema=f;viewComponent=he;currentLevel;constructor(r={}){super(r.reset??!1),this.currentLevel=r.level??x.Level1}getConfig(){return Q(this.currentLevel)}getSessionOverrides(r){const t=r.get(U.hp);return t!==void 0?{initialHP:t}:{}}initMVC(){this.vm=new ne,this.controller=new te(this.vm)}async init(){N.getInstance().refreshBindings(this.name),await super.init()}}export{Se as BHState};
//# sourceMappingURL=BHState-C_h15Rbh.js.map
