import{G as a}from"./Game3LogicSchema-AnyI3ivk.js";import{B as c,a as g}from"./BaseDispatcher-CXAw-hAN.js";const p={INITIALIZE:{execute(h,i){h.applyConfig(i),i.mapPath||h.setInitialized(!0)}},SET_MAP_DATA:{execute(h,i){h.setMapData(i),h.setInitialized(!0)}},MOD_HP:{execute(h,i){h.modifyHP(i.amount)}}};class m{constructor(i){this.logic=i}checkIsOnGround(){const i=this.logic.hero.y+this.logic.heroHeight+.1;for(const o of this.logic.platforms)if(!(o.isSpike||o.isPortal||o.isVoid||o.isExit)&&!(o.isFallthrough&&(this.logic.isAction("MOVE_DOWN")||this.logic.hero.y+this.logic.heroHeight>o.y+.1))&&this.logic.hero.x+this.logic.heroWidth>o.x&&this.logic.hero.x<o.x+o.width&&i>o.y&&this.logic.hero.y+this.logic.heroHeight<=o.y)return!0;return!1}getWallCollision(){for(const o of this.logic.platforms)if(o.isWall&&this.logic.hero.x<=o.x+o.width&&this.logic.hero.x+.1>o.x+o.width&&this.logic.hero.y+this.logic.heroHeight>o.y&&this.logic.hero.y<o.y+o.height)return-1;for(const o of this.logic.platforms)if(o.isWall&&this.logic.hero.x+this.logic.heroWidth>=o.x&&this.logic.hero.x+this.logic.heroWidth-.1<o.x&&this.logic.hero.y+this.logic.heroHeight>o.y&&this.logic.hero.y<o.y+o.height)return 1;return 0}resolveMovement(){const i=this.logic.hero.x+this.logic.hero.vx;for(const t of this.logic.platforms)if(!(t.isSpike||t.isPortal||t.isVoid||t.isExit)&&!t.isFallthrough&&i+this.logic.heroWidth>t.x&&i<t.x+t.width&&this.logic.hero.y+this.logic.heroHeight>t.y&&this.logic.hero.y<t.y+t.height){i>this.logic.hero.x?this.logic.hero.x=t.x-this.logic.heroWidth:i<this.logic.hero.x&&(this.logic.hero.x=t.x+t.width),this.logic.hero.vx=0;break}this.logic.hero.vx!==0&&(this.logic.hero.x=i);const o=this.logic.hero.y+this.logic.hero.vy;let s=!1;for(const t of this.logic.platforms)if(!(t.isSpike||t.isPortal||t.isVoid||t.isExit)&&!(t.isFallthrough&&(this.logic.hero.vy<0||this.logic.isAction("MOVE_DOWN")||this.logic.hero.y+this.logic.heroHeight>t.y+.1))&&this.logic.hero.x+this.logic.heroWidth>t.x&&this.logic.hero.x<t.x+t.width&&o+this.logic.heroHeight>t.y&&o<t.y+t.height){o>this.logic.hero.y?(this.logic.hero.y=t.y-this.logic.heroHeight,this.logic.isJumpingFromGround=!1):o<this.logic.hero.y&&(this.logic.hero.y=t.y+t.height,this.logic.isJumpingFromGround=!1),this.logic.hero.vy=0,s=!0;break}s||(this.logic.hero.y=o)}checkHazardCollision(i){return!!this.getCollidingPlatform(i)}getCollidingPlatform(i){for(const s of this.logic.platforms)if(s[i]&&this.logic.hero.x+this.logic.heroWidth-.05>s.x&&this.logic.hero.x+.05<s.x+s.width&&this.logic.hero.y+this.logic.heroHeight-.05>s.y&&this.logic.hero.y+.05<s.y+s.height)return s}}class f{constructor(i,o){this.logic=i,this.collision=o}updateSpikeLogic(){const i=this.collision.checkHazardCollision("isSpike");i&&(!this.logic.wasInSpike||this.logic.spikeDamageTimer<=0)&&(this.logic.modifyHP(-10),this.logic.spikeDamageTimer=120),this.logic.spikeDamageTimer>0&&this.logic.spikeDamageTimer--,this.logic.wasInSpike=i}updatePortalLogic(){if(this.logic.portalCooldown>0){this.logic.portalCooldown--;return}const i=this.collision.getCollidingPlatform("isPortal");if(i){const o=this.logic.platforms.filter(s=>s.isPortal);if(o.length>=2){const s=o.find(t=>t!==i);s&&(this.logic.hero.x=s.x+s.width/2-this.logic.heroWidth/2,this.logic.hero.y=s.y+s.height/2-this.logic.heroHeight/2,this.logic.portalCooldown=60)}}}updateVoidLogic(){this.collision.checkHazardCollision("isVoid")&&(this.logic.hero.x=this.logic.spawnPoint.x,this.logic.hero.y=this.logic.spawnPoint.y,this.logic.hero.vx=0,this.logic.hero.vy=0,this.logic.modifyHP(-20))}updateExitLogic(){!this.logic.hasCompletedLevel&&this.collision.checkHazardCollision("isExit")&&(this.logic.hasCompletedLevel=!0,self.postMessage({type:"EVENT",name:"LEVEL_COMPLETE"}))}}class y extends c{dispatcher;collision;hazards;hp=100;hero={x:0,y:0,vx:0,vy:0};isOnGround=!1;isWallSliding=!1;wallJumpTimer=0;wallJumpDirection=0;spikeDamageTimer=0;wasInSpike=!1;portalCooldown=0;isJumpingFromGround=!1;hasCompletedLevel=!1;spawnPoint={x:0,y:0};flipX=!1;animState=0;heroWidth=1;heroHeight=1;worldScale=32;playerScale=1;playerOffsetY=0;platforms=[];mapData=null;moveSpeed=.25;jumpPower=-.4;gravity=.04;friction=.5;constructor(){super(a.REVISION),this.dispatcher=new g(this,p,"Game3"),this.collision=new m(this),this.hazards=new f(this,this.collision)}applyConfig(i){this.config=i,this.hp=i.initialHP,this.worldScale=i.worldScale||32,this.playerScale=i.playerScale||1,this.playerOffsetY=i.playerOffsetY||0,this.heroWidth=i.heroWidth||1,this.heroHeight=i.heroHeight||2}setMapData(i){this.mapData=i,this.platforms=i.platforms,this.hero.x=i.playerStart.x,this.hero.y=i.playerStart.y,this.spawnPoint={x:i.playerStart.x,y:i.playerStart.y},this.hero.vx=0,this.hero.vy=0,this.hasCompletedLevel=!1,i.playerStart.width&&i.playerStart.height&&(this.heroWidth=i.playerStart.width,this.heroHeight=i.playerStart.height)}onUpdate(i,o,s,t){!this.config||!this.isInitialized||(this.isOnGround=this.collision.checkIsOnGround(),this.updateHeroMovement(),this.collision.resolveMovement(),this.determineAnimState(),this.hazards.updateExitLogic(),this.hazards.updateSpikeLogic(),this.hazards.updatePortalLogic(),this.hazards.updateVoidLogic(),this.syncToSAB(i,s,t))}isAction(i){return this.inputState&&this.inputState.actions&&this.inputState.actions.includes(i)}updateHeroMovement(){const i=this.collision.getWallCollision(),o=this.isAction("MOVE_LEFT"),s=this.isAction("MOVE_RIGHT"),t=this.isAction("JUMP");let e=0;o&&(e-=1),s&&(e+=1),this.wallJumpTimer>0?(this.hero.vx=this.wallJumpDirection*this.moveSpeed*1.5,this.wallJumpTimer--):e!==0?this.hero.vx=e*this.moveSpeed:(this.hero.vx*=this.friction,Math.abs(this.hero.vx)<.01&&(this.hero.vx=0)),this.isWallSliding=!1,!this.isOnGround&&i!==0&&(i===-1&&e===-1||i===1&&e===1)&&(this.isWallSliding=!0,this.wallJumpTimer=0);let l=this.gravity;this.isJumpingFromGround&&t&&this.hero.vy<0&&(l*=.5),this.isWallSliding&&this.hero.vy>0?(this.hero.vy+=l*.2,this.hero.vy>.1&&(this.hero.vy=.1)):this.hero.vy+=l,t&&(this.isOnGround?(this.hero.vy=this.jumpPower,this.wallJumpTimer=0,this.isJumpingFromGround=!0):i!==0&&(this.hero.vy=this.jumpPower,this.wallJumpDirection=-i,this.wallJumpTimer=15,this.isWallSliding=!1,this.isJumpingFromGround=!1)),this.hero.vy>=0&&(this.isJumpingFromGround=!1),this.hero.vy>.8&&(this.hero.vy=.8)}determineAnimState(){this.hero.vx>.01?this.flipX=!1:this.hero.vx<-.01&&(this.flipX=!0),this.isWallSliding?this.animState=3:this.isOnGround?Math.abs(this.hero.vx)>.01?this.animState=1:this.animState=0:this.animState=2}getPlatformType(i){return i.isExit?5:i.isPortal?4:i.isSpike?3:i.isVoid?2:i.isWall?1:0}syncToSAB(i,o,s){const t=a;i[t.FRAME_COUNT]=o,i[t.FPS]=s,i[t.HERO_X]=this.hero.x,i[t.HERO_Y]=this.hero.y,i[t.HERO_VX]=this.hero.vx,i[t.HERO_VY]=this.hero.vy,i[t.HERO_HP]=this.hp,i[t.HERO_WIDTH]=this.heroWidth,i[t.HERO_HEIGHT]=this.heroHeight,i[t.HERO_FLIP]=this.flipX?1:0,i[t.HERO_ANIM_STATE]=this.animState,i[t.WORLD_SCALE]=this.worldScale,i[t.PLAYER_SCALE]=this.playerScale,i[t.PLAYER_OFFSET_Y]=this.playerOffsetY;const e=Math.min(this.platforms.length,t.MAX_OBJECTS);i[t.OBJ_COUNT]=e;for(let l=0;l<e;l++){const r=this.platforms[l],n=t.OBJ_START_INDEX+l*t.OBJ_STRIDE;i[n]=r.x,i[n+1]=r.y,i[n+2]=r.width,i[n+3]=r.height,i[n+4]=this.getPlatformType(r)}}getSnapshot(){return{hero:{...this.hero},hp:this.hp,wallJumpTimer:this.wallJumpTimer,wallJumpDirection:this.wallJumpDirection,isWallSliding:this.isWallSliding,spikeDamageTimer:this.spikeDamageTimer,wasInSpike:this.wasInSpike,portalCooldown:this.portalCooldown,isJumpingFromGround:this.isJumpingFromGround,spawnPoint:{...this.spawnPoint},hasCompletedLevel:this.hasCompletedLevel,animState:this.animState,flipX:this.flipX}}loadSnapshot(i){i&&(this.hero=i.hero||this.hero,this.hp=i.hp??this.hp,this.wallJumpTimer=i.wallJumpTimer??0,this.wallJumpDirection=i.wallJumpDirection??0,this.isWallSliding=i.isWallSliding??!1,this.spikeDamageTimer=i.spikeDamageTimer??0,this.wasInSpike=i.wasInSpike??!1,this.portalCooldown=i.portalCooldown??0,this.isJumpingFromGround=i.isJumpingFromGround??!1,this.spawnPoint=i.spawnPoint||this.spawnPoint,this.hasCompletedLevel=i.hasCompletedLevel??!1,this.animState=i.animState??0,this.flipX=i.flipX??!1,this.isInitialized=!0)}modifyHP(i){this.hp=Math.max(0,Math.min(100,this.hp+i))}}export{y as Game3Logic};
//# sourceMappingURL=Game3Logic-CQiWNkr9.js.map
