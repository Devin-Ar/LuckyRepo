{"version":3,"file":"BasePresenter-KhSD_HDc.js","sources":["../../src/core/session/GlobalSessionMap.ts","../../src/core/templates/BaseGameState.ts","../../src/core/templates/BaseController.ts","../../src/core/templates/BasePresenter.ts"],"sourcesContent":["// src/core/session/GlobalSessionMap.ts\r\n\r\nexport const GLOBAL_SESSION_MAP: Record<string, string> = {\r\n    hp: 'global_hp',\r\n    energy: 'global_energy',\r\n};\r\n\r\nexport type GlobalSessionKey = keyof typeof GLOBAL_SESSION_MAP;","import React, {JSX} from 'react';\r\nimport {State} from './State';\r\nimport {WorkerManager} from '../managers/WorkerManager';\r\nimport {ViewWorkerManager} from '../managers/ViewWorkerManager';\r\nimport {SharedSession} from '../session/SharedSession';\r\nimport {AudioManager} from '../managers/AudioManager';\r\nimport {InputManager} from '../managers/InputManager';\r\nimport {SpriteManager} from '../managers/SpriteManager';\r\nimport {IBuffer, BufferMap} from '../interfaces/IBuffer';\r\nimport {GLOBAL_SESSION_MAP} from '../session/GlobalSessionMap';\r\nimport {IGameConfig} from '../interfaces/IGameConfig';\r\n\r\nexport abstract class BaseGameState<\r\n    TVM extends { update: () => void } & Record<string, any>,\r\n    TController extends { update: () => void, destroy: () => void },\r\n    TConfig extends IGameConfig\r\n> extends State {\r\n    protected vm!: TVM;\r\n    protected controller!: TController;\r\n    protected instanceId: string = \"\";\r\n    protected isLoadedFromSave: boolean = false;\r\n\r\n    protected abstract logicSchema: IBuffer | BufferMap;\r\n    protected abstract viewSchema: IBuffer | BufferMap;\r\n    protected abstract viewComponent: React.ComponentType<any>;\r\n\r\n    constructor(protected forceReset: boolean = false) {\r\n        super();\r\n        this.isRendering = false;\r\n        this.isUpdating = false;\r\n    }\r\n\r\n    public async init(): Promise<void> {\r\n        if (this.isInitialized) {\r\n            this.isUpdating = true;\r\n            this.isRendering = true;\r\n            return;\r\n        }\r\n\r\n        const logicWorker = WorkerManager.getInstance();\r\n        const viewWorker = ViewWorkerManager.getInstance();\r\n        const session = SharedSession.getInstance();\r\n\r\n        if ((logicWorker as any).activeStateName === this.name) {\r\n            this.isLoadedFromSave = true;\r\n        }\r\n\r\n        this.instanceId = logicWorker.prepareForState(this.name);\r\n        logicWorker.setupBuffers(this.logicSchema, this.forceReset);\r\n\r\n        viewWorker.prepareForState(this.name);\r\n        viewWorker.setupBuffers(logicWorker.getBuffers(), this.viewSchema);\r\n\r\n        try {\r\n            await this.internalLoadResources();\r\n        } catch (e) {\r\n            console.warn(`[${this.name}] Resource load warning:`, e);\r\n        }\r\n\r\n        this.initMVC();\r\n\r\n        logicWorker.createState(this.name);\r\n        viewWorker.createState(this.name);\r\n\r\n        await this.internalPostInit(logicWorker, session);\r\n\r\n        session.unlock();\r\n\r\n        this.isInitialized = true;\r\n        this.isUpdating = true;\r\n        this.isRendering = true;\r\n    }\r\n\r\n    public update(dt: number, frameCount: number): void {\r\n        if (this.isUpdating) {\r\n            if (this.controller) this.controller.update();\r\n            if (this.vm && (this.vm as any).update) (this.vm as any).update();\r\n        }\r\n    }\r\n\r\n    public getView(): JSX.Element {\r\n        return React.createElement(this.viewComponent, {\r\n            key: this.instanceId,\r\n            vm: this.vm,\r\n            controller: this.controller\r\n        });\r\n    }\r\n\r\n    public destroy(): void {\r\n        const session = SharedSession.getInstance();\r\n        const logicWorker = WorkerManager.getInstance();\r\n        const viewWorker = ViewWorkerManager.getInstance();\r\n\r\n        this.isUpdating = false;\r\n        this.isRendering = false;\r\n        this.isInitialized = false;\r\n\r\n        this.syncGlobalsToSession(session);\r\n\r\n        AudioManager.getInstance().stopAllByState(this.name);\r\n        AudioManager.getInstance().uncacheByState(this.name);\r\n        SpriteManager.getInstance().uncacheByState(this.name);\r\n\r\n        if (this.controller) this.controller.destroy();\r\n\r\n        this.onBeforeDestroy(session, logicWorker);\r\n\r\n        logicWorker.terminateState(this.name, this.instanceId);\r\n        viewWorker.terminateState(this.name);\r\n\r\n        InputManager.getInstance().reset();\r\n    }\r\n\r\n    protected abstract getConfig(): TConfig;\r\n\r\n    protected abstract getSessionOverrides(session: SharedSession): Partial<TConfig>;\r\n\r\n    protected abstract initMVC(): void;\r\n\r\n    protected async onCustomLoadResources(): Promise<void> {\r\n    }\r\n\r\n    protected onBeforeDestroy(session: SharedSession, worker: WorkerManager): void {\r\n    }\r\n\r\n    private async internalLoadResources(): Promise<void> {\r\n        const config = this.getConfig();\r\n        if (config.manifestPath) {\r\n            await Promise.all([\r\n                SpriteManager.getInstance().loadManifest(config.manifestPath, this.name),\r\n                AudioManager.getInstance().loadManifest(config.manifestPath, this.name)\r\n            ]);\r\n        }\r\n        await this.onCustomLoadResources();\r\n    }\r\n\r\n    private async internalPostInit(worker: WorkerManager, session: SharedSession): Promise<void> {\r\n        const targetConfig = this.getConfig();\r\n\r\n        if (this.isLoadedFromSave) {\r\n            worker.isInitialized = true;\r\n        } else if (this.forceReset) {\r\n            session.clearSavableKeys();\r\n            worker.sendInput(this.name, 'INITIALIZE', targetConfig);\r\n        } else {\r\n            const overrides = this.getSessionOverrides(session);\r\n            const finalConfig = {...targetConfig, ...overrides};\r\n            worker.sendInput(this.name, 'INITIALIZE', finalConfig);\r\n        }\r\n\r\n        if (this.vm && (this.vm as any).notify) {\r\n            (this.vm as any).notify();\r\n        }\r\n\r\n        if (targetConfig.bgmKey) {\r\n            AudioManager.getInstance().play(targetConfig.bgmKey);\r\n        }\r\n    }\r\n\r\n    private syncGlobalsToSession(session: SharedSession): void {\r\n        if (!this.vm) return;\r\n        Object.entries(GLOBAL_SESSION_MAP).forEach(([vmKey, sessionKey]) => {\r\n            if (vmKey in this.vm) {\r\n                session.set(sessionKey, this.vm[vmKey]);\r\n            }\r\n        });\r\n    }\r\n}","// src/core/templates/BaseController.ts\r\nimport {IController} from \"../interfaces/IController\";\r\nimport {WorkerManager} from \"../managers/WorkerManager\";\r\nimport {SaveManager} from \"../managers/SaveManager\";\r\n\r\nexport abstract class BaseController<TVM extends { update: () => void }> implements IController {\r\n    protected workers: WorkerManager;\r\n    protected readonly QUICK_SAVE_KEY = 'quick_save';\r\n\r\n    constructor(protected vm: TVM, protected stateName: string) {\r\n        this.workers = WorkerManager.getInstance();\r\n\r\n        window.addEventListener('keydown', this.handleKeyDown);\r\n        this.workers.logic.addEventListener('message', this.handleWorkerMessage);\r\n\r\n        this.captureInitialState();\r\n    }\r\n\r\n    public update(): void {\r\n        this.vm.update();\r\n    }\r\n\r\n    public destroy(): void {\r\n        window.removeEventListener('keydown', this.handleKeyDown);\r\n        this.workers.logic.removeEventListener('message', this.handleWorkerMessage);\r\n        this.onInternalDestroy();\r\n    }\r\n\r\n    protected abstract onKeyDown(e: KeyboardEvent): void;\r\n\r\n    protected abstract onWorkerEvent(name: string, payload: any): void;\r\n\r\n    protected send(action: string, payload: any = {}): void {\r\n        this.workers.sendInput(this.stateName, action, payload);\r\n    }\r\n\r\n    protected onInternalDestroy(): void {\r\n    }\r\n\r\n    private captureInitialState() {\r\n        setTimeout(async () => {\r\n            await SaveManager.getInstance().performSave(this.QUICK_SAVE_KEY, this.stateName);\r\n        }, 200);\r\n    }\r\n\r\n    private handleWorkerMessage = (e: MessageEvent) => {\r\n        const {type, name, payload} = e.data;\r\n        if (type === 'EVENT') {\r\n            this.onWorkerEvent(name, payload);\r\n        }\r\n    };\r\n\r\n    private handleKeyDown = (e: KeyboardEvent) => {\r\n        // We pass the event to the subclass to handle specifically\r\n        this.onKeyDown(e);\r\n    };\r\n}","// src/core/templates/BasePresenter.ts\r\nimport {IPresenter} from \"../interfaces/IPresenter\";\r\nimport {ViewWorkerManager} from \"../managers/ViewWorkerManager\";\r\n\r\nexport abstract class BasePresenter implements IPresenter {\r\n    private listeners: (() => void)[] = [];\r\n\r\n    protected _sharedViews: Map<string, Float32Array>;\r\n\r\n    constructor() {\r\n        this._sharedViews = ViewWorkerManager.getInstance().sharedViews;\r\n    }\r\n\r\n    public get sharedView(): Float32Array {\r\n        const view = this._sharedViews.get('main') || this._sharedViews.values().next().value;\r\n        if (!view) {\r\n            return new Float32Array(0);\r\n        }\r\n        return view;\r\n    }\r\n\r\n    public getBuffer(name: string): Float32Array | undefined {\r\n        return this._sharedViews.get(name);\r\n    }\r\n\r\n    public setBuffers(views: Map<string, Float32Array>): void {\r\n        this._sharedViews = views;\r\n    }\r\n\r\n    public subscribe(cb: () => void): () => void {\r\n        this.listeners.push(cb);\r\n        return () => {\r\n            this.listeners = this.listeners.filter(l => l !== cb);\r\n        };\r\n    }\r\n\r\n    public update(): void {\r\n        this.notify();\r\n    }\r\n\r\n    protected notify(): void {\r\n        for (let i = 0; i < this.listeners.length; i++) {\r\n            this.listeners[i]();\r\n        }\r\n    }\r\n}"],"names":["GLOBAL_SESSION_MAP","BaseGameState","State","forceReset","logicWorker","WorkerManager","viewWorker","ViewWorkerManager","session","SharedSession","e","dt","frameCount","React","AudioManager","SpriteManager","InputManager","worker","config","targetConfig","overrides","finalConfig","vmKey","sessionKey","BaseController","vm","stateName","action","payload","SaveManager","type","name","BasePresenter","view","views","cb","l","i"],"mappings":"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"}