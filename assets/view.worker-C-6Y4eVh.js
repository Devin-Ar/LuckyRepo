(function(){"use strict";const u={HERO_HP:0,HERO_X:1,HERO_Y:2,ENTITY_COUNT:8,ROCKS_START_INDEX:10,ROCK_STRIDE:3},n={HERO_X:0,HERO_Y:1,HERO_ROTATION:2,HERO_SCALE:3,HERO_HP_DISPLAY:4,HERO_FRAME:5,ACTIVE_ROCK_COUNT:6,ROCKS_START_INDEX:10,ROCK_STRIDE:3};class T{logicView;logicIntView;outputView;setBuffers(t,e,o){this.logicView=t,this.logicIntView=e,this.outputView=o}getSnapshot(){return{}}loadSnapshot(t){}destroy(){}hasBuffers(){return!!(this.logicView&&this.outputView)}}class f extends T{heroRotation=0;globalRockRotation=0;heroFrame=0;update(t,e){if(!this.hasBuffers())return;const o=this.logicView[u.HERO_X],l=this.logicView[u.HERO_Y],R=this.logicView[u.HERO_HP];this.heroRotation+=.03*(t/16.67),this.heroFrame+=.15*(t/16.67),this.outputView[n.HERO_X]=o,this.outputView[n.HERO_Y]=l,this.outputView[n.HERO_ROTATION]=this.heroRotation,this.outputView[n.HERO_SCALE]=.5+R/100,this.outputView[n.HERO_HP_DISPLAY]=R,this.outputView[n.HERO_FRAME]=this.heroFrame;const h=this.logicView[u.ENTITY_COUNT];this.outputView[n.ACTIVE_ROCK_COUNT]=h,this.globalRockRotation+=.02*(t/16.67);for(let a=0;a<h;a++){const E=u.ROCKS_START_INDEX+a*u.ROCK_STRIDE,c=n.ROCKS_START_INDEX+a*n.ROCK_STRIDE;this.outputView[c]=this.logicView[E],this.outputView[c+1]=this.logicView[E+1];const i=this.logicView[E+2],V=(Math.floor(i)%5+1)*.5;this.outputView[c+2]=this.globalRockRotation*V+i}}getSnapshot(){return{heroRotation:this.heroRotation,globalRockRotation:this.globalRockRotation,heroFrame:this.heroFrame}}loadSnapshot(t){t&&(this.heroRotation=t.heroRotation??0,this.globalRockRotation=t.globalRockRotation??0,this.heroFrame=t.heroFrame??0)}}const p={HERO_HP:0,ENERGY:1,SCRAP_COUNT:2},r={HERO_HP_DISPLAY:0,ENERGY_DISPLAY:1,SCRAP_DISPLAY:2,UI_BOUNCE:3,GLITCH_INTENSITY:4,VIGNETTE_PULSE:5};class I extends T{uiBounce=0;glitchIntensity=0;lastHp=-1;update(t,e){if(!this.hasBuffers())return;const o=this.logicView[p.HERO_HP],l=this.logicView[p.ENERGY];this.lastHp!==-1&&o<this.lastHp&&(this.glitchIntensity=1),this.lastHp=o,this.glitchIntensity*=.92,this.outputView[r.HERO_HP_DISPLAY]=o,this.outputView[r.ENERGY_DISPLAY]=l,this.outputView[r.SCRAP_DISPLAY]=this.logicView[p.SCRAP_COUNT];const R=t/16.67;this.uiBounce+=.05*R;const h=l<20?.15:.05,a=.5+Math.sin(e*h)*.2;this.outputView[r.UI_BOUNCE]=Math.sin(this.uiBounce)*5,this.outputView[r.GLITCH_INTENSITY]=this.glitchIntensity,this.outputView[r.VIGNETTE_PULSE]=a}getSnapshot(){return{uiBounce:this.uiBounce,glitchIntensity:this.glitchIntensity,lastHp:this.lastHp}}loadSnapshot(t){t&&(this.uiBounce=t.uiBounce??0,this.glitchIntensity=t.glitchIntensity??0,this.lastHp=t.lastHp??-1)}}let _,S,w;const s=new Map;self.onmessage=g=>{const{type:t,stateName:e,payload:o,dt:l,frameCount:R}=g.data;switch(t){case"INIT_SABS":console.log("[ViewWorker] Initializing Buffers");const h=o.inputBuffer;_=new Float32Array(h),S=new Int32Array(h);const a=o.outputBuffer;w=new Float32Array(a),s.forEach(i=>{typeof i.setBuffers=="function"&&i.setBuffers(_,S,w)});break;case"CREATE_STATE":if(!s.has(e)){console.log(`[ViewWorker] Created ViewLogic for: ${e}`);let i;e==="Game1"&&(i=new f),e==="Game2"&&(i=new I),i&&(s.set(e,i),_&&w&&i.setBuffers(_,S,w))}break;case"TERMINATE_STATE":s.has(e)&&(s.get(e).destroy?.(),s.delete(e));break;case"TERMINATE_ALL":s.forEach(i=>i.destroy?.()),s.clear();break;case"TICK":const E=s.get(e);E&&_&&w&&E.update(l,R);break;case"INPUT":const c=s.get(e);if(!c)return;if(o.action==="GET_SNAPSHOT"){const i=g.ports[0];i&&i.postMessage(c.getSnapshot())}else o.action==="LOAD_SNAPSHOT"&&c.loadSnapshot(o.data);break}}})();
