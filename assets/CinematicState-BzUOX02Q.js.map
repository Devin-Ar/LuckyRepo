{"version":3,"file":"CinematicState-BzUOX02Q.js","sources":["../../src/features/Cinematic/CinematicController.ts","../../src/features/Cinematic/CinematicView.tsx","../../src/features/Cinematic/CinematicState.ts"],"sourcesContent":["// src/features/Cinematic/CinematicController.ts\r\nimport { CampaignManager } from \"../../core/managers/CampaignManager\";\r\nimport { InputManager } from \"../../core/managers/InputManager\";\r\nimport { BaseMenuController } from \"../../core/templates/BaseMenuController\";\r\n\r\nexport class CinematicController extends BaseMenuController {\r\n    private onUpdate?: (alpha: number) => void;\r\n    private hasCompleted: boolean = false;\r\n\r\n    public bind(callback: (alpha: number) => void) {\r\n        this.onUpdate = callback;\r\n    }\r\n\r\n    protected onKeyDown(e: KeyboardEvent) {\r\n        const input = InputManager.getInstance();\r\n        if (input.isKeyAction(e.key, \"UI_ACCEPT\")) {\r\n            this.exit();\r\n        }\r\n    }\r\n\r\n    public async startSequence(fadeInMs: number, stayMs: number, fadeOutMs: number) {\r\n        try {\r\n            await this.animateAlpha(0, 1, fadeInMs);\r\n            await this.wait(stayMs);\r\n            await this.animateAlpha(1, 0, fadeOutMs);\r\n            this.exit();\r\n        } catch (e) {\r\n        }\r\n    }\r\n\r\n    private wait(ms: number): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            const timer = setTimeout(resolve, ms);\r\n            const check = () => {\r\n                if (this.hasCompleted) {\r\n                    clearTimeout(timer);\r\n                    reject();\r\n                } else {\r\n                    requestAnimationFrame(check);\r\n                }\r\n            };\r\n            requestAnimationFrame(check);\r\n        });\r\n    }\r\n\r\n    private animateAlpha(start: number, end: number, duration: number): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            const startTime = performance.now();\r\n            const tick = (now: number) => {\r\n                if (this.hasCompleted) {\r\n                    reject();\r\n                    return;\r\n                }\r\n                const elapsed = now - startTime;\r\n                const progress = Math.min(elapsed / duration, 1);\r\n                const alpha = start + (end - start) * progress;\r\n                this.onUpdate?.(alpha);\r\n\r\n                if (progress < 1) requestAnimationFrame(tick);\r\n                else resolve();\r\n            };\r\n            requestAnimationFrame(tick);\r\n        });\r\n    }\r\n\r\n    private exit() {\r\n        if (this.hasCompleted) return;\r\n        this.hasCompleted = true;\r\n        this.onUpdate?.(0);\r\n        CampaignManager.getInstance().completeCurrentStep();\r\n    }\r\n\r\n    public onBack(): void {\r\n        this.exit();\r\n    }\r\n}","// src/features/Cinematic/CinematicView.ts\r\nimport React, { useState, useEffect, useMemo } from 'react';\r\nimport * as PIXI from 'pixi.js';\r\nimport { Stage, useApp } from '@pixi/react';\r\nimport { GameSprite } from '../../components/GameSprite';\r\nimport { CinematicController } from './CinematicController';\r\nimport { SpriteManager } from '../../core/managers/SpriteManager';\r\n\r\n// NTS: Make this a component 'cause it is identical everywhere\r\nconst CinematicForceResizer: React.FC<{ w: number, h: number }> = ({ w, h }) => {\r\n    const app = useApp();\r\n    useEffect(() => {\r\n        if (app?.renderer) {\r\n            app.renderer.resize(w, h);\r\n            PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;\r\n            PIXI.settings.ROUND_PIXELS = true;\r\n\r\n            if (app.view instanceof HTMLCanvasElement) {\r\n                app.view.width = w;\r\n                app.view.height = h;\r\n                app.view.style.imageRendering = 'pixelated';\r\n            }\r\n        }\r\n    }, [app, w, h]);\r\n    return null;\r\n};\r\n\r\ninterface CinematicViewProps {\r\n    controller: CinematicController;\r\n    imageName: string;\r\n    width?: number;\r\n    height?: number;\r\n}\r\n\r\nexport const CinematicView: React.FC<CinematicViewProps> = ({\r\n                                                                controller, imageName, width = 960, height = 540\r\n                                                            }) => {\r\n    const [alpha, setAlpha] = useState(0);\r\n\r\n    useEffect(() => {\r\n        controller.bind(setAlpha);\r\n        controller.startSequence(800, 2500, 800);\r\n        }, [controller]);\r\n\r\n    const stageOptions = useMemo(() => ({\r\n        backgroundColor: 0x000000,\r\n        antialias: false,\r\n        resolution: 1,\r\n        autoDensity: false\r\n    }), []);\r\n\r\n    const stageStyle = useMemo(() => ({\r\n        position: 'absolute',\r\n        inset: 0,\r\n        width: '100%',\r\n        height: '100%',\r\n        display: 'block',\r\n        imageRendering: 'pixelated'\r\n    } as React.CSSProperties), []);\r\n\r\n    const imageScale = useMemo(() => {\r\n        const texture = SpriteManager.getInstance().getTexture(imageName);\r\n        return texture && texture.width > 1 ? width / texture.width : width / 640;\r\n    }, [imageName, width]);\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'absolute', inset: 0, background: '#000',\r\n            display: 'flex', alignItems: 'center', justifyContent: 'center', overflow: 'hidden'\r\n        }}>\r\n            <div style={{\r\n                position: 'relative',\r\n                width: '100%', height: '100%',\r\n                maxWidth: 'calc(100vh * (16 / 9))',\r\n                maxHeight: 'calc(100vw * (9 / 16))',\r\n                aspectRatio: '16 / 9',\r\n                background: '#000',\r\n                overflow: 'hidden'\r\n            }}>\r\n                <Stage\r\n                    width={width}\r\n                    height={height}\r\n                    options={stageOptions}\r\n                    style={stageStyle}\r\n                >\r\n                    <CinematicForceResizer w={width} h={height} />\r\n                    <GameSprite\r\n                        imageName={imageName}\r\n                        x={width / 2}\r\n                        y={height / 2}\r\n                        anchor={0.5}\r\n                        alpha={alpha}\r\n                        scale={imageScale}\r\n                    />\r\n                </Stage>\r\n            </div>\r\n        </div>\r\n    );\r\n};","// src/features/Cinematic/CinematicState.ts\r\nimport React, { JSX } from 'react';\r\nimport { State } from '../../core/templates/State';\r\nimport { FeatureEnum } from '../FeatureEnum';\r\nimport { CinematicController } from './CinematicController';\r\nimport { CinematicView } from './CinematicView';\r\nimport {SpriteManager} from \"../../core/managers/SpriteManager\";\r\nimport {InputManager} from \"../../core/managers/InputManager\";\r\n\r\nexport class CinematicState extends State {\r\n    public name = FeatureEnum.CINEMATIC;\r\n    private controller: CinematicController;\r\n    private params: any;\r\n\r\n    constructor(params?: any) {\r\n        super();\r\n        this.params = params || {};\r\n        this.controller = new CinematicController();\r\n    }\r\n\r\n    public async init(): Promise<void> {\r\n        if (this.params.manifestPath) {\r\n            await Promise.all([\r\n                SpriteManager.getInstance().loadManifest(this.params.manifestPath, this.name)\r\n            ]);\r\n        }\r\n        InputManager.getInstance().refreshBindings(this.name);\r\n        this.isRendering = true;\r\n        this.controller.init(this.name as FeatureEnum);\r\n    }\r\n\r\n    public update(dt: number): void {}\r\n\r\n    public getView(): JSX.Element {\r\n        return React.createElement(CinematicView, {\r\n            key: this.name,\r\n            controller: this.controller,\r\n            imageName: this.params.imageName,\r\n        });\r\n    }\r\n\r\n    public destroy(): void {\r\n        InputManager.getInstance().refreshBindings(this.name);\r\n        this.controller.destroy();\r\n    }\r\n}"],"names":["CinematicController","BaseMenuController","callback","InputManager","fadeInMs","stayMs","fadeOutMs","ms","resolve","reject","timer","check","start","end","duration","startTime","tick","now","elapsed","progress","alpha","CampaignManager","CinematicForceResizer","w","h","app","useApp","useEffect","PIXI.settings","PIXI.SCALE_MODES","CinematicView","controller","imageName","width","height","setAlpha","useState","stageOptions","useMemo","stageStyle","imageScale","texture","SpriteManager","jsx","jsxs","Stage","GameSprite","CinematicState","State","FeatureEnum","params","dt","React"],"mappings":"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"}