import{B as o}from"./BHLogicSchema-j6k_AvBl.js";import{B as w,a as g}from"./BaseDispatcher-CXAw-hAN.js";const S={INITIALIZE:{execute(p,e){p.applyConfig(e),p.setInitialized(!0)}},MOVEMENT:{execute(p,e){p.setMovement(e.vx,e.vy)}},TAKE_DAMAGE:{execute(p,e){const t=e.amount??15;p.modifyHp(-t)}}};class v{seed;height;width;x;y;vx;vy;damage;active;hitbox;playerRelative;type;constructor(e,t){this.x=e,this.y=t,this.vx=0,this.vy=0,this.damage=0,this.height=0,this.width=0,this.seed=Math.random()*1e3,this.active=!1,this.hitbox={offsetX:0,offsetY:0},this.playerRelative=0,this.type="projectile"}}class f extends v{speed=8;constructor(e,t,a,s){super(e,t),this.active=!0;const h=s.width*a.mouseX-this.x,n=s.height*a.mouseY-this.y;this.playerRelative=Math.atan2(n,h),this.vx=Math.cos(this.playerRelative)*this.speed,this.vy=Math.sin(this.playerRelative)*this.speed,this.damage=-20,this.height=20,this.width=20,this.type="bullet"}update(e,t){this.x+=this.vx,this.y+=this.vy,(this.x<0||this.x>t.width||this.y<0||this.y>t.height)&&(this.active=!1)}collided(e){for(const t of e){if(!this.active)break;t.active&&(this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y&&(t.modifyHP(this.damage),this.active=!1),t.health<=0&&(t.active=!1))}}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y}}class D extends v{speed=8;constructor(e,t,a,s){super(e,t),this.active=!0;const h=a-this.x,n=s-this.y;this.playerRelative=Math.atan2(n,h),this.vx=Math.cos(this.playerRelative)*this.speed,this.vy=Math.sin(this.playerRelative)*this.speed,this.damage=-20,this.height=20,this.width=20,this.type="onebullet"}update(e,t){this.x+=this.vx,this.y+=this.vy,(this.x<0||this.x>t.width||this.y<0||this.y>t.height)&&(this.active=!1)}collided(e){this.active&&this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.y+this.height>e.y&&(e.modifyHp(this.damage),this.active=!1)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y}}class d{static instance;active;height;hitbox;hp;moveSpeed;vx;vy;width;seed;playerRelative;x;y;type;currentFrame=0;lastHitFrame=0;bulletTime=Date.now();fireFlag=!1;config;constructor(){this.active=!0,this.x=0,this.y=0,this.vx=0,this.vy=0,this.playerRelative=0,this.hitbox={offsetX:0,offsetY:0},this.height=30,this.width=30,this.hp=100,this.moveSpeed=0,this.seed=Math.random()*1e3,this.type="player"}static getInstance(){return d.instance||(d.instance=new d),d.instance}applyConfig(e){this.config=e,this.hp=e.initialHP,this.x=e.heroStartX,this.y=e.heroStartY,this.moveSpeed=e.moveSpeed}setMovement(e,t){e!==void 0&&(this.vx=e),t!==void 0&&(this.vy=t)}modifyHp(e){this.hp=Math.max(0,Math.min(100,this.hp+e)),e<0&&this.triggerHitCooldown()}triggerHitCooldown(){this.lastHitFrame=this.currentFrame}playerAction(){const e=this.fireFlag;return this.fireFlag=!1,e}fireProjectile(e,t){return new f(this.x,this.y,e,t)}updatePlayer(e,t,a){this.currentFrame=a,this.update(e,t)}update(e,t){const a=e.actions;if(a===void 0)return;let s=0,h=0;a.includes("MOVE_UP")&&(h=-this.moveSpeed),a.includes("MOVE_DOWN")&&(h=this.moveSpeed),a.includes("MOVE_LEFT")&&(s=-this.moveSpeed),a.includes("MOVE_RIGHT")&&(s=this.moveSpeed),e.isMouseDown&&this.bulletTime+250<Date.now()&&(this.bulletTime=Date.now(),this.fireFlag=!0),this.setMovement(s,h),this.currentFrame-this.lastHitFrame>120&&this.hp<100&&(this.hp=Math.min(100,this.hp+(this.hp<25?.3:.1))),this.x=Math.max(0,Math.min(this.config.width,this.x+this.vx)),this.y=Math.max(0,Math.min(this.config.height,this.y+this.vy))}}class y{active;height;playerRelative;hitbox;seed;width;health;x;y;vx;vy;type;constructor(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.health=0,this.hitbox={offsetX:0,offsetY:0},this.height=0,this.width=0,this.seed=Math.random()*1e3,this.active=!1,this.playerRelative=0,this.type="unknown"}modifyHP(e){this.active&&(this.health+=e),this.health<0&&(this.active=!1)}}class x extends y{timeElapsed;atkBox;followRun;primedMode;constructor(e,t){super(),this.x=e,this.y=t,this.width=50,this.height=52,this.health=100,this.timeElapsed=Date.now()+Math.random()*1e3,this.atkBox={eX:0,eY:0},this.followRun=!1,this.primedMode=!1,this.active=!0,this.type="rock"}update(e,t){this.orientation(e),this.processRock(e,t),this.processRockAttacks(e,t)}orientation(e){const t=this.x-e.x,a=this.y-e.y;this.playerRelative=Math.atan2(a,t)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.seed,e[t+3]=this.primedMode?1:0,e[t+4]=this.atkBox.eX,e[t+5]=this.atkBox.eY}processRock(e,t){if(this.primedMode)return;const a=this.x-e.x,s=this.y-e.y,h=a*a+s*s,n=Math.sqrt(a*a+s*s);this.followRun?(this.vx*=0,this.vy*=0):(this.vx=t.moveSpeed-1,this.vy=t.moveSpeed-1,n>200&&(this.vx*=a>0?-1:1,this.vy*=s>0?-1:1),n<250&&(this.vx*=a>0?1:-1,this.vy*=s>0?1:-1)),this.vx=this.x<=0?1:this.vx,this.vx=this.x>=t.width?-1:this.vx,this.vy=this.y<=0?1:this.vy,this.vy=this.y>=t.height?-1:this.vy,this.x+=this.vx,this.y+=this.vy,this.followRun=n>200&&n<250,h<1600&&(this.vx*=-1.1,this.vy*=-1.1,e.modifyHp(-.2),self.postMessage({type:"EVENT",name:"EXPLOSION_REQ"}))}processRockAttacks(e,t){const a=Date.now()-this.timeElapsed;if(a>5e3&&!this.primedMode&&(this.primedMode=!0,this.atkBox={eX:e.x,eY:e.y}),this.primedMode&&a>7e3){const s=(this.atkBox.eY-this.y)/(this.atkBox.eX-this.x),h=this.y-s*this.x,n=Math.abs(s*e.x+-1*e.y+h),i=Math.sqrt(s*s+1);n/i<30&&Math.min(this.atkBox.eX,this.x)<=e.x&&e.x<=Math.max(this.atkBox.eX,this.x)&&Math.min(this.atkBox.eY,this.y)<=e.y&&e.y<=Math.max(this.atkBox.eY,this.y)&&e.modifyHp(-10),this.timeElapsed=Date.now(),this.primedMode=!1,this.atkBox={eX:0,eY:0}}}}class T extends y{timeElapsed;followRun;primedMode;constructor(e,t){super(),this.x=e,this.y=t,this.width=50,this.height=52,this.health=100,this.timeElapsed=Date.now()+Math.random()*1e3,this.followRun=!1,this.primedMode=!1,this.active=!0,this.type="singleShot"}updateProjectile(e,t,a){this.update(e,t),this.processShotAttacks(e,a)}update(e,t){this.orientation(e),this.processShot(e,t)}orientation(e){const t=this.x-e.x,a=this.y-e.y;this.playerRelative=Math.atan2(a,t)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.seed,e[t+3]=this.primedMode?1:0}processShot(e,t){if(this.primedMode)return;const a=this.x-e.x,s=this.y-e.y,h=a*a+s*s,n=Math.sqrt(a*a+s*s);this.followRun?(this.vx*=0,this.vy*=0):(this.vx=t.moveSpeed-1,this.vy=t.moveSpeed-1,n>200&&(this.vx*=a>0?-1:1,this.vy*=s>0?-1:1),n<250&&(this.vx*=a>0?1:-1,this.vy*=s>0?1:-1)),this.vx=this.x<=0?1:this.vx,this.vx=this.x>=t.width?-1:this.vx,this.vy=this.y<=0?1:this.vy,this.vy=this.y>=t.height?-1:this.vy,this.x=Math.floor(this.x+this.vx),this.y=Math.floor(this.y+this.vy),this.followRun=n>200&&n<250,h<1600&&(this.vx*=-1.1,this.vy*=-1.1,e.modifyHp(-.2),self.postMessage({type:"EVENT",name:"EXPLOSION_REQ"}))}processShotAttacks(e,t){Date.now()-this.timeElapsed>5e3+Math.floor(Math.random()*3e3)&&!this.primedMode&&(this.primedMode=!0),this.primedMode&&(t.push(new D(this.x,this.y,e.x,e.y)),this.timeElapsed=Date.now(),this.primedMode=!1)}}class r{waveDefinitions=[];currentWave=-1;waveState="IDLE";delayTimer=0;totalWaves=0;loadWaves(e){this.waveDefinitions=e,this.totalWaves=e.length,this.currentWave=-1,this.waveState="IDLE",this.delayTimer=0}start(){this.currentWave=0,this.waveState="DELAY",this.delayTimer=this.waveDefinitions[0]?.delayBeforeStart??60}update(e){if(this.waveState==="IDLE"||this.waveState==="ALL_CLEARED")return null;if(this.waveState==="DELAY"){if(this.delayTimer--,this.delayTimer<=0){this.waveState="ACTIVE";const t=this.waveDefinitions[this.currentWave];if(t)return t.enemies}return null}return this.waveState==="ACTIVE"?(e<=0&&(this.waveState="CLEARED"),null):this.waveState==="CLEARED"?this.currentWave+1>=this.totalWaves?(this.waveState="ALL_CLEARED",null):(this.currentWave++,this.waveState="DELAY",this.delayTimer=this.waveDefinitions[this.currentWave]?.delayBeforeStart??60,null):null}static spawnFromDefinitions(e,t){const a=[];for(const s of e){const h=s.spawnX*t.width,n=s.spawnY*t.height;let i;Math.random()>.5?i=new T(h,n):i=new x(h,n),i.health=s.hp,"moveSpeed"in s&&(i._waveSpeed=s.moveSpeed),"contactDamage"in s&&s.damageType==="contact"&&(i._contactDamage=s.contactDamage),a.push(i)}return a}getCurrentWave(){return Math.max(0,this.currentWave)}getTotalWaves(){return this.totalWaves}getState(){return this.waveState}getDelayTimer(){return this.delayTimer}isAllCleared(){return this.waveState==="ALL_CLEARED"}getSnapshot(){return{currentWave:this.currentWave,waveState:this.waveState,delayTimer:this.delayTimer,totalWaves:this.totalWaves}}loadSnapshot(e){e&&(this.currentWave=e.currentWave??-1,this.waveState=e.waveState??"IDLE",this.delayTimer=e.delayTimer??0,this.totalWaves=e.totalWaves??0)}}var u={"Level 1":{waves:[{waveIndex:0,delayBeforeStart:60,enemies:[{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.2,spawnX:.2,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.2,spawnX:.4,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.2,spawnX:.6,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.2,spawnX:.8,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.2,spawnX:.5,spawnY:.1}]},{waveIndex:1,delayBeforeStart:90,enemies:[{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.3,spawnX:.15,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.3,spawnX:.35,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.3,spawnX:.55,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.3,spawnX:.75,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:4,contactDamage:.3,spawnX:.9,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:4,contactDamage:.3,spawnX:.3,spawnY:.05},{damageType:"contact",hp:12,moveSpeed:4,contactDamage:.3,spawnX:.7,spawnY:.05}]},{waveIndex:2,delayBeforeStart:120,enemies:[{damageType:"contact",hp:12,moveSpeed:4.5,contactDamage:.4,spawnX:.1,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:4.5,contactDamage:.4,spawnX:.25,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:4.5,contactDamage:.4,spawnX:.4,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:4.5,contactDamage:.4,spawnX:.55,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:4.5,contactDamage:.4,spawnX:.7,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:4.5,contactDamage:.4,spawnX:.85,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:4.5,contactDamage:.5,spawnX:.3,spawnY:.05},{damageType:"contact",hp:15,moveSpeed:4.5,contactDamage:.5,spawnX:.5,spawnY:.05},{damageType:"contact",hp:15,moveSpeed:4.5,contactDamage:.5,spawnX:.7,spawnY:.05},{damageType:"contact",hp:20,moveSpeed:4.5,contactDamage:.5,spawnX:.5,spawnY:.02}]}]},"Level 2":{waves:[{waveIndex:0,delayBeforeStart:60,enemies:[{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.2,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.4,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.6,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.8,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.3,spawnY:.05},{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.5,spawnY:.05},{damageType:"contact",hp:12,moveSpeed:5,contactDamage:.3,spawnX:.7,spawnY:.05}]},{waveIndex:1,delayBeforeStart:90,enemies:[{damageType:"contact",hp:14,moveSpeed:5.5,contactDamage:.4,spawnX:.1,spawnY:.1},{damageType:"contact",hp:14,moveSpeed:5.5,contactDamage:.4,spawnX:.25,spawnY:.1},{damageType:"contact",hp:14,moveSpeed:5.5,contactDamage:.4,spawnX:.4,spawnY:.1},{damageType:"contact",hp:14,moveSpeed:5.5,contactDamage:.4,spawnX:.55,spawnY:.1},{damageType:"contact",hp:14,moveSpeed:5.5,contactDamage:.4,spawnX:.7,spawnY:.1},{damageType:"contact",hp:14,moveSpeed:5.5,contactDamage:.4,spawnX:.85,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.4,spawnX:.3,spawnY:.05},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.4,spawnX:.5,spawnY:.05},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.4,spawnX:.7,spawnY:.05},{damageType:"contact",hp:20,moveSpeed:6,contactDamage:.5,spawnX:.5,spawnY:.02}]},{waveIndex:2,delayBeforeStart:120,enemies:[{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.1,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.2,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.3,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.4,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.5,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.6,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.7,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.8,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:6,contactDamage:.5,spawnX:.9,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7,contactDamage:.6,spawnX:.3,spawnY:.02},{damageType:"contact",hp:20,moveSpeed:7,contactDamage:.6,spawnX:.5,spawnY:.02},{damageType:"contact",hp:20,moveSpeed:7,contactDamage:.6,spawnX:.7,spawnY:.02}]}]},"Level 3":{waves:[{waveIndex:0,delayBeforeStart:45,enemies:[{damageType:"contact",hp:15,moveSpeed:6,contactDamage:.4,spawnX:.15,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:6,contactDamage:.4,spawnX:.3,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:6,contactDamage:.4,spawnX:.45,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:6,contactDamage:.4,spawnX:.6,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:6,contactDamage:.4,spawnX:.75,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:6,contactDamage:.4,spawnX:.9,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.2,spawnY:.05},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.5,spawnY:.05},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.8,spawnY:.05}]},{waveIndex:1,delayBeforeStart:75,enemies:[{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.1,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.2,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.3,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.4,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.5,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.6,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.7,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.8,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:7,contactDamage:.5,spawnX:.9,spawnY:.1},{damageType:"contact",hp:22,moveSpeed:7.5,contactDamage:.6,spawnX:.25,spawnY:.02},{damageType:"contact",hp:22,moveSpeed:7.5,contactDamage:.6,spawnX:.5,spawnY:.02},{damageType:"contact",hp:22,moveSpeed:7.5,contactDamage:.6,spawnX:.75,spawnY:.02}]},{waveIndex:2,delayBeforeStart:90,enemies:[{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.05,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.15,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.25,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.35,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.45,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.55,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.65,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.75,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.85,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:7.5,contactDamage:.6,spawnX:.95,spawnY:.1},{damageType:"contact",hp:25,moveSpeed:8,contactDamage:.7,spawnX:.2,spawnY:.02},{damageType:"contact",hp:25,moveSpeed:8,contactDamage:.7,spawnX:.4,spawnY:.02},{damageType:"contact",hp:25,moveSpeed:8,contactDamage:.7,spawnX:.6,spawnY:.02},{damageType:"contact",hp:25,moveSpeed:8,contactDamage:.7,spawnX:.8,spawnY:.02},{damageType:"contact",hp:30,moveSpeed:8,contactDamage:1,spawnX:.5,spawnY:.01}]}]}};class l extends w{dispatcher;player;entities=[];playerProjectiles=[];enemyProjectiles=[];currentFrame=0;waveManager=new r;wavesStarted=!1;exitDoorActive=!1;exitDoorX=0;exitDoorY=0;static DOOR_SIZE=60;exitDoorEntered=!1;constructor(){super(o.REVISION),this.dispatcher=new g(this,S,"BHTest"),this.player=d.getInstance()}applyConfig(e){this.config=e,this.player.applyConfig(e);const t=e.levelLabel||"Level 1",a=u[t];a&&a.waves?this.waveManager.loadWaves(a.waves):(console.warn(`[BHTestLogic] No wave data for "${t}", using empty waves`),this.waveManager.loadWaves([])),this.entities=[],this.playerProjectiles=[],this.enemyProjectiles=[],this.wavesStarted=!1,this.exitDoorActive=!1,this.exitDoorEntered=!1,this.exitDoorX=e.width/2,this.exitDoorY=e.height/2}destroy(){super.destroy(),this.entities=[],this.playerProjectiles=[],this.enemyProjectiles=[],this.wavesStarted=!1}getSnapshot(){return{player:{...this.player},entities:[...this.entities],playerProjectiles:[...this.playerProjectiles],enemyProjectiles:[...this.enemyProjectiles],currentFrame:this.currentFrame,config:this.config,waveSnapshot:this.waveManager.getSnapshot(),wavesStarted:this.wavesStarted}}loadSnapshot(e){e&&(this.config=e.config,this.player=e.player,this.entities=e.entities,this.playerProjectiles=e.playerProjectiles,this.enemyProjectiles=e.enemyProjectiles,this.currentFrame=e.currentFrame??0,this.wavesStarted=e.wavesStarted??!1,e.waveSnapshot&&this.waveManager.loadSnapshot(e.waveSnapshot),this.isInitialized=!0)}onUpdate(e,t,a,s){if(!this.config)return;this.currentFrame=a,this.wavesStarted||(this.waveManager.start(),this.wavesStarted=!0);const h=this.entities.filter(i=>i.active).length,n=this.waveManager.update(h);if(n){const i=r.spawnFromDefinitions(n,this.config);this.entities.push(...i)}this.player.updatePlayer(this.inputState,this.config,a);for(const i of this.entities)i.type==="singleShot"&&i.updateProjectile(this.player,this.config,this.enemyProjectiles),i.update(this.player,this.config);this.player.playerAction()&&this.playerProjectiles.push(this.player.fireProjectile(this.inputState,this.config));for(const i of this.playerProjectiles)i.update(this.player,this.config),i.collided(this.entities);for(const i of this.enemyProjectiles)i.update(this.player,this.config),i.collided(this.player);if(this.playerProjectiles=this.playerProjectiles.filter(i=>i.active),this.enemyProjectiles=this.enemyProjectiles.filter(i=>i.active),this.entities=this.entities.filter(i=>i.active),this.player.hp<=0&&self.postMessage({type:"EVENT",name:"PLAYER_DEAD"}),this.waveManager.isAllCleared()&&this.entities.length===0&&(self.postMessage({type:"EVENT",name:"ROOM_CLEARED"}),this.exitDoorActive||(this.exitDoorActive=!0)),this.exitDoorActive&&!this.exitDoorEntered){const i=l.DOOR_SIZE/2,c=this.player.x,m=this.player.y;c>=this.exitDoorX-i&&c<=this.exitDoorX+i&&m>=this.exitDoorY-i&&m<=this.exitDoorY+i&&(this.exitDoorEntered=!0,self.postMessage({type:"EVENT",name:"EXIT_DOOR_ENTERED"}))}this.syncToSAB(e,a,s)}syncToSAB(e,t,a){e[o.HERO_HP]=this.player.hp,e[o.HERO_X]=this.player.x,e[o.HERO_Y]=this.player.y,e[o.ENTITY_COUNT]=this.entities.length,e[o.CURRENT_WAVE]=this.waveManager.getCurrentWave(),e[o.TOTAL_WAVES]=this.waveManager.getTotalWaves(),e[o.WAVE_DELAY_TIMER]=this.waveManager.getDelayTimer();const s={IDLE:0,DELAY:1,ACTIVE:2,CLEARED:3,ALL_CLEARED:4};e[o.WAVE_STATE]=s[this.waveManager.getState()]??0,e[o.EXIT_DOOR_ACTIVE]=this.exitDoorActive?1:0,e[o.EXIT_DOOR_X]=this.exitDoorX,e[o.EXIT_DOOR_Y]=this.exitDoorY;const h=this.config.levelLabel||"Level 1",n=h==="Level 3"?2:h==="Level 2"?1:0;e[o.CURRENT_LEVEL]=n,this.entities.forEach((i,c)=>{const m=o.ROCKS_START_INDEX+c*o.ROCK_STRIDE;i.syncToSAB(e,m)}),e[o.PPROJ_START_INDEX-1]=this.playerProjectiles.length,this.playerProjectiles.forEach((i,c)=>{const m=o.PPROJ_START_INDEX+c*o.PPROJ_STRIDE;i.syncToSAB(e,m)}),e[o.EPROJ_START_INDEX-1]=this.enemyProjectiles.length,this.enemyProjectiles.forEach((i,c)=>{const m=o.EPROJ_START_INDEX+c*o.EPROJ_STRIDE;i.syncToSAB(e,m)})}}export{l as BHTestLogic};
//# sourceMappingURL=BHTestLogic-OQpOb4Hg.js.map
