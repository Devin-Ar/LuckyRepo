import{B as D,a as T,b as R,c as E}from"./BHLogicSchema-Hm6nHXsy.js";import{B as L,a as A}from"./BaseDispatcher-CXAw-hAN.js";const P={INITIALIZE:{execute(r,e){r.applyConfig(e),r.setInitialized(!0)}},MOVEMENT:{execute(r,e){r.setMovement(e.vx,e.vy)}},TAKE_DAMAGE:{execute(r,e){const t=e.amount??15;r.modifyHp(-t)}}};class Y{seed;height;width;x;y;vx;vy;damage;active;hitbox;playerRelative;type;health;constructor(e,t){this.x=e,this.y=t,this.vx=0,this.vy=0,this.damage=0,this.height=0,this.width=0,this.seed=Math.random()*1e3,this.active=!1,this.hitbox={offsetX:0,offsetY:0},this.playerRelative=0,this.health=0,this.type="projectile"}orientation(e){throw new Error("Method not implemented.")}modifyHP(e){this.active=!1}}class b extends Y{speed=8;constructor(e,t,a,i){super(e,t),this.active=!0;const n=i.width*a.mouseX-this.x,o=i.height*a.mouseY-this.y;this.playerRelative=Math.atan2(o,n),this.vx=Math.cos(this.playerRelative)*this.speed,this.vy=Math.sin(this.playerRelative)*this.speed,this.damage=-20,this.height=20,this.width=20,this.type="bullet"}update(e,t){this.x+=this.vx,this.y+=this.vy,(this.x<0||this.x>t.width||this.y<0||this.y>t.height)&&(this.active=!1)}collided(e){for(const t of e){if(!this.active)break;t.active&&(this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y&&(t.modifyHP(this.damage),this.active=!1),t.health<=0&&(t.active=!1))}}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.width,e[t+3]=this.height,e[t+4]=this.seed}}class S extends Y{speed=8;constructor(e,t,a,i){super(e,t),this.active=!0;const n=a-this.x,o=i-this.y;this.playerRelative=Math.atan2(o,n),this.vx=Math.cos(this.playerRelative)*this.speed,this.vy=Math.sin(this.playerRelative)*this.speed,this.damage=-20,this.height=20,this.width=20,this.type="onebullet"}update(e,t){this.x+=this.vx,this.y+=this.vy,(this.x<0||this.x>t.width||this.y<0||this.y>t.height)&&(this.active=!1)}collided(e){this.active&&this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.y+this.height>e.y&&(e.modifyHp(this.damage),this.active=!1)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.width,e[t+3]=this.height,e[t+4]=this.seed}}class g{static instance;active;height;hitbox;hp;health;moveSpeed;vx;vy;width;seed;playerRelative;x;y;type;currentFrame=0;lastHitFrame=0;bulletTime=Date.now();fireFlag=!1;config;constructor(){this.active=!0,this.x=0,this.y=0,this.vx=0,this.vy=0,this.playerRelative=0,this.hitbox={offsetX:0,offsetY:0},this.height=30,this.width=30,this.hp=100,this.health=100,this.moveSpeed=0,this.seed=Math.random()*1e3,this.type="player"}static getInstance(){return g.instance||(g.instance=new g),g.instance}applyConfig(e){this.config=e,this.hp=e.initialHP,this.health=e.initialHP,this.x=e.heroStartX,this.y=e.heroStartY,this.moveSpeed=e.moveSpeed}setMovement(e,t){e!==void 0&&(this.vx=e),t!==void 0&&(this.vy=t)}modifyHp(e){this.hp=Math.max(0,Math.min(100,this.hp+e)),this.health=this.hp,e<0&&this.triggerHitCooldown()}modifyHP(e){this.modifyHp(e)}triggerHitCooldown(){this.lastHitFrame=this.currentFrame}playerAction(){const e=this.fireFlag;return this.fireFlag=!1,e}fireProjectile(e,t){return new b(this.x,this.y,e,t)}updatePlayer(e,t,a){this.currentFrame=a,this.update(e,t)}update(e,t){const a=e.actions;if(a===void 0)return;let i=0,n=0;a.includes("MOVE_UP")&&(n=-this.moveSpeed),a.includes("MOVE_DOWN")&&(n=this.moveSpeed),a.includes("MOVE_LEFT")&&(i=-this.moveSpeed),a.includes("MOVE_RIGHT")&&(i=this.moveSpeed),e.isMouseDown&&this.bulletTime+250<Date.now()&&(this.bulletTime=Date.now(),this.fireFlag=!0),this.setMovement(i,n),this.currentFrame-this.lastHitFrame>120&&this.hp<100&&(this.hp=Math.min(100,this.hp+(this.hp<25?.3:.1)),this.health=this.hp),this.x=Math.max(0,Math.min(this.config.width,this.x+this.vx)),this.y=Math.max(0,Math.min(this.config.height,this.y+this.vy))}orientation(e){}syncToSAB(e,t){}}class x{active;height;playerRelative;hitbox;seed;width;health;x;y;vx;vy;type;currentFrame;constructor(){this.x=0,this.y=0,this.vx=0,this.vy=0,this.health=0,this.hitbox={offsetX:0,offsetY:0},this.height=0,this.width=0,this.seed=Math.random()*1e3,this.active=!1,this.playerRelative=0,this.type="unknown",this.currentFrame=0}modifyHP(e){this.active&&(this.health+=e),this.health<0&&(this.active=!1)}}class I extends x{damageType="contact";hp=0;maxHp=0;moveSpeed=0;contactDamage=.2;wave=0;timeElapsed;atkBox;followRun;primedMode;constructor(e,t){super(),this.x=e,this.y=t,this.width=50,this.height=52,this.health=100,this.hp=100,this.maxHp=100,this.timeElapsed=Date.now()+Math.random()*1e3,this.atkBox={eX:0,eY:0},this.followRun=!1,this.primedMode=!1,this.active=!0,this.type="rock"}applySpawnConfig(e,t,a,i){this.hp=e,this.maxHp=e,this.health=e,this.moveSpeed=t,this.contactDamage=a,this.wave=i}update(e,t){this.orientation(e),this.processRock(e,t),this.processRockAttacks(e,t),this.currentFrame+=.05}orientation(e){const t=this.x-e.x,a=this.y-e.y;this.playerRelative=Math.atan2(a,t)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.seed,e[t+3]=this.primedMode?1:0,e[t+4]=this.atkBox.eX,e[t+5]=this.atkBox.eY,e[t+6]=this.width,e[t+7]=this.height,e[t+8]=this.currentFrame,e[t+9]=0}processRock(e,t){if(this.primedMode)return;const a=this.x-e.x,i=this.y-e.y,n=a*a+i*i,o=Math.floor(Math.sqrt(a*a+i*i)),s=this.moveSpeed>0?this.moveSpeed:t.moveSpeed-1;this.followRun=o>=200&&o<=250,this.followRun?(this.vx*=0,this.vy*=0):(this.vx=Math.floor(Math.abs(Math.cos(this.playerRelative)*s)),this.vy=Math.floor(Math.abs(Math.sin(this.playerRelative)*s)),o>=200&&(this.vx*=a>0?-1:1,this.vy*=i>0?-1:1),o<=250&&(this.vx*=a>0?1:-1,this.vy*=i>0?1:-1)),this.vx=this.x<=0?1:this.vx,this.vx=this.x>=t.width?-1:this.vx,this.vy=this.y<=0?1:this.vy,this.vy=this.y>=t.height?-1:this.vy,this.x+=this.vx,this.y+=this.vy,n<1600&&(this.vx*=-1,this.vy*=-1,e.modifyHp(-this.contactDamage),self.postMessage({type:"EVENT",name:"EXPLOSION_REQ"}))}processRockAttacks(e,t){const a=Date.now()-this.timeElapsed;if(a>5e3&&!this.primedMode&&(this.primedMode=!0,this.atkBox={eX:e.x,eY:e.y}),this.primedMode&&a>7e3){const i=(this.atkBox.eY-this.y)/(this.atkBox.eX-this.x),n=this.y-i*this.x,o=Math.abs(i*e.x+-1*e.y+n),s=Math.sqrt(i*i+1);o/s<30&&Math.min(this.atkBox.eX,this.x)<=e.x&&e.x<=Math.max(this.atkBox.eX,this.x)&&Math.min(this.atkBox.eY,this.y)<=e.y&&e.y<=Math.max(this.atkBox.eY,this.y)&&e.modifyHp(-10),this.timeElapsed=Date.now(),this.primedMode=!1,this.atkBox={eX:0,eY:0}}}}class B extends x{damageType="ranged";hp=0;maxHp=0;moveSpeed=0;fireRate=5e3;lastShotFrame=0;projectileDamage=20;wave=0;timeElapsed;followRun;primedMode;constructor(e,t){super(),this.x=e,this.y=t,this.width=50,this.height=52,this.health=100,this.hp=100,this.maxHp=100,this.timeElapsed=Date.now()+Math.random()*1e3,this.followRun=!1,this.primedMode=!1,this.active=!0,this.type="singleShot"}applySpawnConfig(e,t,a,i,n){this.hp=e,this.maxHp=e,this.health=e,this.moveSpeed=t,this.fireRate=a,this.projectileDamage=i,this.wave=n}updateProjectile(e,t,a){this.update(e,t),this.fireProjectiles(e,a)}update(e,t){this.orientation(e),this.processShot(e,t),this.currentFrame+=.05}fireProjectiles(e,t){this.processShotAttacks(e,t)}orientation(e){const t=this.x-e.x,a=this.y-e.y;this.playerRelative=Math.atan2(a,t)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.seed,e[t+3]=this.primedMode?1:0,e[t+6]=this.width,e[t+7]=this.height,e[t+8]=this.currentFrame,e[t+9]=1}processShot(e,t){if(this.primedMode)return;const a=this.x-e.x,i=this.y-e.y,n=a*a+i*i,o=Math.floor(Math.sqrt(a*a+i*i)),s=this.moveSpeed>0?this.moveSpeed:t.moveSpeed-1;this.followRun=o>200&&o<250,this.followRun?(this.vx*=0,this.vy*=0):(this.vx=Math.floor(Math.abs(Math.cos(this.playerRelative)*s)),this.vy=Math.floor(Math.abs(Math.sin(this.playerRelative)*s)),o>200&&(this.vx*=a>0?-1:1,this.vy*=i>0?-1:1),o<250&&(this.vx*=a>0?1:-1,this.vy*=i>0?1:-1)),this.vx=this.x<=0?1:this.vx,this.vx=this.x>=t.width?-1:this.vx,this.vy=this.y<=0?1:this.vy,this.vy=this.y>=t.height?-1:this.vy,this.x=Math.floor(this.x+this.vx),this.y=Math.floor(this.y+this.vy),n<1600&&(this.vx*=-1,this.vy*=-1,e.modifyHp(-.2),self.postMessage({type:"EVENT",name:"EXPLOSION_REQ"}))}processShotAttacks(e,t){Date.now()-this.timeElapsed>this.fireRate+Math.floor(Math.random()*3e3)&&!this.primedMode&&(this.primedMode=!0),this.primedMode&&(t.push(new S(this.x,this.y,e.x,e.y)),this.timeElapsed=Date.now(),this.primedMode=!1)}}class C extends x{vulnerable=!1;phase=1;lastShotFrame=0;phase1FireRate=25;phase2FireRate=60;phase2RingCount=8;phase3FireRate=50;phase3InnerCount=8;phase3OuterCount=12;bounceVx=0;bounceVy=0;bounceSpeed=1.5;bouncing=!1;constructor(e,t){super(),this.x=e,this.y=t,this.width=200,this.height=200,this.health=300,this.active=!0,this.type="boss"}update(e,t){if(this.active){const a=this.x+this.width/2,i=this.y+this.height/2,n=a-e.x,o=i-e.y,s=Math.sqrt(n*n+o*o),h=this.width/2;s<h+e.width/2&&(e.modifyHp(-.5),self.postMessage({type:"EVENT",name:"EXPLOSION_REQ"}))}if(!(this.phase<3)){if(!this.bouncing){this.bouncing=!0;const a=Math.random()*Math.PI*2;this.bounceVx=Math.cos(a)*this.bounceSpeed,this.bounceVy=Math.sin(a)*this.bounceSpeed}this.x+=this.bounceVx,this.y+=this.bounceVy,this.x<=0&&(this.x=0,this.bounceVx*=-1),this.x+this.width>=t.width&&(this.x=t.width-this.width,this.bounceVx*=-1),this.y<=0&&(this.y=0,this.bounceVy*=-1),this.y+this.height>=t.height&&(this.y=t.height-this.height,this.bounceVy*=-1)}}updateAttacks(e,t,a){if(!this.active||!this.vulnerable)return;const i=this.phase===1?this.phase1FireRate:this.phase===2?this.phase2FireRate:this.phase3FireRate;if(t-this.lastShotFrame<i)return;this.lastShotFrame=t;const n=this.x+this.width/2,o=this.y+this.height/2;if(this.phase===1)a.push(new S(n,o,e.x,e.y));else if(this.phase===2)this.fireRing(n,o,this.phase2RingCount,0,8,e.x,e.y,a);else{this.fireRing(n,o,this.phase3InnerCount,0,8,e.x,e.y,a);const s=Math.PI/this.phase3OuterCount;this.fireRing(n,o,this.phase3OuterCount,s,5,e.x,e.y,a)}}fireRing(e,t,a,i,n,o,s,h){const c=Math.atan2(s-t,o-e),l=Math.PI*2/a;for(let v=0;v<a;v++){const d=c+l*v+i,f=e+Math.cos(d)*1e3,w=t+Math.sin(d)*1e3,y=new S(e,t,f,w);y.vx=Math.cos(d)*n,y.vy=Math.sin(d)*n,h.push(y)}}orientation(e){const t=this.x+this.width/2-e.x,a=this.y+this.height/2-e.y;this.playerRelative=Math.atan2(a,t)}syncToSAB(e,t){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.seed,e[t+3]=this.vulnerable?1:0,e[t+4]=this.health}modifyHP(e){this.active&&this.vulnerable&&(this.health+=e),this.health<=0&&(this.active=!1)}}class X{waveDefinitions=[];currentWave=-1;waveState="IDLE";delayTimer=0;totalWaves=0;loadWaves(e){this.waveDefinitions=e,this.totalWaves=e.length,this.currentWave=-1,this.waveState="IDLE",this.delayTimer=0}start(){this.currentWave=0,this.waveState="DELAY",this.delayTimer=this.waveDefinitions[0]?.delayBeforeStart??60}update(e){if(this.waveState==="IDLE"||this.waveState==="ALL_CLEARED")return null;if(this.waveState==="DELAY"){if(this.delayTimer--,this.delayTimer<=0){this.waveState="ACTIVE";const t=this.waveDefinitions[this.currentWave];if(t)return t.enemies}return null}return this.waveState==="ACTIVE"?(e<=0&&(this.waveState="CLEARED"),null):(this.waveState==="CLEARED",null)}nextWave(){this.waveState==="CLEARED"&&(this.currentWave+1>=this.totalWaves?this.waveState="ALL_CLEARED":(this.currentWave++,this.waveState="DELAY",this.delayTimer=this.waveDefinitions[this.currentWave]?.delayBeforeStart??60))}static spawnFromDefinitions(e,t,a){const i=[];for(const n of e){const o=n.spawnX*t.width,s=n.spawnY*t.height;if(n.damageType==="contact"){const h=n,c=new I(o,s);c.applySpawnConfig(h.hp,h.moveSpeed,h.contactDamage,a),i.push(c)}else if(n.damageType==="ranged"){const h=n,c=new B(o,s);c.applySpawnConfig(h.hp,h.moveSpeed,h.fireRate,h.projectileDamage,a),i.push(c)}}return i}getCurrentWave(){return Math.max(0,this.currentWave)}getTotalWaves(){return this.totalWaves}getState(){return this.waveState}getDelayTimer(){return this.delayTimer}isAllCleared(){return this.waveState==="ALL_CLEARED"}getSnapshot(){return{currentWave:this.currentWave,waveState:this.waveState,delayTimer:this.delayTimer,totalWaves:this.totalWaves}}loadSnapshot(e){e&&(this.currentWave=e.currentWave??-1,this.waveState=e.waveState??"IDLE",this.delayTimer=e.delayTimer??0,this.totalWaves=e.totalWaves??0)}}var H={"Level 1":{waves:[{waveIndex:0,delayBeforeStart:60,enemies:[{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.2,spawnX:.2,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.2,spawnX:.4,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.2,spawnX:.6,spawnY:.1},{damageType:"ranged",hp:10,moveSpeed:3,fireRate:500,contactDamage:.2,spawnX:.8,spawnY:.1},{damageType:"ranged",hp:10,moveSpeed:3,fireRate:500,contactDamage:.2,spawnX:.5,spawnY:.1}]},{waveIndex:1,delayBeforeStart:90,enemies:[{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.3,spawnX:.15,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.3,spawnX:.35,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.3,spawnX:.55,spawnY:.1},{damageType:"contact",hp:10,moveSpeed:3,contactDamage:.3,spawnX:.75,spawnY:.1},{damageType:"ranged",hp:10,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.9,spawnY:.1},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.3,spawnY:.05},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.7,spawnY:.05}]},{waveIndex:2,delayBeforeStart:120,enemies:[{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.4,spawnX:.1,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.4,spawnX:.25,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.4,spawnX:.4,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.4,spawnX:.55,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.4,spawnX:.7,spawnY:.1},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.85,spawnY:.1},{damageType:"ranged",hp:15,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.3,spawnY:.05},{damageType:"ranged",hp:15,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.5,spawnY:.05},{damageType:"ranged",hp:15,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.7,spawnY:.05},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.5,spawnY:.02}]}]},"Level 2":{waves:[{waveIndex:0,delayBeforeStart:60,enemies:[{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.3,spawnX:.2,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.3,spawnX:.4,spawnY:.1},{damageType:"contact",hp:12,moveSpeed:3,contactDamage:.3,spawnX:.6,spawnY:.1},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.8,spawnY:.1},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.3,spawnY:.05},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.5,spawnY:.05},{damageType:"ranged",hp:12,moveSpeed:3,fireRate:500,contactDamage:.3,spawnX:.7,spawnY:.05}]},{waveIndex:1,delayBeforeStart:90,enemies:[{damageType:"ranged",hp:14,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.1,spawnY:.1},{damageType:"ranged",hp:14,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.25,spawnY:.1},{damageType:"ranged",hp:14,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.4,spawnY:.1},{damageType:"ranged",hp:14,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.55,spawnY:.1},{damageType:"ranged",hp:14,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.7,spawnY:.1},{damageType:"ranged",hp:14,moveSpeed:3,fireRate:500,contactDamage:.4,spawnX:.85,spawnY:.1},{damageType:"contact",hp:16,moveSpeed:3,contactDamage:.4,spawnX:.3,spawnY:.05},{damageType:"contact",hp:16,moveSpeed:3,contactDamage:.4,spawnX:.5,spawnY:.05},{damageType:"contact",hp:16,moveSpeed:3,contactDamage:.4,spawnX:.7,spawnY:.05},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.5,spawnX:.5,spawnY:.02}]},{waveIndex:2,delayBeforeStart:120,enemies:[{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.1,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.2,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.3,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.4,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.5,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.6,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.7,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.8,spawnY:.1},{damageType:"ranged",hp:16,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.9,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.6,spawnX:.3,spawnY:.02},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.6,spawnX:.5,spawnY:.02},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.6,spawnX:.7,spawnY:.02}]}]},"Level 3":{waves:[{waveIndex:0,delayBeforeStart:45,enemies:[{damageType:"contact",hp:15,moveSpeed:3,contactDamage:.4,spawnX:.15,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:3,contactDamage:.4,spawnX:.3,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:3,contactDamage:.4,spawnX:.45,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:3,contactDamage:.4,spawnX:.6,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:3,contactDamage:.4,spawnX:.75,spawnY:.1},{damageType:"contact",hp:15,moveSpeed:3,contactDamage:.4,spawnX:.9,spawnY:.1},{damageType:"ranged",hp:18,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.2,spawnY:.05},{damageType:"ranged",hp:18,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.5,spawnY:.05},{damageType:"ranged",hp:18,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.8,spawnY:.05}]},{waveIndex:1,delayBeforeStart:75,enemies:[{damageType:"contact",hp:18,moveSpeed:3,contactDamage:.5,spawnX:.1,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:3,contactDamage:.5,spawnX:.2,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:3,contactDamage:.5,spawnX:.3,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:3,contactDamage:.5,spawnX:.4,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:3,contactDamage:.5,spawnX:.5,spawnY:.1},{damageType:"contact",hp:18,moveSpeed:3,contactDamage:.5,spawnX:.6,spawnY:.1},{damageType:"ranged",hp:18,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.7,spawnY:.1},{damageType:"ranged",hp:18,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.8,spawnY:.1},{damageType:"ranged",hp:18,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.9,spawnY:.1},{damageType:"ranged",hp:22,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.25,spawnY:.02},{damageType:"ranged",hp:22,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.5,spawnY:.02},{damageType:"ranged",hp:22,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.75,spawnY:.02}]},{waveIndex:2,delayBeforeStart:90,enemies:[{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.05,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.15,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.25,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.35,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.45,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.55,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.65,spawnY:.1},{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.6,spawnX:.75,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.6,spawnX:.85,spawnY:.1},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.6,spawnX:.95,spawnY:.1},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.7,spawnX:.2,spawnY:.02},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.7,spawnX:.4,spawnY:.02},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.7,spawnX:.6,spawnY:.02},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.7,spawnX:.8,spawnY:.02},{damageType:"contact",hp:30,moveSpeed:3,contactDamage:1,spawnX:.5,spawnY:.01}]}]},"Level 4":{waves:[{waveIndex:0,delayBeforeStart:60,enemies:[{damageType:"ranged",hp:20,moveSpeed:3,fireRate:500,contactDamage:.5,spawnX:.2,spawnY:.5},{damageType:"contact",hp:20,moveSpeed:3,contactDamage:.5,spawnX:.8,spawnY:.5},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.6,spawnX:.5,spawnY:.6}]},{waveIndex:1,delayBeforeStart:60,enemies:[{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.6,spawnX:.1,spawnY:.5},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.6,spawnX:.9,spawnY:.5},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.6,spawnX:.3,spawnY:.6},{damageType:"contact",hp:25,moveSpeed:3,contactDamage:.6,spawnX:.7,spawnY:.6}]},{waveIndex:2,delayBeforeStart:60,enemies:[{damageType:"ranged",hp:30,moveSpeed:3,fireRate:500,contactDamage:.7,spawnX:.2,spawnY:.4},{damageType:"ranged",hp:30,moveSpeed:3,fireRate:500,contactDamage:.7,spawnX:.8,spawnY:.4},{damageType:"ranged",hp:30,moveSpeed:3,fireRate:500,contactDamage:.7,spawnX:.4,spawnY:.5},{damageType:"contact",hp:30,moveSpeed:3,contactDamage:.7,spawnX:.6,spawnY:.5},{damageType:"contact",hp:40,moveSpeed:3,contactDamage:.8,spawnX:.5,spawnY:.6}]}]}};class M extends L{dispatcher;player;entities=[];playerProjectiles=[];enemyProjectiles=[];currentFrame=0;boss=null;bossLevel=!1;bossTargetHp=3;waveManager=new X;wavesStarted=!1;exitDoorActive=!1;exitDoorX=0;exitDoorY=0;static DOOR_SIZE=60;exitDoorEntered=!1;constructor(){super(D.REVISION),this.dispatcher=new A(this,P,"BHTest"),this.player=g.getInstance()}applyConfig(e){this.config=e,this.player.applyConfig(e);const t=e.levelLabel||"Level 1",a=H[t];a&&a.waves?this.waveManager.loadWaves(a.waves):(console.warn(`[BHTestLogic] No wave data for "${t}", using empty waves`),this.waveManager.loadWaves([])),this.entities=[],this.playerProjectiles=[],this.enemyProjectiles=[],this.wavesStarted=!1,this.exitDoorActive=!1,this.exitDoorEntered=!1,this.exitDoorX=e.width/2,this.exitDoorY=e.height/2;const i=this.config.levelLabel||"Level 1";this.bossLevel=i==="Level 4",this.bossLevel?(this.boss=new C(e.width/2-100,50),this.bossTargetHp=200):this.boss=null}destroy(){super.destroy(),this.entities=[],this.playerProjectiles=[],this.enemyProjectiles=[],this.wavesStarted=!1,this.boss=null,this.bossLevel=!1}getSnapshot(){return{player:{...this.player},entities:[...this.entities],playerProjectiles:[...this.playerProjectiles],enemyProjectiles:[...this.enemyProjectiles],currentFrame:this.currentFrame,config:this.config,waveSnapshot:this.waveManager.getSnapshot(),wavesStarted:this.wavesStarted}}loadSnapshot(e){e&&(this.config=e.config,this.player=e.player,this.entities=e.entities,this.playerProjectiles=e.playerProjectiles,this.enemyProjectiles=e.enemyProjectiles,this.currentFrame=e.currentFrame??0,this.wavesStarted=e.wavesStarted??!1,e.waveSnapshot&&this.waveManager.loadSnapshot(e.waveSnapshot),this.isInitialized=!0)}onUpdate(e,t,a,i){if(!this.config)return;this.currentFrame=a,this.wavesStarted||(this.waveManager.start(),this.wavesStarted=!0);const n=this.entities.filter(h=>h.active).length,o=this.waveManager.update(n);if(!this.bossLevel&&this.waveManager.getState()==="CLEARED"&&this.waveManager.nextWave(),this.bossLevel&&this.boss){const h=this.waveManager.getState();this.boss.phase=Math.min(3,this.waveManager.getCurrentWave()+1),n>0||h==="ACTIVE"||h==="DELAY"?this.boss.vulnerable=!1:(h==="CLEARED"||h==="ALL_CLEARED")&&(this.boss.health>this.bossTargetHp?this.boss.vulnerable=!0:this.boss.vulnerable&&(this.boss.vulnerable=!1,this.bossTargetHp-=100,h==="CLEARED"&&this.waveManager.nextWave())),this.boss.update(this.player,this.config),this.boss.updateAttacks(this.player,a,this.enemyProjectiles)}if(o){const h=X.spawnFromDefinitions(o,this.config,this.waveManager.getCurrentWave());this.entities.push(...h)}this.player.updatePlayer(this.inputState,this.config,a);for(const h of this.entities)h.type==="singleShot"&&h.updateProjectile(this.player,this.config,this.enemyProjectiles),h.update(this.player,this.config);this.player.playerAction()&&this.playerProjectiles.push(this.player.fireProjectile(this.inputState,this.config));for(const h of this.playerProjectiles)h.update(this.player,this.config),h.collided(this.entities),this.boss&&h.collided([this.boss]);for(const h of this.enemyProjectiles)h.update(this.player,this.config),h.collided(this.player),console.log("Running Projectiles... "+h.active);this.playerProjectiles=this.playerProjectiles.filter(h=>h.active),this.enemyProjectiles=this.enemyProjectiles.filter(h=>h.active),this.entities=this.entities.filter(h=>h.active),this.player.hp<=0&&self.postMessage({type:"EVENT",name:"PLAYER_DEAD"});const s=this.bossLevel?this.boss&&!this.boss.active:!0;if(this.waveManager.isAllCleared()&&this.entities.length===0&&s&&(self.postMessage({type:"EVENT",name:"ROOM_CLEARED"}),this.exitDoorActive||(this.exitDoorActive=!0)),this.exitDoorActive&&!this.exitDoorEntered){const h=M.DOOR_SIZE/2,c=this.player.x,l=this.player.y;c>=this.exitDoorX-h&&c<=this.exitDoorX+h&&l>=this.exitDoorY-h&&l<=this.exitDoorY+h&&(this.exitDoorEntered=!0,self.postMessage({type:"EVENT",name:"EXIT_DOOR_ENTERED"}))}this.syncToSAB(e,a,i)}syncToSAB(e,t,a){const i=this.sharedViews.get("rocks"),n=this.sharedViews.get("pProjs"),o=this.sharedViews.get("eProjs");if(!e||!i||!n||!o)return;const s=D;if(e[s.HERO_HP]=this.player.hp,e[s.HERO_X]=this.player.x,e[s.HERO_Y]=this.player.y,e[s.HERO_VX]=this.player.vx,e[s.HERO_VY]=this.player.vy,e[s.HERO_WIDTH]=this.player.width,e[s.HERO_HEIGHT]=this.player.height,e[s.FRAME_COUNT]=t,this.config){const p=-this.config.width*this.inputState.mouseX+this.player.x,m=-this.config.height*this.inputState.mouseY+this.player.y;e[s.MOUSE_RELATIVE]=Math.atan2(m,p),e[s.MAP_WIDTH]=this.config.width,e[s.MAP_HEIGHT]=this.config.height}e[s.FPS]=a,e[s.CURRENT_WAVE]=this.waveManager.getCurrentWave(),e[s.TOTAL_WAVES]=this.waveManager.getTotalWaves(),e[s.WAVE_DELAY_TIMER]=this.waveManager.getDelayTimer();const h={IDLE:0,DELAY:1,ACTIVE:2,CLEARED:3,ALL_CLEARED:4};e[s.WAVE_STATE]=h[this.waveManager.getState()]??0,e[s.EXIT_DOOR_ACTIVE]=this.exitDoorActive?1:0,e[s.EXIT_DOOR_X]=this.exitDoorX,e[s.EXIT_DOOR_Y]=this.exitDoorY;const c=this.config.levelLabel||"Level 1",l=c==="Level 4"?3:c==="Level 3"?2:c==="Level 2"?1:0;e[s.CURRENT_LEVEL]=l,this.boss?(e[s.BOSS_HP]=this.boss.health,e[s.BOSS_VULNERABLE]=this.boss.vulnerable?1:0,e[s.BOSS_X]=this.boss.x,e[s.BOSS_Y]=this.boss.y,e[s.BOSS_ACTIVE]=this.boss.active?1:0):(e[s.BOSS_HP]=0,e[s.BOSS_VULNERABLE]=0,e[s.BOSS_ACTIVE]=0);const v=Math.floor(i.length/T.STRIDE),d=Math.min(this.entities.length,v);e[s.ROCK_COUNT]=d;for(let p=0;p<d;p++){const m=p*T.STRIDE;this.entities[p].syncToSAB(i,m)}const f=Math.floor(n.length/R.STRIDE),w=Math.min(this.playerProjectiles.length,f);e[s.PPROJ_COUNT]=w;for(let p=0;p<w;p++){const m=p*R.STRIDE;this.playerProjectiles[p].syncToSAB(n,m)}const y=Math.floor(o.length/E.STRIDE),u=Math.min(this.enemyProjectiles.length,y);e[s.EPROJ_COUNT]=u;for(let p=0;p<u;p++){const m=p*E.STRIDE;this.enemyProjectiles[p].syncToSAB(o,m)}}}export{M as BHTestLogic};
//# sourceMappingURL=BHTestLogic-DdZ4yjA3.js.map
