import{B as M,a as A,b as O,G as T}from"./BasePresenter-45XUz4Hx.js";import{F as x,S,a as y,G as E,I as b,A as G,r as i,j as n,b as F,c as V,g as H}from"./index-CeLuIhmo.js";import{S as q}from"./SaveManager-CKTDV0Pf.js";import{C as v}from"./CampaignManager-D4yI8sdC.js";import{m as g}from"./module-DrzdPB3r.js";import{G as P}from"./GameSprite-uxNaMgiy.js";class N extends M{constructor(e){super(e,x.GAME_1)}takeDamage(){this.send("TAKE_DAMAGE",{amount:15})}async jumpToGame2(){const e=await S.create(x.GAME_2,{reset:!1});await y.getInstance().replace(e)}async loadLevel(e){const t=await S.create(x.GAME_1,{reset:!1,level:e});await y.getInstance().replace(t)}nextLevel(){v.getInstance().completeCurrentStep()}failLevel(){v.getInstance().failCurrentStep()}async resetLevel(){await q.getInstance().performLoad(this.QUICK_SAVE_KEY);const e=this.vm.currentLevel||E.Level1,t=await S.create(x.GAME_1,{reset:!1,level:e});await y.getInstance().replace(t)}onKeyDown(e){b.getInstance().isKeyAction(e.key,"PAUSE")&&this.openPauseMenu()}onWorkerEvent(e){e==="EXPLOSION_REQ"&&G.getInstance().play("sfx_explosion")}async openPauseMenu(){const e=y.getInstance();if(e.getCurrentStateName()===this.stateName){const t=await S.create(x.PAUSE_MENU);await e.push(t)}}}const p={HERO_X:0,HERO_Y:1,HERO_ROTATION:2,HERO_SCALE:3,HERO_HP_DISPLAY:4,HERO_FRAME:5,ACTIVE_ROCK_COUNT:6,BUFFER_SIZE:128},_={START_INDEX:0,STRIDE:3,BUFFER_SIZE:3e3},D={main:p,rocks:_};class B extends A{get pos(){return{x:this.sharedView[p.HERO_X]||0,y:this.sharedView[p.HERO_Y]||0}}get hp(){return this.sharedView[p.HERO_HP_DISPLAY]||0}get entityCount(){return Math.floor(this.sharedView[p.ACTIVE_ROCK_COUNT]||0)}get heroVisuals(){return{x:this.sharedView[p.HERO_X]||0,y:this.sharedView[p.HERO_Y]||0,rotation:this.sharedView[p.HERO_ROTATION]||0,scale:this.sharedView[p.HERO_SCALE]||1,currentFrame:this.sharedView[p.HERO_FRAME]||0}}getRockViewData(e){const t=this.getBuffer("rocks");if(!t)return{x:0,y:0,rotation:0};const o=e*_.STRIDE;return{x:t[o]||0,y:t[o+1]||0,rotation:t[o+2]||0}}}const U=({w:s,h:e})=>{const t=g.useApp();return i.useEffect(()=>{t?.renderer&&(t.renderer.resize(s,e),t.view instanceof HTMLCanvasElement&&(t.view.width=s,t.view.height=e))},[t,s,e]),null},K=({paused:s,w:e,h:t})=>{const o=i.useRef(null),d=i.useRef(0);return i.useEffect(()=>{o.current?.clear().beginFill(16777215).drawRect(0,0,e,t).endFill()},[e,t]),g.useTick(c=>{if(!o.current||s)return;d.current+=Math.PI/60*c;const l=(Math.sin(d.current)+1)/2,a=Math.round(26+l*4),r=Math.round(26+l*54),u=Math.round(46+l*104);o.current.tint=(a<<16)+(r<<8)+u}),n.jsx(g.Graphics,{ref:o})},Y=({vm:s,paused:e})=>{const t=i.useRef(null),o=i.useRef([]),d=F.getInstance();return i.useEffect(()=>()=>{o.current.forEach(c=>{c&&!c.destroyed&&c.destroy()}),o.current=[]},[]),g.useTick(()=>{if(!t.current)return;const c=s.entityCount,l=o.current;if(c>l.length)for(let a=l.length;a<c;a++){const r=d.getTexture("static_rock");if(r){const u=new V(r);u.anchor.set(.5),u.scale.set(.8),t.current.addChild(u),l.push(u)}}else if(c<l.length)for(let a=l.length-1;a>=c;a--){const r=l.pop();r&&(t.current.removeChild(r),r.destroy())}for(let a=0;a<c;a++){const r=l[a],u=s.getRockViewData(a);if(!u||e){r&&(r.visible=!1);continue}r.visible=!0,r.x=u.x,r.y=u.y,r.rotation=u.rotation}}),n.jsx(g.Container,{ref:t})},X=({vm:s,paused:e,width:t,height:o,scale:d,heroPos:c,hp:l})=>{const a=i.useRef(null),[r,u]=i.useState(s.heroVisuals);return g.useTick(()=>{const f=s.heroVisuals;a.current&&(a.current.x=f.x,a.current.y=f.y,a.current.rotation=f.rotation,a.current.scale.set(f.scale),c.current.x=f.x,c.current.y=f.y,u(f))}),n.jsxs(n.Fragment,{children:[n.jsx(U,{w:t,h:o}),n.jsx(K,{paused:e,w:t,h:o}),n.jsxs(g.Container,{scale:d,children:[n.jsx(Y,{vm:s,paused:e}),n.jsx(g.Container,{ref:a,children:n.jsx(P,{sheetName:"hero_sheet",animationName:"idle",x:0,y:0,scale:1,anchor:.5,currentFrame:r.currentFrame})})]})]})},z=({hp:s,rockCount:e,shieldBarRef:t,shieldTextRef:o,damageBtnRef:d,onDamage:c,onJumpToG2:l,onLevel1:a,onLevel2:r,onLevel3:u,onResetG1:f,onNextLevel:m,onFailLevel:C})=>{const h={padding:"0.6cqw 1cqw",cursor:"pointer",color:"#fff",border:"none",borderRadius:"0.4cqw",fontWeight:"bold",fontFamily:"monospace",fontSize:"0.8cqw",pointerEvents:"auto",textAlign:"center"};return n.jsxs("div",{style:{position:"absolute",inset:0,pointerEvents:"none",containerType:"size"},children:[n.jsxs("div",{style:{position:"absolute",top:"5cqh",left:"50%",transform:"translateX(-50%)",width:"35cqw"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",color:"#fff",marginBottom:"0.5cqh",fontWeight:"bold",fontFamily:"monospace",fontSize:"1.2cqw"},children:[n.jsx("span",{children:"SHIELD ENERGY"}),n.jsxs("span",{ref:o,children:[Math.round(s),"%"]})]}),n.jsx("div",{style:{width:"100%",height:"2cqh",backgroundColor:"#222",borderRadius:"1cqw",border:"0.2cqw solid #fff",overflow:"hidden"},children:n.jsx("div",{ref:t,style:{width:`${Math.max(0,s)}%`,height:"100%",backgroundColor:s<30?"#c0392b":"#27ae60"}})})]}),n.jsxs("div",{style:{position:"absolute",top:"3cqh",right:"3cqw",color:"#00ff00",fontFamily:"monospace",textAlign:"right",fontSize:"1.2cqw"},children:["ROCKS_ACTIVE: ",e]}),n.jsxs("div",{style:{position:"absolute",top:"3cqh",left:"3cqw",display:"flex",flexDirection:"column",gap:"1cqh"},children:[n.jsx("button",{ref:d,onClick:c,style:{...h,background:"#333",border:"0.1cqw solid #fff"},children:"TAKE DAMAGE (-15)"}),n.jsxs("div",{style:{display:"flex",gap:"0.5cqw"},children:[n.jsx("button",{onClick:a,style:{...h,background:"#408240",flex:1},children:"LVL 1"}),n.jsx("button",{onClick:r,style:{...h,background:"#C29F19",flex:1},children:"LVL 2"}),n.jsx("button",{onClick:u,style:{...h,background:"#C21919",flex:1},children:"LVL 3"})]}),n.jsx("div",{style:{display:"flex",gap:"0.5cqw"},children:n.jsx("button",{onClick:m,style:{...h,background:"#67ad44",flex:2},children:"Next Level (Campaign)"})}),n.jsx("div",{style:{display:"flex",gap:"0.5cqw"},children:n.jsx("button",{onClick:C,style:{...h,background:"#ad4444",flex:2},children:"Fail Level (Campaign)"})}),n.jsx("button",{onClick:l,style:{...h,background:"#2980b9"},children:"Go to Game 2"}),n.jsx("div",{style:{display:"flex",gap:"0.5cqw"},children:n.jsx("button",{onClick:f,style:{...h,background:"#c0392b",flex:1},children:"Quick Load"})})]})]})},$=({vm:s,controller:e,width:t=960,height:o=540})=>{const[d,c]=i.useState(s.hp),[l,a]=i.useState(s.entityCount),[r,u]=i.useState(!1),f=i.useRef(null),m=i.useRef(null),C=i.useRef(null),h=i.useRef({x:s.pos.x,y:s.pos.y});i.useEffect(()=>{const k=s.subscribe(()=>{const w=y.getInstance().getActiveState()?.name!=="Game1";r!==w&&u(w);const R=s.hp;h.current.x=s.pos.x,h.current.y=s.pos.y,f.current&&(f.current.style.width=`${Math.max(0,R)}%`),m.current&&(m.current.innerText=`${Math.round(R)}%`),Math.abs(d-R)>1&&c(R),l!==s.entityCount&&a(s.entityCount)});return()=>k()},[s,d,l,r]);const L=i.useMemo(()=>t/960,[t]),j=i.useMemo(()=>({backgroundColor:0,antialias:!0,resolution:1,autoDensity:!1}),[]),I=i.useMemo(()=>({display:"block",width:"100%",height:"100%",objectFit:"contain",imageRendering:"pixelated"}),[]);return n.jsxs("div",{style:{position:"absolute",inset:0,background:"#000",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:[n.jsx("div",{style:{position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(g.Stage,{width:t,height:o,options:j,style:I,children:n.jsx(X,{vm:s,paused:r,width:t,height:o,scale:L,heroPos:h,hp:d})},`stage-${t}-${o}`)}),n.jsx(z,{hp:d,rockCount:l,shieldBarRef:f,shieldTextRef:m,damageBtnRef:C,onDamage:()=>e.takeDamage(),onJumpToG2:()=>e.jumpToGame2(),onLevel1:()=>e.loadLevel(E.Level1),onLevel2:()=>e.loadLevel(E.Level2),onLevel3:()=>e.loadLevel(E.Level3),onResetG1:()=>e.resetLevel(),onNextLevel:()=>e.nextLevel(),onFailLevel:()=>e.failLevel()})]})},Z={HERO_HP:0,HERO_X:1,HERO_Y:2,TICK_COUNT:3,FRAME_COUNT:4,FPS:5,REVISION:6,LAST_HIT_FRAME:7,ENTITY_COUNT:8,BUFFER_SIZE:128},Q={START_INDEX:0,STRIDE:3,BUFFER_SIZE:3e3},W={main:Z,rocks:Q};class ie extends O{name=x.GAME_1;logicSchema=W;viewSchema=D;viewComponent=$;currentLevel;constructor(e={}){super(e.reset??!1),this.currentLevel=e.level??E.Level1}getConfig(){return H(this.currentLevel)}getSessionOverrides(e){const t=e.get(T.hp);return t!==void 0?{initialHP:t}:{}}initMVC(){this.vm=new B,this.controller=new N(this.vm)}async init(){b.getInstance().refreshBindings(this.name),await super.init()}}export{ie as Game1State};
//# sourceMappingURL=Game1State-CfZhiI19.js.map
