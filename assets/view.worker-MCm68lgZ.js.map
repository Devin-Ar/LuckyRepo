{"version":3,"file":"view.worker-MCm68lgZ.js","sources":["../src/core/registry/WorkerRegistry.ts","../src/features/FeatureEnum.ts","../src/features/Game1/index.worker.ts","../src/features/Game2/index.worker.ts","../src/features/BulletTest/index.worker.ts","../src/features/Game3/index.worker.ts","../src/features/workers.ts","../src/config/WorkerManifest.ts","../src/workers/view.worker.ts"],"sourcesContent":["// src/core/registry/WorkerRegistry.ts\r\nexport interface WorkerRegistryItem<T> {\r\n    id: string;\r\n    loader: () => Promise<new () => T>;\r\n}\r\n\r\nexport class WorkerRegistry<T> {\r\n    private loaders = new Map<string, () => Promise<new () => T>>();\r\n\r\n    public register(def: WorkerRegistryItem<T>) {\r\n        this.loaders.set(def.id, def.loader);\r\n    }\r\n\r\n    public async create(id: string): Promise<T> {\r\n        const loader = this.loaders.get(id);\r\n        if (!loader) {\r\n            throw new Error(`WorkerRegistry: No loader registered for ID \"${id}\"`);\r\n        }\r\n\r\n        const ClassConstructor = await loader();\r\n        return new ClassConstructor();\r\n    }\r\n}\r\n\r\nexport const LogicRegistry = new WorkerRegistry<any>();\r\nexport const ViewRegistry = new WorkerRegistry<any>();","//src/features/FeatureEnum.ts\r\nexport enum FeatureEnum {\r\n    GAME_1 = \"Game1\",\r\n    GAME_2 = \"Game2\",\r\n    GAME_3 = \"Game3\",\r\n    BH_GAME = \"BHGame\",\r\n    DEV_MENU = \"DevMenu\",\r\n    PAUSE_MENU = \"PauseMenu\",\r\n    SAVE_MENU = \"SaveMenu\",\r\n    SETTINGS_MENU = \"SettingsMenu\",\r\n    CONTINUE = \"ContinueScreen\",\r\n    GAME_OVER = \"GameOverScreen\",\r\n}","// src/features/Game1/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const Game1Worker: WorkerDefinition = {\r\n    id: FeatureEnum.GAME_1,\r\n    logicLoader: () => import(\"./logic/Game1Logic\").then(m => m.Game1Logic),\r\n    viewLoader: () => import(\"./view/Game1ViewLogic\").then(m => m.Game1ViewLogic)\r\n};","// src/features/Game2/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const Game2Worker: WorkerDefinition = {\r\n    id: FeatureEnum.GAME_2,\r\n    logicLoader: () => import(\"./logic/Game2Logic\").then(m => m.Game2Logic),\r\n    viewLoader: () => import(\"./view/Game2ViewLogic\").then(m => m.Game2ViewLogic)\r\n};","// src/features/BulletTest/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const BHWorker: WorkerDefinition = {\r\n    id: FeatureEnum.BH_GAME,\r\n    logicLoader: () => import(\"./logic/BHTestLogic\").then(m => m.BHTestLogic),\r\n    viewLoader: () => import(\"./view/BHViewLogic\").then(m => m.BHViewLogic)\r\n};","// src/features/Game3/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const Game3Worker: WorkerDefinition = {\r\n    id: FeatureEnum.GAME_3,\r\n    logicLoader: () => import(\"./logic/Game3Logic\").then(m => m.Game3Logic),\r\n    viewLoader: () => import(\"./view/Game3ViewLogic\").then(m => m.Game3ViewLogic)\r\n};","//src/features/workers.ts\r\nimport { WorkerDefinition } from \"./FeatureTypes\";\r\nimport { Game1Worker } from \"./Game1/index.worker\";\r\nimport { Game2Worker } from \"./Game2/index.worker\";\r\nimport {BHWorker} from \"./BulletTest/index.worker\";\r\nimport {Game3Worker} from \"./Game3/index.worker\";\r\n\r\nexport const WorkerFeatures: WorkerDefinition[] = [\r\n    Game1Worker,\r\n    Game2Worker,\r\n    Game3Worker,\r\n    BHWorker\r\n];","// src/config/WorkerManifest.ts\r\nimport { LogicRegistry, ViewRegistry } from \"../core/registry/WorkerRegistry\";\r\nimport { WorkerFeatures } from \"../features/workers\";\r\n\r\nexport const initializeWorkerRegistries = () => {\r\n    WorkerFeatures.forEach(def => {\r\n        if (def.logicLoader) {\r\n            LogicRegistry.register({ id: def.id, loader: def.logicLoader });\r\n        }\r\n        if (def.viewLoader) {\r\n            ViewRegistry.register({ id: def.id, loader: def.viewLoader });\r\n        }\r\n    });\r\n};","// src/workers/view.worker.ts\r\nimport { ViewRegistry } from '../core/registry/WorkerRegistry';\r\nimport { initializeWorkerRegistries } from '../config/WorkerManifest';\r\n\r\ninitializeWorkerRegistries();\r\n\r\nconst logicViews: Map<string, Float32Array> = new Map();\r\nconst logicIntViews: Map<string, Int32Array> = new Map();\r\nconst outputViews: Map<string, Float32Array> = new Map();\r\nconst states: Map<string, any> = new Map();\r\nconst pendingStates: Map<string, Promise<any>> = new Map();\r\n\r\nself.onmessage = async (e: MessageEvent) => {\r\n    const {type, stateName, payload, dt, frameCount} = e.data;\r\n\r\n    switch (type) {\r\n        case 'INIT_SABS':\r\n            console.log(`[ViewWorker] Initializing Buffers`);\r\n            logicViews.clear();\r\n            logicIntViews.clear();\r\n            outputViews.clear();\r\n\r\n            if (payload.inputBuffers) {\r\n                Object.entries(payload.inputBuffers).forEach(([key, buffer]) => {\r\n                    logicViews.set(key, new Float32Array(buffer as SharedArrayBuffer));\r\n                    logicIntViews.set(key, new Int32Array(buffer as SharedArrayBuffer));\r\n                });\r\n            }\r\n            if (payload.outputBuffers) {\r\n                Object.entries(payload.outputBuffers).forEach(([key, buffer]) => {\r\n                    outputViews.set(key, new Float32Array(buffer as SharedArrayBuffer));\r\n                });\r\n            }\r\n\r\n            states.forEach(s => s.setBuffers?.(logicViews, logicIntViews, outputViews));\r\n            break;\r\n\r\n        case 'UPDATE_BUFFER': {\r\n            const { name, buffer, isInput } = payload;\r\n            if (isInput) {\r\n                logicViews.set(name, new Float32Array(buffer));\r\n                logicIntViews.set(name, new Int32Array(buffer));\r\n            } else {\r\n                outputViews.set(name, new Float32Array(buffer));\r\n            }\r\n            states.forEach(s => s.setBuffers?.(logicViews, logicIntViews, outputViews));\r\n            break;\r\n        }\r\n\r\n        case 'CREATE_STATE':\r\n            if (!states.has(stateName)) {\r\n                if (pendingStates.has(stateName)) {\r\n                    await pendingStates.get(stateName);\r\n                } else {\r\n                    const loadPromise = (async () => {\r\n                        const instance = await ViewRegistry.create(stateName);\r\n                        instance.setBuffers(logicViews, logicIntViews, outputViews);\r\n                        return instance;\r\n                    })();\r\n\r\n                    pendingStates.set(stateName, loadPromise);\r\n\r\n                    try {\r\n                        const instance = await loadPromise;\r\n                        states.set(stateName, instance);\r\n                        console.log(`[ViewWorker] Loaded View: ${stateName}`);\r\n                    } catch (e) {\r\n                        console.error(`[ViewWorker] Failed to create view state: ${stateName}`, e);\r\n                    } finally {\r\n                        pendingStates.delete(stateName);\r\n                    }\r\n                }\r\n            }\r\n            break;\r\n\r\n        case 'TICK':\r\n            const logic = states.get(stateName);\r\n            if (logic && logicViews.size > 0 && outputViews.size > 0) {\r\n                logic.update(dt, frameCount);\r\n            }\r\n            break;\r\n\r\n        case 'TERMINATE_STATE':\r\n            if (states.has(stateName)) {\r\n                states.get(stateName).destroy?.();\r\n                states.delete(stateName);\r\n            }\r\n            break;\r\n\r\n        case 'TERMINATE_ALL':\r\n            states.forEach(s => s.destroy?.());\r\n            states.clear();\r\n            break;\r\n\r\n        case 'INPUT':\r\n            let target = states.get(stateName);\r\n\r\n            if (!target && pendingStates.has(stateName)) {\r\n                try {\r\n                    target = await pendingStates.get(stateName);\r\n                } catch(e) {\r\n                }\r\n            }\r\n\r\n            if (!target) return;\r\n\r\n            if (payload.action === 'GET_SNAPSHOT') {\r\n                const replyPort = e.ports[0];\r\n                if (replyPort) replyPort.postMessage(target.getSnapshot());\r\n            } else if (payload.action === 'LOAD_SNAPSHOT') {\r\n                target.loadSnapshot(payload.data);\r\n            }\r\n            break;\r\n    }\r\n};"],"names":["WorkerRegistry","def","id","loader","ClassConstructor","LogicRegistry","ViewRegistry","FeatureEnum","Game1Worker","m","Game2Worker","BHWorker","Game3Worker","WorkerFeatures","initializeWorkerRegistries","logicViews","logicIntViews","outputViews","states","pendingStates","type","stateName","payload","dt","frameCount","key","buffer","s","name","isInput","loadPromise","instance","e","logic","target","replyPort"],"mappings":"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"}