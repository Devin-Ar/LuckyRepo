import{B as z,a as J,b as $,G as Q}from"./BasePresenter-DAvRNARl.js";import{F as p,S as C,a as S,B as x,I as q,A as Z,r as c,j as n,k as H,b as ee,c as te,l as re}from"./index-Cx4hW8x4.js";import{C as X}from"./CampaignManager-BzEj4yem.js";import{S as se}from"./SaveManager-DLlG5_Hn.js";import{m as f,G as ne}from"./GameSprite-ClXVN_ki.js";class oe extends z{isDead=!1;hasExited=!1;constructor(s){super(s,p.BH_GAME)}takeDamage(){this.send("TAKE_DAMAGE",{amount:15})}async jumpToGame2(){const s=await C.create(p.GAME_2,{reset:!1});await S.getInstance().replace(s)}async loadLevel(s){const e=await C.create(p.BH_GAME,{reset:!1,level:s});await S.getInstance().replace(e)}async resetLevel(){await se.getInstance().performLoad(this.QUICK_SAVE_KEY);const s=this.vm.currentLevel||x.Level1,e=await C.create(p.BH_GAME,{reset:!1,level:s});await S.getInstance().replace(e)}onKeyDown(s){q.getInstance().isKeyAction(s.key,"PAUSE")&&this.openPauseMenu()}onWorkerEvent(s){s==="EXPLOSION_REQ"&&Z.getInstance().play("sfx_explosion"),s==="PLAYER_DEAD"&&!this.isDead&&(this.isDead=!0,this.handlePlayerDeath()),s==="EXIT_DOOR_ENTERED"&&!this.hasExited&&(this.hasExited=!0,this.handleExitDoor())}handlePlayerDeath(){X.getInstance().failCurrentStep()}handleExitDoor(){X.getInstance().completeCurrentStep()}async openPauseMenu(){const s=S.getInstance();if(s.getCurrentStateName()===this.stateName){const e=await C.create(p.PAUSE_MENU);await s.push(e)}}}const h={HERO_X:0,HERO_Y:1,HERO_ROTATION:2,HERO_SCALE:3,HERO_HP_DISPLAY:4,HERO_FRAME:5,ACTIVE_ROCK_COUNT:8,CURRENT_WAVE:9,TOTAL_WAVES:12,WAVE_STATE:13,WAVE_DELAY_TIMER:14,EXIT_DOOR_ACTIVE:15,EXIT_DOOR_X:16,EXIT_DOOR_Y:17,CURRENT_LEVEL:18,BOSS_HP:19,BOSS_VULNERABLE:20,ROCKS_START_INDEX:21,BOSS_X:21,BOSS_Y:22,BOSS_ACTIVE:23,ROCKS_START_INDEX_ACTUAL:24,ROCK_STRIDE:6,PPROJ_START_INDEX:200,PPROJ_STRIDE:2,EPROJ_START_INDEX:300,EPROJ_STRIDE:2,BUFFER_SIZE:4096},ie=["IDLE","DELAY","ACTIVE","CLEARED","ALL_CLEARED"];class ae extends J{get pos(){return{x:this.sharedView[h.HERO_X]||0,y:this.sharedView[h.HERO_Y]||0}}get hp(){return this.sharedView[h.HERO_HP_DISPLAY]||0}get entityCount(){return Math.floor(this.sharedView[h.ACTIVE_ROCK_COUNT]||0)}get projCount(){return Math.floor(this.sharedView[h.PPROJ_START_INDEX-1]||0)}get projEnemyCount(){return Math.floor(this.sharedView[h.EPROJ_START_INDEX-1]||0)}get currentWave(){return Math.floor(this.sharedView[h.CURRENT_WAVE]||0)}get totalWaves(){return Math.floor(this.sharedView[h.TOTAL_WAVES]||0)}get waveState(){const s=Math.floor(this.sharedView[h.WAVE_STATE]||0);return ie[s]||"IDLE"}get waveDelayTimer(){return Math.floor(this.sharedView[h.WAVE_DELAY_TIMER]||0)}get isRoomCleared(){return this.waveState==="ALL_CLEARED"&&this.entityCount===0}get exitDoorActive(){return(this.sharedView[h.EXIT_DOOR_ACTIVE]||0)===1}get exitDoorX(){return this.sharedView[h.EXIT_DOOR_X]||0}get exitDoorY(){return this.sharedView[h.EXIT_DOOR_Y]||0}get currentLevelIndex(){return Math.floor(this.sharedView[h.CURRENT_LEVEL]||0)}get bossHp(){return this.sharedView[h.BOSS_HP]||0}get bossVulnerable(){return(this.sharedView[h.BOSS_VULNERABLE]||0)===1}get bossPos(){return{x:this.sharedView[h.BOSS_X]||0,y:this.sharedView[h.BOSS_Y]||0}}get bossActive(){return(this.sharedView[h.BOSS_ACTIVE]||0)===1}get heroVisuals(){return{x:this.sharedView[h.HERO_X]||0,y:this.sharedView[h.HERO_Y]||0,rotation:this.sharedView[h.HERO_ROTATION]||0,scale:this.sharedView[h.HERO_SCALE]||1,currentFrame:this.sharedView[h.HERO_FRAME]||0}}getRockViewData(s){const e=h.ROCKS_START_INDEX_ACTUAL+s*h.ROCK_STRIDE;return{x:this.sharedView[e]||0,y:this.sharedView[e+1]||0,rotation:this.sharedView[e+2]||0}}getRockAttackData(s){const e=h.ROCKS_START_INDEX_ACTUAL+s*h.ROCK_STRIDE;return{primedMode:this.sharedView[e+3]||0,endX:this.sharedView[e+4]||0,endY:this.sharedView[e+5]||0}}getPlayerProjData(s){const e=h.PPROJ_START_INDEX+s*h.PPROJ_STRIDE;return{x:this.sharedView[e]||0,y:this.sharedView[e+1]||0}}getEnemyProjData(s){const e=h.EPROJ_START_INDEX+s*h.EPROJ_STRIDE;return{x:this.sharedView[e]||0,y:this.sharedView[e+1]||0}}}const ce=({w:r,h:s})=>{const e=f.useApp();return c.useEffect(()=>{e?.renderer&&(e.renderer.resize(r,s),e.view instanceof HTMLCanvasElement&&(e.view.width=r,e.view.height=s))},[e,r,s]),null},le=({paused:r,w:s,h:e})=>{const u=c.useRef(null),i=c.useRef(0);return c.useEffect(()=>{u.current?.clear().beginFill(16777215).drawRect(0,0,s,e).endFill()},[s,e]),f.useTick(a=>{if(!u.current||r)return;i.current+=Math.PI/60*a;const o=(Math.sin(i.current)+1)/2,t=Math.round(26+o*4),l=Math.round(26+o*54),d=Math.round(46+o*104);u.current.tint=(t<<16)+(l<<8)+d}),n.jsx(f.Graphics,{ref:u})},ue=({vm:r,paused:s})=>{const e=c.useRef(null),u=c.useRef([]),i=ee.getInstance();return c.useEffect(()=>()=>{u.current.forEach(a=>{a&&!a.destroyed&&a.destroy()}),u.current=[]},[]),f.useTick(()=>{if(!e.current)return;const a=r.entityCount,o=u.current;if(a>o.length)for(let t=o.length;t<a;t++){const l=i.getTexture("static_rock");if(l){const d=new te(l);d.anchor.set(.5),d.scale.set(.8),e.current.addChild(d),o.push(d)}}else if(a<o.length)for(let t=o.length-1;t>=a;t--){const l=o.pop();l&&(e.current.removeChild(l),l.destroy())}for(let t=0;t<a;t++){const l=o[t],d=r.getRockViewData(t);if(!d||s){l&&(l.visible=!1);continue}l.visible=!0,l.x=d.x,l.y=d.y,l.rotation=d.rotation}}),n.jsx(f.Container,{ref:e})},he=({vm:r,paused:s})=>{const e=c.useRef(null),u=c.useRef([]);return c.useEffect(()=>()=>{u.current.forEach(i=>{i&&!i.destroyed&&i.destroy()}),u.current=[]},[]),f.useTick(()=>{if(!e.current)return;const i=r.entityCount,a=u.current;if(i>a.length)for(let o=a.length;o<i;o++){const t=new H;t.visible=!1,e.current.addChild(t),a.push(t)}else if(i<a.length)for(let o=a.length-1;o>=i;o--){const t=a.pop();t&&(e.current.removeChild(t),t.destroy())}for(let o=0;o<i;o++){const t=a[o],l=r.getRockAttackData(o),d=r.getRockViewData(o);if(!l||s){t&&(t.visible=!1);continue}l.primedMode===1?(t.visible=!0,t.clear(),t.lineStyle(30,16711680),t.moveTo(d.x,d.y),t.lineTo(l.endX,l.endY)):t.visible=!1}}),n.jsx(f.Container,{ref:e})},de=({vm:r,paused:s})=>{const e=c.useRef(null),u=c.useRef([]);return c.useEffect(()=>()=>{u.current.forEach(i=>{i&&!i.destroyed&&i.destroy()}),u.current=[]},[]),f.useTick(()=>{if(!e.current)return;const i=r.projCount,a=u.current;if(i>a.length)for(let o=a.length;o<i;o++){const t=new H;t.visible=!1,e.current.addChild(t),a.push(t)}else if(i<a.length)for(let o=a.length-1;o>=i;o--){const t=a.pop();t&&(e.current.removeChild(t),t.destroy())}for(let o=0;o<i;o++){const t=a[o],l=r.getPlayerProjData(o);if(!l||s){t&&(t.visible=!1);continue}t.visible=!0,t.clear(),t.lineStyle(10,65280),t.drawRect(l.x,l.y,20,20)}}),n.jsx(f.Container,{ref:e})},fe=({vm:r,paused:s})=>{const e=c.useRef(null),u=c.useRef([]);return c.useEffect(()=>()=>{u.current.forEach(i=>{i&&!i.destroyed&&i.destroy()}),u.current=[]},[]),f.useTick(()=>{if(!e.current)return;const i=r.projEnemyCount,a=u.current;if(i>a.length)for(let o=a.length;o<i;o++){const t=new H;t.visible=!1,e.current.addChild(t),a.push(t)}else if(i<a.length)for(let o=a.length-1;o>=i;o--){const t=a.pop();t&&(e.current.removeChild(t),t.destroy())}for(let o=0;o<i;o++){const t=a[o],l=r.getEnemyProjData(o);if(!l||s){t&&(t.visible=!1);continue}t.visible=!0,t.clear(),t.lineStyle(10,16711680),t.drawRect(l.x,l.y,20,20)}}),n.jsx(f.Container,{ref:e})},Ee=({vm:r,paused:s})=>{const e=c.useRef(null);return f.useTick(()=>{if(!e.current)return;if(!r.bossActive||s){e.current.visible=!1;return}const u=r.bossPos,i=r.bossVulnerable;e.current.visible=!0,e.current.clear(),e.current.beginFill(i?15158332:4473924),e.current.lineStyle(4,16777215),e.current.drawRect(u.x,u.y,200,200),e.current.endFill()}),n.jsx(f.Graphics,{ref:e})},Re=({vm:r,paused:s,width:e,height:u,scale:i,heroPos:a,hp:o})=>{const t=c.useRef(null),[l,d]=c.useState(r.heroVisuals);return f.useTick(()=>{const E=r.heroVisuals;t.current&&(t.current.x=E.x,t.current.y=E.y,t.current.rotation=E.rotation,t.current.scale.set(E.scale),a.current.x=E.x,a.current.y=E.y,d(E))}),n.jsxs(n.Fragment,{children:[n.jsx(ce,{w:e,h:u}),n.jsx(le,{paused:s,w:e,h:u}),n.jsxs(f.Container,{scale:i,children:[n.jsx(de,{vm:r,paused:s}),n.jsx(fe,{vm:r,paused:s}),n.jsx(he,{vm:r,paused:s}),n.jsx(ue,{vm:r,paused:s}),n.jsx(Ee,{vm:r,paused:s}),n.jsx(f.Container,{ref:t,children:n.jsx(ne,{sheetName:"hero_sheet",animationName:"idle",x:0,y:0,scale:1,anchor:.5,currentFrame:l.currentFrame})})]})]})},ge=({hp:r,rockCount:s,currentWave:e,totalWaves:u,waveState:i,waveDelayTimer:a,isRoomCleared:o,exitDoorActive:t,exitDoorX:l,exitDoorY:d,bossHp:E,bossVulnerable:g,gameWidth:_,gameHeight:T,shieldBarRef:w,shieldTextRef:D,damageBtnRef:O,onDamage:b,onJumpToG2:I,onLevel1:L,onLevel2:V,onLevel3:j,onLevel4:P,onResetG1:v})=>{const R={padding:"0.6cqw 1cqw",cursor:"pointer",color:"#fff",border:"none",borderRadius:"0.4cqw",fontWeight:"bold",fontFamily:"monospace",fontSize:"0.8cqw",pointerEvents:"auto",textAlign:"center"},m=()=>o?"ROOM CLEARED!":i==="DELAY"?`NEXT WAVE IN ${Math.ceil(a/60)}s`:i==="ACTIVE"?`ENEMIES: ${s}`:i==="CLEARED"?"WAVE CLEARED!":"STANDBY",A=()=>o?"#f1c40f":i==="DELAY"?"#e67e22":i==="ACTIVE"?"#e74c3c":i==="CLEARED"?"#2ecc71":"#888";return n.jsxs("div",{style:{position:"absolute",inset:0,pointerEvents:"none",containerType:"size"},children:[n.jsxs("div",{style:{position:"absolute",top:"5cqh",left:"50%",transform:"translateX(-50%)",width:"35cqw"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",color:"#fff",marginBottom:"0.5cqh",fontWeight:"bold",fontFamily:"monospace",fontSize:"1.2cqw"},children:[n.jsx("span",{children:"SHIELD ENERGY"}),n.jsxs("span",{ref:D,children:[Math.round(r),"%"]})]}),n.jsx("div",{style:{width:"100%",height:"2cqh",backgroundColor:"#222",borderRadius:"1cqw",border:"0.2cqw solid #fff",overflow:"hidden"},children:n.jsx("div",{ref:w,style:{width:`${Math.max(0,r)}%`,height:"100%",backgroundColor:r<30?"#c0392b":"#27ae60"}})})]}),E>0&&n.jsxs("div",{style:{position:"absolute",top:"15cqh",left:"50%",transform:"translateX(-50%)",width:"50cqw"},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",color:g?"#e74c3c":"#888",marginBottom:"0.5cqh",fontWeight:"bold",fontFamily:"monospace",fontSize:"1cqw"},children:[n.jsxs("span",{children:["THE CORE ",g?"(VULNERABLE)":"(PROTECTED)"]}),n.jsxs("span",{children:[Math.max(0,E)," / 300"]})]}),n.jsx("div",{style:{width:"100%",height:"1.5cqh",backgroundColor:"#111",borderRadius:"0.75cqw",border:`0.2cqw solid ${g?"#e74c3c":"#444"}`,overflow:"hidden",boxShadow:g?"0 0 10px rgba(231, 76, 60, 0.4)":"none"},children:n.jsx("div",{style:{width:`${Math.max(0,E)/300*100}%`,height:"100%",backgroundColor:g?"#e74c3c":"#444",transition:"width 0.3s ease-out, background-color 0.3s ease"}})})]}),n.jsxs("div",{style:{position:"absolute",top:"3cqh",right:"3cqw",color:"#fff",fontFamily:"monospace",textAlign:"right",fontSize:"1.2cqw"},children:[n.jsxs("div",{style:{color:A(),fontSize:"1.4cqw",fontWeight:"bold",marginBottom:"0.5cqh"},children:["WAVE ",e+1," / ",u]}),n.jsx("div",{style:{color:A(),fontSize:"1cqw"},children:m()}),n.jsxs("div",{style:{color:"#888",fontSize:"0.8cqw",marginTop:"0.3cqh"},children:["ENEMIES_ACTIVE: ",s]})]}),o&&n.jsxs("div",{style:{position:"absolute",top:"40%",left:"50%",transform:"translate(-50%, -50%)",color:"#f1c40f",fontFamily:"monospace",fontSize:"3cqw",fontWeight:"bold",textShadow:"0 0 20px rgba(241, 196, 60, 0.6)",textAlign:"center",letterSpacing:"0.3cqw"},children:["ALL WAVES CLEARED",n.jsx("div",{style:{fontSize:"1.2cqw",color:"#fff",marginTop:"1cqh"},children:"PROCEED TO EXIT"})]}),t&&_>0&&T>0&&n.jsx("div",{style:{position:"absolute",left:`${l/_*100}%`,top:`${d/T*100}%`,transform:"translate(-50%, -50%)",width:"6.25%",height:"11.1%",border:"3px solid #f1c40f",backgroundColor:"rgba(241, 196, 60, 0.25)",boxShadow:"0 0 20px rgba(241, 196, 60, 0.5), inset 0 0 15px rgba(241, 196, 60, 0.3)",display:"flex",alignItems:"center",justifyContent:"center",animation:"exitDoorPulse 1.5s ease-in-out infinite"},children:n.jsx("span",{style:{color:"#f1c40f",fontFamily:"monospace",fontWeight:"bold",fontSize:"0.9cqw",textShadow:"0 0 8px rgba(241, 196, 60, 0.8)"},children:"EXIT"})}),t&&n.jsx("style",{children:`
                    @keyframes exitDoorPulse {
                        0%, 100% { box-shadow: 0 0 20px rgba(241, 196, 60, 0.5), inset 0 0 15px rgba(241, 196, 60, 0.3); }
                        50% { box-shadow: 0 0 35px rgba(241, 196, 60, 0.8), inset 0 0 25px rgba(241, 196, 60, 0.5); }
                    }
                `}),i==="DELAY"&&a>0&&n.jsxs("div",{style:{position:"absolute",top:"35%",left:"50%",transform:"translate(-50%, -50%)",color:"#e67e22",fontFamily:"monospace",fontSize:"2cqw",fontWeight:"bold",textShadow:"0 0 15px rgba(230, 126, 34, 0.5)",textAlign:"center",opacity:.9},children:["WAVE ",e+1," INCOMING",n.jsx("div",{style:{fontSize:"4cqw",color:"#fff",marginTop:"0.5cqh"},children:Math.ceil(a/60)})]}),n.jsxs("div",{style:{position:"absolute",top:"3cqh",left:"3cqw",display:"flex",flexDirection:"column",gap:"1cqh"},children:[n.jsx("button",{ref:O,onClick:b,style:{...R,background:"#333",border:"0.1cqw solid #fff"},children:"TAKE DAMAGE (-15)"}),n.jsxs("div",{style:{display:"flex",gap:"0.5cqw"},children:[n.jsx("button",{onClick:L,style:{...R,background:"#408240",flex:1},children:"LVL 1"}),n.jsx("button",{onClick:V,style:{...R,background:"#C29F19",flex:1},children:"LVL 2"}),n.jsx("button",{onClick:j,style:{...R,background:"#C21919",flex:1},children:"LVL 3"}),n.jsx("button",{onClick:P,style:{...R,background:"#8E44AD",flex:1},children:"LVL 4"})]}),n.jsx("button",{onClick:I,style:{...R,background:"#2980b9"},children:"Go to Game 2"}),n.jsx("div",{style:{display:"flex",gap:"0.5cqw"},children:n.jsx("button",{onClick:v,style:{...R,background:"#c0392b",flex:1},children:"Quick Load"})})]})]})},pe=({vm:r,controller:s,width:e=960,height:u=540})=>{const[i,a]=c.useState(r.hp),[o,t]=c.useState(r.entityCount),[l,d]=c.useState(!1),[E,g]=c.useState(r.currentWave),[_,T]=c.useState(r.totalWaves),[w,D]=c.useState(r.waveState),[O,b]=c.useState(r.waveDelayTimer),[I,L]=c.useState(r.isRoomCleared),[V,j]=c.useState(r.exitDoorActive),[P,v]=c.useState(r.exitDoorX),[R,m]=c.useState(r.exitDoorY),[A,W]=c.useState(r.bossHp),[Y,F]=c.useState(r.bossVulnerable),M=c.useRef(null),B=c.useRef(null),G=c.useRef(null),k=c.useRef({x:r.pos.x,y:r.pos.y});c.useEffect(()=>{const K=r.subscribe(()=>{const N=S.getInstance().getActiveState()?.name!=="BHGame";l!==N&&d(N);const y=r.hp;k.current.x=r.pos.x,k.current.y=r.pos.y,M.current&&(M.current.style.width=`${Math.max(0,y)}%`),B.current&&(B.current.innerText=`${Math.round(y)}%`),Math.abs(i-y)>1&&a(y),o!==r.entityCount&&t(r.entityCount),g(r.currentWave),T(r.totalWaves),D(r.waveState),b(r.waveDelayTimer),L(r.isRoomCleared),j(r.exitDoorActive),v(r.exitDoorX),m(r.exitDoorY),W(r.bossHp),F(r.bossVulnerable)});return()=>K()},[r,i,o,l]);const U=c.useMemo(()=>e/960,[e]);return n.jsxs("div",{style:{position:"absolute",inset:0,background:"#000",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:[n.jsx("div",{style:{position:"relative",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:n.jsx(f.Stage,{width:e,height:u,options:{backgroundColor:0,antialias:!0,resolution:1,autoDensity:!1},style:{display:"block",width:"100%",height:"100%",objectFit:"contain",imageRendering:"pixelated"},children:n.jsx(Re,{vm:r,paused:l,width:e,height:u,scale:U,heroPos:k,hp:i})},`stage-${e}-${u}`)}),n.jsx(ge,{hp:i,rockCount:o,currentWave:E,totalWaves:_,waveState:w,waveDelayTimer:O,isRoomCleared:I,exitDoorActive:V,exitDoorX:P,exitDoorY:R,bossHp:A,bossVulnerable:Y,gameWidth:e,gameHeight:u,shieldBarRef:M,shieldTextRef:B,damageBtnRef:G,onDamage:()=>s.takeDamage(),onJumpToG2:()=>s.jumpToGame2(),onLevel1:()=>s.loadLevel(x.Level1),onLevel2:()=>s.loadLevel(x.Level2),onLevel3:()=>s.loadLevel(x.Level3),onLevel4:()=>s.loadLevel(x.Level4),onResetG1:()=>s.resetLevel()})]})},xe={HERO_HP:0,HERO_X:1,HERO_Y:2,TICK_COUNT:3,FRAME_COUNT:4,FPS:5,REVISION:6,LAST_HIT_FRAME:7,ENTITY_COUNT:8,CURRENT_WAVE:9,TOTAL_WAVES:12,WAVE_STATE:13,WAVE_DELAY_TIMER:14,EXIT_DOOR_ACTIVE:15,EXIT_DOOR_X:16,EXIT_DOOR_Y:17,CURRENT_LEVEL:18,BOSS_HP:19,BOSS_VULNERABLE:20,ROCKS_START_INDEX:21,BOSS_X:21,BOSS_Y:22,BOSS_ACTIVE:23,ROCKS_START_INDEX_ACTUAL:24,PPROJ_START_INDEX:200,PPROJ_STRIDE:2,EPROJ_START_INDEX:300,EPROJ_STRIDE:2,ROCK_STRIDE:6,MAX_ROCKS:1e3,BUFFER_SIZE:4096};class De extends ${name=p.BH_GAME;logicSchema=xe;viewSchema=h;viewComponent=pe;currentLevel;constructor(s={}){super(s.reset??!1),this.currentLevel=s.level??x.Level1}getConfig(){return re(this.currentLevel)}getSessionOverrides(s){const e=s.get(Q.hp);return e!==void 0?{initialHP:e}:{}}initMVC(){this.vm=new ae,this.controller=new oe(this.vm)}async init(){q.getInstance().refreshBindings(this.name),await super.init()}}export{De as BHState};
//# sourceMappingURL=BHState-CSo4e3PP.js.map
