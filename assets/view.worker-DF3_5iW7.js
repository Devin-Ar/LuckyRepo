(function(){"use strict";const V={HERO_HP:0,HERO_X:1,HERO_Y:2,ENTITY_COUNT:8},m={STRIDE:3},l={HERO_X:0,HERO_Y:1,HERO_ROTATION:2,HERO_SCALE:3,HERO_HP_DISPLAY:4,HERO_FRAME:5,ACTIVE_ROCK_COUNT:6},H={STRIDE:3};class I{logicViews=new Map;logicIntViews=new Map;outputViews=new Map;setBuffers(e,s,i){this.logicViews=e,this.logicIntViews=s,this.outputViews=i}get logicView(){return(this.logicViews.get("main")||this.logicViews.values().next().value)??new Float32Array(0)}get logicIntView(){return(this.logicIntViews.get("main")||this.logicIntViews.values().next().value)??new Int32Array(0)}get outputView(){return(this.outputViews.get("main")||this.outputViews.values().next().value)??new Float32Array(0)}getSnapshot(){return{}}loadSnapshot(e){}destroy(){}hasBuffers(){return this.logicViews.size>0&&this.outputViews.size>0}}class N extends I{heroRotation=0;globalRockRotation=0;heroFrame=0;update(e,s){const i=this.logicViews.get("main"),c=this.logicViews.get("rocks"),a=this.outputViews.get("main"),h=this.outputViews.get("rocks");if(!i||!c||!a||!h)return;const n=i[V.ENTITY_COUNT],t=Math.floor(h.length/H.STRIDE);n>t?this._outResizePending!==t&&(self.postMessage({type:"REQUEST_RESIZE_OUTPUT",payload:{bufferName:"rocks",newSize:(n+1e3)*H.STRIDE}}),this._outResizePending=t):this._outResizePending=0;const o=i[V.HERO_HP];this.heroRotation+=.03*(e/16.67),this.heroFrame+=.15*(e/16.67),a[l.HERO_X]=i[V.HERO_X],a[l.HERO_Y]=i[V.HERO_Y],a[l.HERO_ROTATION]=this.heroRotation,a[l.HERO_SCALE]=.5+o/100,a[l.HERO_HP_DISPLAY]=o,a[l.HERO_FRAME]=this.heroFrame;const _=Math.min(n,t);a[l.ACTIVE_ROCK_COUNT]=_,this.globalRockRotation+=.02*(e/16.67);for(let u=0;u<_;u++){const S=u*m.STRIDE,A=u*H.STRIDE;if(S+2>=c.length)break;h[A]=c[S],h[A+1]=c[S+1];const C=c[S+2],B=(Math.floor(C)%5+1)*.5;h[A+2]=this.globalRockRotation*B+C}}getSnapshot(){return{heroRotation:this.heroRotation,globalRockRotation:this.globalRockRotation,heroFrame:this.heroFrame}}loadSnapshot(e){e&&(this.heroRotation=e.heroRotation??0,this.globalRockRotation=e.globalRockRotation??0,this.heroFrame=e.heroFrame??0)}}const f={HERO_HP:0,ENERGY:1,SCRAP_COUNT:2},g={HERO_HP_DISPLAY:0,ENERGY_DISPLAY:1,SCRAP_DISPLAY:2,UI_BOUNCE:3,GLITCH_INTENSITY:4,VIGNETTE_PULSE:5};class P extends I{uiBounce=0;glitchIntensity=0;lastHp=-1;update(e,s){if(!this.hasBuffers())return;const i=this.logicView[f.HERO_HP],c=this.logicView[f.ENERGY];this.lastHp!==-1&&i<this.lastHp&&(this.glitchIntensity=1),this.lastHp=i,this.glitchIntensity*=.92,this.outputView[g.HERO_HP_DISPLAY]=i,this.outputView[g.ENERGY_DISPLAY]=c,this.outputView[g.SCRAP_DISPLAY]=this.logicView[f.SCRAP_COUNT];const a=e/16.67;this.uiBounce+=.05*a;const h=c<20?.15:.05,n=.5+Math.sin(s*h)*.2;this.outputView[g.UI_BOUNCE]=Math.sin(this.uiBounce)*5,this.outputView[g.GLITCH_INTENSITY]=this.glitchIntensity,this.outputView[g.VIGNETTE_PULSE]=n}getSnapshot(){return{uiBounce:this.uiBounce,glitchIntensity:this.glitchIntensity,lastHp:this.lastHp}}loadSnapshot(e){e&&(this.uiBounce=e.uiBounce??0,this.glitchIntensity=e.glitchIntensity??0,this.lastHp=e.lastHp??-1)}}const p={HERO_HP:0,HERO_X:1,HERO_Y:2,ENTITY_COUNT:8,ROCKS_START_INDEX:10,ROCK_STRIDE:8},R={HERO_X:0,HERO_Y:1,HERO_ROTATION:2,HERO_SCALE:3,HERO_HP_DISPLAY:4,HERO_FRAME:5,ACTIVE_ROCK_COUNT:8,ROCKS_START_INDEX:10,ROCK_STRIDE:8};class k extends I{heroRotation=0;globalRockRotation=0;heroFrame=0;update(e,s){if(!this.hasBuffers())return;const i=this.logicView[p.HERO_X],c=this.logicView[p.HERO_Y],a=this.logicView[p.HERO_HP];this.heroRotation+=.03*(e/16.67),this.heroFrame+=.15*(e/16.67),this.outputView[R.HERO_X]=i,this.outputView[R.HERO_Y]=c,this.outputView[R.HERO_ROTATION]=this.heroRotation,this.outputView[R.HERO_SCALE]=.5+a/100,this.outputView[R.HERO_HP_DISPLAY]=a,this.outputView[R.HERO_FRAME]=this.heroFrame;const h=this.logicView[p.ENTITY_COUNT];this.outputView[R.ACTIVE_ROCK_COUNT]=h,this.globalRockRotation+=.02*(e/16.67);for(let n=0;n<h;n++){const t=p.ROCKS_START_INDEX+n*p.ROCK_STRIDE,o=R.ROCKS_START_INDEX+n*R.ROCK_STRIDE;this.outputView[o]=this.logicView[t],this.outputView[o+1]=this.logicView[t+1];const _=this.logicView[t+2],u=(Math.floor(_)%5+1)*.5;this.outputView[o+2]=this.globalRockRotation*u+_,this.outputView[o+3]=this.logicView[t+3],this.outputView[o+4]=this.logicView[t+4],this.outputView[o+5]=this.logicView[t+5],this.outputView[o+6]=this.logicView[t+6],this.outputView[o+7]=this.logicView[t+7]}}getSnapshot(){return{heroRotation:this.heroRotation,globalRockRotation:this.globalRockRotation,heroFrame:this.heroFrame}}loadSnapshot(e){e&&(this.heroRotation=e.heroRotation??0,this.globalRockRotation=e.globalRockRotation??0,this.heroFrame=e.heroFrame??0)}}const E=new Map,O=new Map,w=new Map,r=new Map;self.onmessage=T=>{const{type:e,stateName:s,payload:i,dt:c,frameCount:a}=T.data;switch(e){case"INIT_SABS":E.clear(),O.clear(),w.clear(),i.inputBuffers&&Object.entries(i.inputBuffers).forEach(([t,o])=>{E.set(t,new Float32Array(o)),O.set(t,new Int32Array(o))}),i.outputBuffers&&Object.entries(i.outputBuffers).forEach(([t,o])=>{w.set(t,new Float32Array(o))}),r.forEach(t=>t.setBuffers?.(E,O,w));break;case"UPDATE_BUFFER":{const{name:t,buffer:o,isInput:_}=i;_?(E.set(t,new Float32Array(o)),O.set(t,new Int32Array(o))):w.set(t,new Float32Array(o)),r.forEach(u=>u.setBuffers?.(E,O,w));break}case"CREATE_STATE":if(!r.has(s)){console.log(`[ViewWorker] Created ViewLogic for: ${s}`);let t;s==="Game1"&&(t=new N),s==="Game2"&&(t=new P),s==="BHTest"&&(t=new k),t&&(r.set(s,t),t.setBuffers(E,O,w))}break;case"TICK":const h=r.get(s);h&&E.size>0&&w.size>0&&h.update(c,a);break;case"TERMINATE_STATE":r.has(s)&&(r.get(s).destroy?.(),r.delete(s));break;case"TERMINATE_ALL":r.forEach(t=>t.destroy?.()),r.clear();break;case"INPUT":const n=r.get(s);if(!n)return;if(i.action==="GET_SNAPSHOT"){const t=T.ports[0];t&&t.postMessage(n.getSnapshot())}else i.action==="LOAD_SNAPSHOT"&&n.loadSnapshot(i.data);break}}})();
