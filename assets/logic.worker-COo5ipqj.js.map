{"version":3,"file":"logic.worker-COo5ipqj.js","sources":["../src/core/registry/WorkerRegistry.ts","../src/features/FeatureEnum.ts","../src/features/Game1/index.worker.ts","../src/features/Game2/index.worker.ts","../src/features/BulletTest/index.worker.ts","../src/features/Game3/index.worker.ts","../src/features/workers.ts","../src/config/WorkerManifest.ts","../src/workers/logic.worker.ts"],"sourcesContent":["// src/core/registry/WorkerRegistry.ts\r\nexport interface WorkerRegistryItem<T> {\r\n    id: string;\r\n    loader: () => Promise<new () => T>;\r\n}\r\n\r\nexport class WorkerRegistry<T> {\r\n    private loaders = new Map<string, () => Promise<new () => T>>();\r\n\r\n    public register(def: WorkerRegistryItem<T>) {\r\n        this.loaders.set(def.id, def.loader);\r\n    }\r\n\r\n    public async create(id: string): Promise<T> {\r\n        const loader = this.loaders.get(id);\r\n        if (!loader) {\r\n            throw new Error(`WorkerRegistry: No loader registered for ID \"${id}\"`);\r\n        }\r\n\r\n        const ClassConstructor = await loader();\r\n        return new ClassConstructor();\r\n    }\r\n}\r\n\r\nexport const LogicRegistry = new WorkerRegistry<any>();\r\nexport const ViewRegistry = new WorkerRegistry<any>();","//src/features/FeatureEnum.ts\r\nexport enum FeatureEnum {\r\n    GAME_1 = \"Game1\",\r\n    GAME_2 = \"Game2\",\r\n    GAME_3 = \"Game3\",\r\n    BH_GAME = \"BHGame\",\r\n    DEV_MENU = \"DevMenu\",\r\n    PAUSE_MENU = \"PauseMenu\",\r\n    SAVE_MENU = \"SaveMenu\",\r\n    SETTINGS_MENU = \"SettingsMenu\",\r\n    CONTINUE = \"ContinueScreen\",\r\n    GAME_OVER = \"GameOverScreen\",\r\n}","// src/features/Game1/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const Game1Worker: WorkerDefinition = {\r\n    id: FeatureEnum.GAME_1,\r\n    logicLoader: () => import(\"./logic/Game1Logic\").then(m => m.Game1Logic),\r\n    viewLoader: () => import(\"./view/Game1ViewLogic\").then(m => m.Game1ViewLogic)\r\n};","// src/features/Game2/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const Game2Worker: WorkerDefinition = {\r\n    id: FeatureEnum.GAME_2,\r\n    logicLoader: () => import(\"./logic/Game2Logic\").then(m => m.Game2Logic),\r\n    viewLoader: () => import(\"./view/Game2ViewLogic\").then(m => m.Game2ViewLogic)\r\n};","// src/features/BulletTest/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const BHWorker: WorkerDefinition = {\r\n    id: FeatureEnum.BH_GAME,\r\n    logicLoader: () => import(\"./logic/BHTestLogic\").then(m => m.BHTestLogic),\r\n    viewLoader: () => import(\"./view/BHViewLogic\").then(m => m.BHViewLogic)\r\n};","// src/features/Game3/index.worker.ts\r\nimport { FeatureEnum } from \"../FeatureEnum\";\r\nimport { WorkerDefinition } from \"../FeatureTypes\";\r\n\r\nexport const Game3Worker: WorkerDefinition = {\r\n    id: FeatureEnum.GAME_3,\r\n    logicLoader: () => import(\"./logic/Game3Logic\").then(m => m.Game3Logic),\r\n    viewLoader: () => import(\"./view/Game3ViewLogic\").then(m => m.Game3ViewLogic)\r\n};","//src/features/workers.ts\r\nimport { WorkerDefinition } from \"./FeatureTypes\";\r\nimport { Game1Worker } from \"./Game1/index.worker\";\r\nimport { Game2Worker } from \"./Game2/index.worker\";\r\nimport {BHWorker} from \"./BulletTest/index.worker\";\r\nimport {Game3Worker} from \"./Game3/index.worker\";\r\n\r\nexport const WorkerFeatures: WorkerDefinition[] = [\r\n    Game1Worker,\r\n    Game2Worker,\r\n    Game3Worker,\r\n    BHWorker\r\n];","// src/config/WorkerManifest.ts\r\nimport { LogicRegistry, ViewRegistry } from \"../core/registry/WorkerRegistry\";\r\nimport { WorkerFeatures } from \"../features/workers\";\r\n\r\nexport const initializeWorkerRegistries = () => {\r\n    WorkerFeatures.forEach(def => {\r\n        if (def.logicLoader) {\r\n            LogicRegistry.register({ id: def.id, loader: def.logicLoader });\r\n        }\r\n        if (def.viewLoader) {\r\n            ViewRegistry.register({ id: def.id, loader: def.viewLoader });\r\n        }\r\n    });\r\n};","// src/workers/logic.worker.ts\r\nimport { LogicRegistry } from '../core/registry/WorkerRegistry';\r\nimport { initializeWorkerRegistries } from '../config/WorkerManifest';\r\n\r\ninitializeWorkerRegistries();\r\n\r\nconst sharedBuffers: Map<string, SharedArrayBuffer> = new Map();\r\nconst sharedViews: Map<string, Float32Array> = new Map();\r\nconst intViews: Map<string, Int32Array> = new Map();\r\n\r\nconst states: Map<string, any> = new Map();\r\nconst pendingStates: Map<string, Promise<any>> = new Map();\r\n\r\nself.onmessage = async (e: MessageEvent) => {\r\n    const {type, stateName, payload, frameCount, fps} = e.data;\r\n\r\n    switch (type) {\r\n        case 'INIT_SABS':\r\n            console.log(`[Worker] Initializing Buffer Map`);\r\n\r\n            sharedBuffers.clear();\r\n            sharedViews.clear();\r\n            intViews.clear();\r\n\r\n            if (payload.buffers) {\r\n                Object.entries(payload.buffers as Record<string, SharedArrayBuffer>).forEach(([name, buffer]) => {\r\n                    sharedBuffers.set(name, buffer);\r\n                    sharedViews.set(name, new Float32Array(buffer));\r\n                    intViews.set(name, new Int32Array(buffer));\r\n                });\r\n            }\r\n\r\n            states.forEach((state, name) => {\r\n                if (typeof state.setBuffers === 'function') {\r\n                    const bufferRecord: Record<string, SharedArrayBuffer> = {};\r\n                    sharedBuffers.forEach((buf, key) => bufferRecord[key] = buf);\r\n                    state.setBuffers(bufferRecord);\r\n                }\r\n            });\r\n            break;\r\n\r\n        case 'UPDATE_BUFFER':\r\n            const { name, buffer } = payload;\r\n            sharedBuffers.set(name, buffer);\r\n            sharedViews.set(name, new Float32Array(buffer));\r\n            intViews.set(name, new Int32Array(buffer));\r\n\r\n            states.forEach((state) => {\r\n                if (typeof state.setBuffers === 'function') {\r\n                    console.log(`[Worker] Updating buffer views for existing state: ${name}`);\r\n                    const bufferRecord: Record<string, SharedArrayBuffer> = {};\r\n                    sharedBuffers.forEach((buf, key) => bufferRecord[key] = buf);\r\n                    state.setBuffers(bufferRecord);\r\n                }\r\n            });\r\n            break;\r\n\r\n        case 'CREATE_STATE':\r\n            if (!states.has(stateName)) {\r\n                if (pendingStates.has(stateName)) {\r\n                    await pendingStates.get(stateName);\r\n                } else {\r\n                    const loadPromise = (async () => {\r\n                        const instance = await LogicRegistry.create(stateName);\r\n                        if (sharedBuffers.size > 0) {\r\n                            const bufferRecord: Record<string, SharedArrayBuffer> = {};\r\n                            sharedBuffers.forEach((buf, key) => bufferRecord[key] = buf);\r\n                            instance.setBuffers(bufferRecord);\r\n                        }\r\n                        return instance;\r\n                    })();\r\n\r\n                    pendingStates.set(stateName, loadPromise);\r\n\r\n                    try {\r\n                        const instance = await loadPromise;\r\n                        states.set(stateName, instance);\r\n                        console.log(`[Worker] Loaded Logic: ${stateName}`);\r\n                    } catch (e) {\r\n                        console.error(`[Worker] Failed to create state: ${stateName}`, e);\r\n                    } finally {\r\n                        pendingStates.delete(stateName);\r\n                    }\r\n                }\r\n            }\r\n            break;\r\n\r\n        case 'TERMINATE_STATE':\r\n            if (states.has(stateName)) {\r\n                console.log(`[Worker] Terminated Logic for: ${stateName}`);\r\n                states.get(stateName).destroy();\r\n                states.delete(stateName);\r\n            } else {\r\n                console.warn(`[Worker] Attempted to terminate non-existent state: ${stateName}`);\r\n            }\r\n            break;\r\n\r\n        case 'TERMINATE_ALL':\r\n            console.log(`[Worker] Terminating all logic states. Count: ${states.size}`);\r\n            states.forEach(s => s.destroy());\r\n            states.clear();\r\n            break;\r\n\r\n        case 'INPUT':\r\n            let target = states.get(stateName);\r\n\r\n            if (!target && pendingStates.has(stateName)) {\r\n                try {\r\n                    target = await pendingStates.get(stateName);\r\n                } catch (e) {\r\n                    // Handled in CREATE_STATE\r\n                }\r\n            }\r\n\r\n            if (target) {\r\n                if (payload.action === 'GET_SNAPSHOT') {\r\n                    console.info(`[Worker] [${stateName}] Generating Snapshot`);\r\n                    const replyPort = e.ports[0];\r\n                    if (replyPort) {\r\n                        replyPort.postMessage(target.getSnapshot());\r\n                    }\r\n                } else if (payload.action === 'LOAD_SNAPSHOT') {\r\n                    console.info(`[Worker] [${stateName}] Loading Snapshot`);\r\n                    target.loadSnapshot(payload.data);\r\n                } else {\r\n                    console.debug(`[Worker] [${stateName}] Input: ${payload.action || 'Unknown Action'}`);\r\n                    target.handleInput(payload);\r\n                }\r\n            } else {\r\n                console.error(`[Worker] Received INPUT for unknown state: ${stateName}`);\r\n            }\r\n            break;\r\n\r\n        case 'TICK':\r\n            const logic = states.get(stateName);\r\n            if (logic && sharedViews.size > 0) {\r\n                logic.update(sharedViews, intViews, frameCount, fps);\r\n            }\r\n            break;\r\n\r\n        default:\r\n            console.warn(`[Worker] Unhandled message type: ${type}`);\r\n            break;\r\n    }\r\n};"],"names":["WorkerRegistry","def","id","loader","ClassConstructor","LogicRegistry","ViewRegistry","FeatureEnum","Game1Worker","m","Game2Worker","BHWorker","Game3Worker","WorkerFeatures","initializeWorkerRegistries","sharedBuffers","sharedViews","intViews","states","pendingStates","type","stateName","payload","frameCount","fps","name","buffer","state","bufferRecord","buf","key","loadPromise","instance","e","s","target","replyPort","logic"],"mappings":"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"}