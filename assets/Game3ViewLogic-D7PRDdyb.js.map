{"version":3,"file":"Game3ViewLogic-D7PRDdyb.js","sources":["../src/features/Game3/model/Game3ViewSchema.ts","../src/features/Game3/view/Game3ViewLogic.ts"],"sourcesContent":["// src/features/Game3/model/Game3ViewSchema.ts\r\nimport { IBuffer, BufferMap } from \"../../../core/interfaces/IBuffer\";\r\n\r\nexport const Game3ViewMainSchema: IBuffer = {\r\n    HERO_X: 0,\r\n    HERO_Y: 1,\r\n    HERO_HP: 2,\r\n\r\n    // Visuals calculated by ViewLogic\r\n    HERO_ANIM_FRAME: 5,\r\n    HERO_FLIP: 6,\r\n    HERO_WIDTH: 7,\r\n    HERO_HEIGHT: 8,\r\n    HERO_ANIM_STATE: 9,\r\n\r\n    WORLD_SCALE: 10,\r\n    PLAYER_SCALE: 11,\r\n    PLAYER_OFFSET_Y: 12,\r\n\r\n    UI_BOUNCE: 20,\r\n    GLITCH_INTENSITY: 21,\r\n    VIGNETTE_PULSE: 22,\r\n\r\n    OBJ_COUNT: 30,\r\n\r\n    BUFFER_SIZE: 128\r\n};\r\n\r\nexport const Game3ViewPlatformsSchema: IBuffer = {\r\n    START_INDEX: 0,\r\n    STRIDE: 5,\r\n    BUFFER_SIZE: 5000\r\n};\r\n\r\nexport const Game3ViewSchema: BufferMap = {\r\n    main: Game3ViewMainSchema,\r\n    platforms: Game3ViewPlatformsSchema\r\n};","// src/features/Game3/logic/Game3ViewLogic.ts\r\nimport { Game3MainSchema, Game3PlatformsSchema } from '../model/Game3LogicSchema';\r\nimport { Game3ViewMainSchema, Game3ViewPlatformsSchema } from '../model/Game3ViewSchema';\r\nimport { BaseViewLogic } from '../../../core/templates/BaseViewLogic';\r\n\r\nexport class Game3ViewLogic extends BaseViewLogic {\r\n    private uiBounce: number = 0;\r\n    private glitchIntensity: number = 0;\r\n    private lastHp: number = -1;\r\n\r\n    // Animation internal state\r\n    private animFrame = 0;\r\n    private animTimer = 0;\r\n    private lastAnimState = 0;\r\n    private lastFlipX = false;\r\n\r\n    public update(dt: number, frameCount: number) {\r\n        const lMain = this.logicViews.get('main');\r\n        const lPlatforms = this.logicViews.get('platforms');\r\n        const vMain = this.outputViews.get('main');\r\n        const vPlatforms = this.outputViews.get('platforms');\r\n\r\n        if (!lMain || !lPlatforms || !vMain || !vPlatforms) return;\r\n\r\n        // 1. Handle Output Resizing Request (Mirroring Game1 behavior)\r\n        const objCount = lMain[Game3MainSchema.OBJ_COUNT];\r\n        const vCapacity = Math.floor(vPlatforms.length / Game3ViewPlatformsSchema.STRIDE);\r\n\r\n        if (objCount > vCapacity) {\r\n            if ((this as any)._outResizePending !== vCapacity) {\r\n                self.postMessage({\r\n                    type: 'REQUEST_RESIZE_OUTPUT',\r\n                    payload: {\r\n                        bufferName: 'platforms',\r\n                        newSize: (objCount + 1000) * Game3ViewPlatformsSchema.STRIDE\r\n                    }\r\n                });\r\n                (this as any)._outResizePending = vCapacity;\r\n            }\r\n        } else {\r\n            (this as any)._outResizePending = 0;\r\n        }\r\n\r\n        // 2. Read Basic State & Physics from Logic\r\n        const hp = lMain[Game3MainSchema.HERO_HP];\r\n        const vx = lMain[Game3MainSchema.HERO_VX];\r\n        const isOnGround = lMain[Game3MainSchema.IS_ON_GROUND] === 1;\r\n        const isWallSliding = lMain[Game3MainSchema.IS_WALL_SLIDING] === 1;\r\n\r\n        // 3. Determine Animation State & Orientation (Moved from Logic)\r\n        let flipX = this.lastFlipX;\r\n        if (vx > 0.01) flipX = false;\r\n        else if (vx < -0.01) flipX = true;\r\n        this.lastFlipX = flipX;\r\n\r\n        let animState = 0;\r\n        if (isWallSliding) animState = 3;\r\n        else if (!isOnGround) animState = 2;\r\n        else if (Math.abs(vx) > 0.01) animState = 1;\r\n        else animState = 0;\r\n\r\n        // Process Animation Timer\r\n        if (animState !== this.lastAnimState) {\r\n            this.animFrame = 0;\r\n            this.animTimer = 0;\r\n            this.lastAnimState = animState;\r\n        } else {\r\n            this.animTimer++;\r\n            if (this.animTimer >= 6) {\r\n                this.animFrame = (this.animFrame + 1) % 12;\r\n                this.animTimer = 0;\r\n            }\r\n        }\r\n\r\n        // 4. Visual Effects (UI Bounce, etc)\r\n        if (this.lastHp !== -1 && hp < this.lastHp) {\r\n            this.glitchIntensity = 1.0;\r\n        }\r\n        this.lastHp = hp;\r\n        this.glitchIntensity *= 0.92;\r\n\r\n        const timeFactor = dt / 16.67;\r\n        this.uiBounce += 0.05 * timeFactor;\r\n        const vignettePulse = 0.5 + Math.sin(frameCount * 0.05) * 0.2;\r\n\r\n        // 5. Write to View Buffer Main\r\n        vMain[Game3ViewMainSchema.HERO_X] = lMain[Game3MainSchema.HERO_X];\r\n        vMain[Game3ViewMainSchema.HERO_Y] = lMain[Game3MainSchema.HERO_Y];\r\n        vMain[Game3ViewMainSchema.HERO_HP] = hp;\r\n\r\n        vMain[Game3ViewMainSchema.HERO_ANIM_FRAME] = this.animFrame;\r\n        vMain[Game3ViewMainSchema.HERO_FLIP] = flipX ? 1 : 0;\r\n        vMain[Game3ViewMainSchema.HERO_ANIM_STATE] = animState;\r\n        vMain[Game3ViewMainSchema.HERO_WIDTH] = lMain[Game3MainSchema.HERO_WIDTH];\r\n        vMain[Game3ViewMainSchema.HERO_HEIGHT] = lMain[Game3MainSchema.HERO_HEIGHT];\r\n\r\n        vMain[Game3ViewMainSchema.WORLD_SCALE] = lMain[Game3MainSchema.WORLD_SCALE];\r\n        vMain[Game3ViewMainSchema.PLAYER_SCALE] = lMain[Game3MainSchema.PLAYER_SCALE];\r\n        vMain[Game3ViewMainSchema.PLAYER_OFFSET_Y] = lMain[Game3MainSchema.PLAYER_OFFSET_Y];\r\n\r\n        vMain[Game3ViewMainSchema.UI_BOUNCE] = Math.sin(this.uiBounce) * 5;\r\n        vMain[Game3ViewMainSchema.GLITCH_INTENSITY] = this.glitchIntensity;\r\n        vMain[Game3ViewMainSchema.VIGNETTE_PULSE] = vignettePulse;\r\n\r\n        // 6. Sync Objects (Pass-through from Logic Platforms SAB to View Platforms SAB)\r\n        const safeObjCount = Math.min(objCount, vCapacity);\r\n        vMain[Game3ViewMainSchema.OBJ_COUNT] = safeObjCount;\r\n\r\n        for (let i = 0; i < safeObjCount; i++) {\r\n            const lBase = i * Game3PlatformsSchema.STRIDE;\r\n            const vBase = i * Game3ViewPlatformsSchema.STRIDE;\r\n\r\n            // x, y, width, height, type\r\n            vPlatforms[vBase] = lPlatforms[lBase];\r\n            vPlatforms[vBase + 1] = lPlatforms[lBase + 1];\r\n            vPlatforms[vBase + 2] = lPlatforms[lBase + 2];\r\n            vPlatforms[vBase + 3] = lPlatforms[lBase + 3];\r\n            vPlatforms[vBase + 4] = lPlatforms[lBase + 4];\r\n        }\r\n    }\r\n\r\n    public override getSnapshot() {\r\n        return {\r\n            uiBounce: this.uiBounce,\r\n            glitchIntensity: this.glitchIntensity,\r\n            lastHp: this.lastHp,\r\n            animFrame: this.animFrame,\r\n            animTimer: this.animTimer,\r\n            lastAnimState: this.lastAnimState,\r\n            lastFlipX: this.lastFlipX\r\n        };\r\n    }\r\n\r\n    public override loadSnapshot(data: any) {\r\n        if (data) {\r\n            this.uiBounce = data.uiBounce ?? 0;\r\n            this.glitchIntensity = data.glitchIntensity ?? 0;\r\n            this.lastHp = data.lastHp ?? -1;\r\n            this.animFrame = data.animFrame ?? 0;\r\n            this.animTimer = data.animTimer ?? 0;\r\n            this.lastAnimState = data.lastAnimState ?? 0;\r\n            this.lastFlipX = data.lastFlipX ?? false;\r\n        }\r\n    }\r\n}"],"names":["Game3ViewMainSchema","Game3ViewPlatformsSchema","Game3ViewLogic","BaseViewLogic","dt","frameCount","lMain","lPlatforms","vMain","vPlatforms","objCount","Game3MainSchema","vCapacity","hp","vx","isOnGround","isWallSliding","flipX","animState","timeFactor","vignettePulse","safeObjCount","i","lBase","Game3PlatformsSchema","vBase","data"],"mappings":"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"}